"use strict";(self.webpackChunk_jupyterlite_xeus_extension=self.webpackChunk_jupyterlite_xeus_extension||[]).push([[6],{6:(e,s,t)=>{t.r(s),t.d(s,{EmpackedXeusRemoteKernel:()=>p,WebWorkerKernel:()=>d,XeusRemoteKernelBase:()=>_,XeusWorkerLoggerBase:()=>g});var i=t(11),a=t(648),n=t(602),r=t(262),o=t(367),l=t(32),h=t(776);class d{constructor(e){this._contentsProcessor=void 0,this._isDisposed=!1,this._disposed=new n.Signal(this),this._executeDelegate=new r.PromiseDelegate,this._inputDelegate=new r.PromiseDelegate,this._parentHeader=void 0,this._parent=void 0,this._ready=new r.PromiseDelegate;const{id:s,name:t,sendMessage:i,location:a,kernelSpec:o,contentsManager:l,empackEnvMetaLink:h}=e;this._id=s,this._name=t,this._location=a,this._kernelSpec=o,this._contentsManager=l,this._sendMessage=i,this._empackEnvMetaLink=h,this._worker=this.initWorker(e),this._remoteKernel=this.initRemote(e),this.initFileSystem(e)}initWorker(e){return crossOriginIsolated?new Worker(new URL(t.p+t.u(753),t.b),{type:void 0}):new Worker(new URL(t.p+t.u(78),t.b),{type:void 0})}initRemote(e){let s;return crossOriginIsolated?(this._worker.onmessage=this._processCoincidentWorkerMessage.bind(this),s=(0,i.A)(this._worker),s.processDriveRequest=async e=>{if(!h.DriveContentsProcessor)throw new Error("File system calls over Atomics.wait is only supported with jupyterlite>=0.4.0a3");return void 0===this._contentsProcessor&&(this._contentsProcessor=new h.DriveContentsProcessor({contentsManager:this._contentsManager})),await this._contentsProcessor.processDriveRequest(e)},s.processStdinRequest=async e=>(this._processCoincidentWorkerMessage({data:e}),this._inputDelegate=new r.PromiseDelegate,await this._inputDelegate.promise)):(this._worker.onmessage=e=>{this._processComlinkWorkerMessage(e.data)},s=(0,a.LV)(this._worker)),s.initialize({kernelId:this.id,kernelSpec:this._kernelSpec,baseUrl:o.PageConfig.getBaseUrl(),mountDrive:e.mountDrive,empackEnvMetaLink:this._empackEnvMetaLink,browsingContextId:e.browsingContextId}).then(this._ready.resolve.bind(this._ready)),s}async handleMessage(e){this._parent=e,this._parentHeader=e.header,await this._sendMessageToWorker(e)}async _sendMessageToWorker(e){if("input_reply"!==e.header.msg_type)return this._executeDelegate=new r.PromiseDelegate,await this._remoteKernel.processMessage({msg:e,parent:this.parent}),await this._executeDelegate.promise;this._inputDelegate.resolve(e)}get parentHeader(){return this._parentHeader}get parent(){return this._parent}get location(){return this._location}get sendMessage(){return this._sendMessage}_processCoincidentWorkerMessage(e){var s,t,i,a,n;(null===(s=e.data)||void 0===s?void 0:s.header)&&(e.data.header.session=null!==(i=null===(t=this._parentHeader)||void 0===t?void 0:t.session)&&void 0!==i?i:"",e.data.session=null!==(n=null===(a=this._parentHeader)||void 0===a?void 0:a.session)&&void 0!==n?n:"",this._sendMessage(e.data),"status"===e.data.header.msg_type&&"idle"===e.data.content.execution_state&&this._executeDelegate.resolve())}_assignSession(e){var s,t,i,a;return e.header.session=null!==(t=null===(s=this._parentHeader)||void 0===s?void 0:s.session)&&void 0!==t?t:"",e.session=null!==(a=null===(i=this._parentHeader)||void 0===i?void 0:i.session)&&void 0!==a?a:"",e}_processComlinkWorkerMessage(e){var s,t;if(e.header)this._sendMessage(this._assignSession(e));else{if(!(null==e?void 0:e._stream))return;{const i=this._parentHeader,{name:a,text:n}=e._stream;if("stderr"===a){const t=l.KernelMessage.createMessage({msgType:"execute_reply",channel:"shell",parentHeader:i,session:null!==(s=null==i?void 0:i.session)&&void 0!==s?s:"",content:{execution_count:e._stream.executionCount,status:"error",ename:e._stream.ename,evalue:e._stream.evalue,traceback:e._stream.traceback.join("")}});e=this._assignSession(t),this._sendMessage(e)}const r=l.KernelMessage.createMessage({channel:"iopub",msgType:"stream",session:null!==(t=null==i?void 0:i.session)&&void 0!==t?t:"",parentHeader:i,content:{name:a,text:n}});e=this._assignSession(r),this._sendMessage(e)}}"status"===e.header.msg_type&&"idle"===e.content.execution_state&&this._executeDelegate.resolve()}get ready(){return this._ready.promise}get isDisposed(){return this._isDisposed}get disposed(){return this._disposed}dispose(){this.isDisposed||(this._worker.terminate(),this._worker=null,this._remoteKernel=null,this._isDisposed=!0,this._disposed.emit(void 0))}get id(){return this._id}get name(){return this._name}async initFileSystem(e){let s,t;if(e.location.includes(":")){const i=e.location.split(":");s=i[0],t=i[1]}else s="",t=e.location;await this._remoteKernel.ready(),await this._remoteKernel.mount(s,"/drive",o.PageConfig.getBaseUrl(),e.browsingContextId),await this._remoteKernel.isDir("/files")?await this._remoteKernel.cd("/files"):await this._remoteKernel.cd(`/drive/${t}`)}}var c=t(170);class g{constructor(e){this.executionCount=0,this._id=e,this._channel=new BroadcastChannel("/xeus-kernel-logs-broadcast")}log(...e){postMessage({_stream:{name:"stdout",text:e.join(" ")+"\n"}}),this._channel.postMessage({kernelId:this._id,payload:{type:"text",level:"info",data:e.join(" ")}})}warn(...e){postMessage({_stream:{name:"stdout",text:e.join(" ")+"\n"}}),this._channel.postMessage({kernelId:this._id,payload:{type:"text",level:"warning",data:e.join(" ")}})}error(...e){postMessage({_stream:{name:"stderr",evalue:e.join(""),traceback:[],executionCount:this.executionCount,text:e.join("")}}),this._channel.postMessage({kernelId:this._id,payload:{type:"text",level:"critical",data:e.join(" ")}})}}class _{constructor(e={}){this._ready=new Promise((e=>{this.setKernelReady=e}))}async ready(){return await this._ready}async cd(e){e&&this.Module.FS&&this.Module.FS.chdir(e)}async isDir(e){try{const s=this.Module.FS.lookupPath(e);return this.Module.FS.isDir(s.node.mode)}catch(e){return!1}}async processMessage(e){const s=e.msg.header.msg_type;await globalThis.ready,null!==globalThis.toplevel_promise&&null!==globalThis.toplevel_promise_py_proxy&&(await globalThis.toplevel_promise,globalThis.toplevel_promise_py_proxy.delete(),globalThis.toplevel_promise_py_proxy=null,globalThis.toplevel_promise=null),"input_reply"===s||("execute_request"===s?(this._logger.executionCount+=1,e.msg.content.code=await this.processMagics(e.msg.content.code),this.xserver.notify_listener(e.msg)):this.xserver.notify_listener(e.msg))}get Module(){return globalThis.Module}set Module(e){globalThis.Module=e}get logger(){return this._logger}async initialize(e){const{baseUrl:s,browsingContextId:t,kernelSpec:i}=e;this._logger=this.initializeLogger(e),globalThis.toplevel_promise=null,globalThis.toplevel_promise_py_proxy=null,this.Module=await this.initializeModule(e),this.Module=await createXeusModule(this.Module);try{await(0,c.cn)(this.Module),await this.initializeFileSystem(e),await this.initializeInterpreter(e),this.initializeStdin(s,t);try{this.xkernel=new this.Module.xkernel(i.argv)}catch(e){this.xkernel=new this.Module.xkernel}this.xserver=this.xkernel.get_server(),this.xserver||this._logger.error("Failed to start kernel!"),this.xkernel.start()}catch(e){if("number"==typeof e){const s=this.Module.get_exception_message(e);throw this._logger.error(s),new Error(s)}throw this._logger.error(e),e}this._logger.log("Kernel successfuly started!"),this.setKernelReady()}initializeLogger(e){return new g(e.kernelId)}async processMagics(e){const{commands:s,run:t}=(0,c.qg)(e);for(const e of s)switch(e.type){case"install":if(e.data){const{channels:s,specs:t,pipSpecs:i}=e.data;await this.install(s,t,i)}break;case"list":await this.listInstalledPackages()}return t}}class p extends _{constructor(){super(...arguments),this._prefix="",this._pkgRootUrl="",this._installedPackages={},this._paths={}}async initializeModule(e){const{baseUrl:s,kernelSpec:t}=e,i=o.URLExt.join(s,t.argv[0]),a=i.replace(".js",".wasm"),n=i.replace(".js",".data"),r=o.URLExt.join(s,"xeus",t.envName),l=t.metadata&&t.metadata.shared?t.metadata.shared:{};return importScripts(i),{locateFile:e=>e in l?o.URLExt.join(r,t.name,e):e.endsWith(".wasm")?a:e.endsWith(".data")?n:e}}async initializeFileSystem(e){const{baseUrl:s,kernelSpec:t,empackEnvMetaLink:i}=e;if(void 0===this.Module.FS||void 0===this.Module.loadDynamicLibrary)throw new Error("Cannot load kernel without a valid FS");const a=o.URLExt.join(s,"xeus","kernels",t.dir),n=`${i||a}/empack_env_meta.json`;this._pkgRootUrl=o.URLExt.join(s,`xeus/${t.envName}/kernel_packages`);const r=await async function(e){const s=await fetch(e);if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return await s.json()}(n);this._installedPackages={},r.packages.map((e=>{this._installedPackages[e.filename]={name:e.name,version:e.version,repo_url:e.channel?e.channel:"",url:e.url?e.url:"",repo_name:e.channel?e.channel:"",build_string:e.build}})),this._pythonVersion=(0,c.Zv)(r.packages),this._prefix=r.prefix;const l=await(0,c.h3)({empackEnvMeta:r,pkgRootUrl:this._pkgRootUrl,Module:this.Module,logger:this.logger,pythonVersion:this._pythonVersion});this._paths=l.paths,this._untarjs=l.untarjs,this._sharedLibs=l.sharedLibs}async initializeInterpreter(e){if("xpython"===e.kernelSpec.name){if(!this._pythonVersion)throw new Error("Python is not installed, cannot start Python!");this.logger.log("Starting Python"),await(0,c.NZ)({prefix:this._prefix,pythonVersion:this._pythonVersion,Module:this.Module})}await(0,c.YX)({sharedLibs:this._sharedLibs,prefix:this._prefix,Module:this.Module,logger:this.logger})}async install(e,s,t){var i,a;if(s.length||t.length)try{this.logger.log(`Collecting ${null===(i=s||t)||void 0===i?void 0:i.join(",")}`);const a=await(0,c.kH)({ymlOrSpecs:s,installedPackages:this._installedPackages,pipSpecs:t,channels:e,logger:this.logger});await this._reloadPackagesInFS({...a.condaPackages,...a.pipPackages})}catch(e){null===(a=this.logger)||void 0===a||a.error(e.stack)}}listInstalledPackages(){return(0,c.xY)(this._installedPackages,this.logger),Promise.resolve()}async _reloadPackagesInFS(e){const s={},t={},i={};for(const s of Object.values(e))i[s.name]=s;const a={};for(const e of Object.values(this._installedPackages))a[e.name]=e;for(const e of Object.keys(this._installedPackages)){const t=this._installedPackages[e];t.name in i&&t.build_string===i[t.name].build_string||(s[e]=t)}for(const s of Object.keys(e)){const i=e[s];i.name in a&&i.build_string===a[i.name].build_string||(t[s]=i)}await(0,c.Dt)({removedPackages:s,Module:this.Module,paths:this._paths,logger:this.logger});const{sharedLibs:n,paths:r}=await(0,c.Rs)({packages:t,pkgRootUrl:this._pkgRootUrl,pythonVersion:this._pythonVersion,Module:this.Module,untarjs:this._untarjs,logger:this.logger});this._paths={...this._paths,...r},await(0,c.YX)({sharedLibs:n,prefix:this._prefix,Module:this.Module,logger:this.logger}),this._installedPackages=e}}}}]);