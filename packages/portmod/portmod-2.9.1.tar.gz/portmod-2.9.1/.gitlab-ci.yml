include:
  - template: Dependency-Scanning.gitlab-ci.yml

default:
  image: registry.gitlab.com/portmod/portmod/rust:latest
  before_script:
    - python -V  # Print out python version for debugging
    - rustc -V
    - pip install --upgrade -r requirements.txt --cache-dir .cache/pip
    - pip install --upgrade setuptools_scm --cache-dir .cache/pip
  cache:
    key: $CI_JOB_NAME
    paths:
      - .cache
      - .venv
      - target
      - $HOME/.cargo
      - $HOME/.rustup
      - $HOME/.pyenv

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYLINTRC: ".pylintrc"
  PIP_BREAK_SYSTEM_PACKAGES: "1"
  SETUPTOOLS_RUST_CARGO_PROFILE: release
  HOMEBREW_NO_AUTO_UPDATE: "1"

stages:
  - build
  - test
  - deploy

inquisitor:
  stage: test
  needs: ["build-linux"]
  script:
  - ./bin/portmod sync openmw
  - python ${CI_PROJECT_DIR}/bin/inquisitor scan ~/.local/share/portmod/repos/openmw
  cache:
    key: $CI_JOB_NAME
    paths:
      - .cache
      - ~/.cache/portmod
      - ~/.local/share/portmod/repos

build-linux:
  stage: build
  script:
  - mkdir -p .cache/tmp
  - pip install -e .[test] --cache-dir .cache/pip
  artifacts:
    paths:
      - portmodlib/portmod.cpython-*.so

.windows:
  tags:
    - saas-windows-medium-amd64
  before_script:
  - choco install -y rust mingw python38
  - choco install -y sandboxie --version=5.68.7
  - Import-Module $env:ChocolateyInstall\helpers\chocolateyProfile.psm1
  - refreshenv
  artifacts:
    paths:
      - portmodlib/portmod.cpython-*.so

windows-build-test:
  extends: .windows
  stage: build
  script:
  - cmd.exe /C 'setx /M PATH "%PATH%;C:\Program Files\Sandboxie"'
  - refreshenv
  - python -m pip install -e .[test] --cache-dir .cache/pip
  - python -m pip install --upgrade -r requirements.txt --cache-dir .cache/pip
  - python -m pytest -s

.macos:
  # TODO: Disable except on projects within the portmod group
  stage: build
  tags:
    - saas-macos-medium-m1
  image: macos-14-xcode-15
  rules:
    # Can currently only run on gitlab ultimate/premium
    - if: $CI_PROJECT_NAMESPACE == "portmod"
  variables:
    ARCHFLAGS: "-arch x86_64 -arch arm64"
  before_script:
    - rustup target add x86_64-apple-darwin
    - brew untap homebrew/core
    - brew untap homebrew/cask
    - brew install pyenv
    - env PYTHON_CONFIGURE_OPTS="--enable-framework" pyenv install 3.12.2
    - pyenv global 3.12

macos-build-test:
  extends: .macos
  stage: build
  script:
    - pyenv exec pip install -e .[test,gui] --cache-dir .cache/pip
    - pyenv exec pip install --upgrade -r requirements.txt --cache-dir .cache/pip
    - PYTHONWARNINGS=error pyenv exec pytest

lint:
  stage: test
  needs: ["build-linux"]
  script:
  - pip install --upgrade flake8 pylint setuptools_rust bandit mypy black isort --cache-dir .cache/pip
  - shopt -s globstar
  - flake8 --exclude .venv,--max-line-length=88 --filename '*.py,*.pybuild'
  - pylint -E portmod/**/*.py pybuild/**/*.py portmodlib/**/*.py
  # Enable selected pylint warnings
  - pylint portmod/**/*.py pybuild/**/*.py portmodlib/**/*.py --disable=all --enable=undefined-loop-variable
  - bandit -c .bandit.yaml **/*.py

lint-nodeps:
  stage: test
  needs: []
  script:
    - shopt -s globstar
    - pip install --upgrade mypy black isort --cache-dir .cache/pip
    - cargo clippy -- -D warnings
    - cargo audit
    - mkdir -p .cache/mypy
    - mypy --install-types --non-interactive --incremental --cache-dir .cache/mypy `ls -1 portmod/**/*.py pybuild/**/*.py portmodlib/**/*.py | grep -v portmod/_gui`
    - black --diff --check **/*.{py,pybuild}
    - cargo fmt -- --check -l
    - isort --diff --check portmod pybuild portmodlib bin

pytest-linux:
  stage: test
  needs: ["build-linux"]
  script:
    # pytest-cov has special handling for subprocesses, which amazingly also works with sandboxing
    - pip install deprecated pytest pytest-cov setuptools_scm --upgrade --cache-dir .cache/pip
    - pip install --upgrade -r requirements.txt
    - PYTHONWARNINGS=error pytest --cov
    - coverage xml
  coverage: '/TOTAL.*\s([.\d]+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

pytest-linux-no-network:
  stage: test
  needs: ["build-linux"]
  script:
    - pip install deprecated pytest setuptools_scm --upgrade --cache-dir .cache/pip
    - pip install --upgrade -r requirements.txt
    - PYTHONWARNINGS=error bwrap --unshare-net --bind / / --dev /dev pytest

deploy-windows:
  extends:
    - .windows
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - python -m pip install --upgrade twine setuptools_rust
    - python setup.py bdist_wheel --py-limited-api=cp38
    - twine upload dist/*.whl

deploy-macos:
  extends:
    - .macos
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - pyenv exec pip install --upgrade twine setuptools_rust sphinx sphinx-argparse
    - pyenv exec python setup.py build_rust --inplace --release build_man
    - pyenv exec python setup.py bdist_wheel --py-limited-api=cp38
    - pyenv exec twine upload dist/*.whl

deploy-linux:
  image: quay.io/pypa/manylinux2014_x86_64:latest
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG
  before_script: []
  script: |
    curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain stable -y
    export PATH="/opt/python/cp38-cp38/bin:$HOME/.cargo/bin:$PATH"
    pip install -U twine "setuptools!=50.0" setuptools_rust wheel --cache-dir .cache/pip
    pip install .[man] --cache-dir .cache/pip
    python setup.py build_rust --inplace --release build_man
    # Remove in-place library so it doesn't get included in the wheel
    rm portmodlib/*.so
    rm build -r
    python setup.py bdist_wheel --py-limited-api=cp38
    python setup.py check sdist
    for whl in dist/*.whl; do
        auditwheel repair "$whl" -w dist/
        rm $whl
    done
    python -m twine upload dist/*
  cache:
    key: build
    paths:
      - target
      - .cache

gemnasium-python-dependency_scanning:
  inherit:
    default: false
  stage: test

html-doc:
  stage: test
  needs:
    - build-linux
  script:
    - pip install --upgrade 'sphinx<7' sphinx-argparse autodocsumm sphinx-autodoc-typehints sphinxcontrib-apidoc deprecated sphinx_rtd_theme
    - make -C doc clean
    - make -C doc html
    - ./mkdoc.sh
  cache:
    key: build
    paths:
      - target
      - .cache

manpages:
  stage: test
  needs:
    - build-linux
  script:
    - pip install --upgrade 'sphinx<7' sphinx-argparse autodocsumm sphinx-autodoc-typehints sphinxcontrib-apidoc deprecated setuptools_rust
    # Test both ways of building the man pages
    - python setup.py build_man
    - make -C doc man
  cache:
    key: build
    paths:
      - target
      - .cache

pages:
  stage: deploy
  extends: html-doc
  after_script:
    - mv doc/_build/html/ public/
    - mv apidoc/_build/ public/api
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

# Not currently working due to https://gitlab.archlinux.org/archlinux/archlinux-docker/-/issues/56
docker:
  image: docker:19.03.12
  stage: build
  services:
    - docker:19.03.12-dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  inherit:
    default: false
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
  when: manual

workflow:
    rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG
