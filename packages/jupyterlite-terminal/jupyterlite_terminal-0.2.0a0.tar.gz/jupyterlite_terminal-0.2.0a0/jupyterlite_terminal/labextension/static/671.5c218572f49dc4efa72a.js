/*! For license information please see 671.5c218572f49dc4efa72a.js.LICENSE.txt */
(()=>{"use strict";var t={d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{AliasCommand:()=>Tt,BuiltinCommand:()=>kt,CdCommand:()=>Pt,ClearCommand:()=>Lt,CockleConfigCommand:()=>Ft,ExitCommand:()=>Dt,ExportCommand:()=>Bt,HistoryCommand:()=>Ht});const s=Symbol("Comlink.proxy"),n=Symbol("Comlink.endpoint"),i=Symbol("Comlink.releaseProxy"),r=Symbol("Comlink.finalizer"),o=Symbol("Comlink.thrown"),a=t=>"object"==typeof t&&null!==t||"function"==typeof t,l={canHandle:t=>a(t)&&t[s],serialize(t){const{port1:e,port2:s}=new MessageChannel;return c(t,e),[s,[s]]},deserialize:t=>(t.start(),function(t){const e=new Map;return t.addEventListener("message",(function(t){const{data:s}=t;if(!s||!s.id)return;const n=e.get(s.id);if(n)try{n(s)}finally{e.delete(s.id)}})),_(t,e,[],void 0)}(t))},h=new Map([["proxy",l],["throw",{canHandle:t=>a(t)&&o in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function c(t,e=globalThis,n=["*"]){e.addEventListener("message",(function i(a){if(!a||!a.data)return;if(!function(t,e){for(const s of t){if(e===s||"*"===s)return!0;if(s instanceof RegExp&&s.test(e))return!0}return!1}(n,a.origin))return void console.warn(`Invalid origin '${a.origin}' for comlink proxy`);const{id:l,type:h,path:d}=Object.assign({path:[]},a.data),m=(a.data.argumentList||[]).map(C);let f;try{const e=d.slice(0,-1).reduce(((t,e)=>t[e]),t),n=d.reduce(((t,e)=>t[e]),t);switch(h){case"GET":f=n;break;case"SET":e[d.slice(-1)[0]]=C(a.data.value),f=!0;break;case"APPLY":f=n.apply(e,m);break;case"CONSTRUCT":f=function(t){return Object.assign(t,{[s]:!0})}(new n(...m));break;case"ENDPOINT":{const{port1:e,port2:s}=new MessageChannel;c(t,s),f=function(t,e){return w.set(t,e),t}(e,[e])}break;case"RELEASE":f=void 0;break;default:return}}catch(t){f={value:t,[o]:0}}Promise.resolve(f).catch((t=>({value:t,[o]:0}))).then((s=>{const[n,o]=y(s);e.postMessage(Object.assign(Object.assign({},n),{id:l}),o),"RELEASE"===h&&(e.removeEventListener("message",i),u(e),r in t&&"function"==typeof t[r]&&t[r]())})).catch((t=>{const[s,n]=y({value:new TypeError("Unserializable return value"),[o]:0});e.postMessage(Object.assign(Object.assign({},s),{id:l}),n)}))})),e.start&&e.start()}function u(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function d(t){if(t)throw new Error("Proxy has been released and is not useable")}function m(t){return S(t,new Map,{type:"RELEASE"}).then((()=>{u(t)}))}const f=new WeakMap,p="FinalizationRegistry"in globalThis&&new FinalizationRegistry((t=>{const e=(f.get(t)||0)-1;f.set(t,e),0===e&&m(t)}));function _(t,e,s=[],r=function(){}){let o=!1;const a=new Proxy(r,{get(n,r){if(d(o),r===i)return()=>{!function(t){p&&p.unregister(t)}(a),m(t),e.clear(),o=!0};if("then"===r){if(0===s.length)return{then:()=>a};const n=S(t,e,{type:"GET",path:s.map((t=>t.toString()))}).then(C);return n.then.bind(n)}return _(t,e,[...s,r])},set(n,i,r){d(o);const[a,l]=y(r);return S(t,e,{type:"SET",path:[...s,i].map((t=>t.toString())),value:a},l).then(C)},apply(i,r,a){d(o);const l=s[s.length-1];if(l===n)return S(t,e,{type:"ENDPOINT"}).then(C);if("bind"===l)return _(t,e,s.slice(0,-1));const[h,c]=g(a);return S(t,e,{type:"APPLY",path:s.map((t=>t.toString())),argumentList:h},c).then(C)},construct(n,i){d(o);const[r,a]=g(i);return S(t,e,{type:"CONSTRUCT",path:s.map((t=>t.toString())),argumentList:r},a).then(C)}});return function(t,e){const s=(f.get(e)||0)+1;f.set(e,s),p&&p.register(t,e,t)}(a,t),a}function g(t){const e=t.map(y);return[e.map((t=>t[0])),(s=e.map((t=>t[1])),Array.prototype.concat.apply([],s))];var s}const w=new WeakMap;function y(t){for(const[e,s]of h)if(s.canHandle(t)){const[n,i]=s.serialize(t);return[{type:"HANDLER",name:e,value:n},i]}return[{type:"RAW",value:t},w.get(t)||[]]}function C(t){switch(t.type){case"HANDLER":return h.get(t.name).deserialize(t.value);case"RAW":return t.value}}function S(t,e,s,n){return new Promise((i=>{const r=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.set(r,i),t.start&&t.start(),t.postMessage(Object.assign({id:r},s),n)}))}var E,b,k,O,I;!function(t){t.MAIN=0,t.WORKER=1,t.LENGTH=2,t.START=3,t.maxChars=64}(E||(E={})),function(t){t[t.ISTRIP=32]="ISTRIP",t[t.INLCR=64]="INLCR",t[t.IGNCR=128]="IGNCR",t[t.ICRNL=256]="ICRNL",t[t.IUCLC=512]="IUCLC",t[t.IXON=1024]="IXON",t[t.IXANY=2048]="IXANY",t[t.IMAXBEL=8192]="IMAXBEL",t[t.IUTF8=16384]="IUTF8"}(b||(b={})),function(t){t[t.OPOST=1]="OPOST",t[t.OLCUC=2]="OLCUC",t[t.ONLCR=4]="ONLCR",t[t.OCRNL=8]="OCRNL",t[t.ONOCR=16]="ONOCR",t[t.ONLRET=32]="ONLRET",t[t.TABDLY=6144]="TABDLY"}(k||(k={})),function(t){t[t.ISIG=1]="ISIG",t[t.ICANON=2]="ICANON",t[t.ECHO=8]="ECHO",t[t.ECHOE=16]="ECHOE",t[t.ECHOK=32]="ECHOK",t[t.ECHONL=64]="ECHONL",t[t.NOFLSH=128]="NOFLSH",t[t.ECHOCTL=512]="ECHOCTL",t[t.ECHOPRT=1024]="ECHOPRT",t[t.ECHOKE=2048]="ECHOKE",t[t.IEXTEN=32768]="IEXTEN"}(O||(O={})),function(t){t[t.VINTR=0]="VINTR",t[t.VQUIT=1]="VQUIT",t[t.VERASE=2]="VERASE",t[t.VKILL=3]="VKILL",t[t.VEOF=4]="VEOF",t[t.VTIME=5]="VTIME",t[t.VMIN=6]="VMIN",t[t.VSWTCH=7]="VSWTCH",t[t.VSTART=8]="VSTART",t[t.VSTOP=9]="VSTOP",t[t.VSUSP=10]="VSUSP",t[t.VEOL=11]="VEOL",t[t.VREPRINT=12]="VREPRINT",t[t.VDISCARD=13]="VDISCARD",t[t.VWERASE=14]="VWERASE",t[t.VLNEXT=15]="VLNEXT",t[t.VEOL2=16]="VEOL2"}(I||(I={}));class N{clone(){return{c_iflag:this.c_iflag,c_oflag:this.c_oflag,c_cflag:this.c_cflag,c_lflag:this.c_lflag,c_cc:[...this.c_cc]}}log(t){const e=(t,e,s)=>{const n=[];for(const[e,i]of Object.entries(t).filter((([t,e])=>t[0].match(/\D/))))(s&i)>0&&n.push(e);return`  ${e} = ${s} 0x${s.toString(16)} = ${n.join(" ")}`},s=["Cockle "+t+":"];s.push(e(b,"c_iflag",this.c_iflag)),s.push(e(k,"c_oflag",this.c_oflag)),s.push(`  c_cflag = ${this.c_cflag} 0x${this.c_cflag.toString(16)}`),s.push(e(O,"c_lflag",this.c_lflag)),s.push(`  c_cc = ${this.c_cc}`),console.log(s.join("\n"))}static newDefaultWasm(){const t=new N;return t.setDefaultWasm(),t}set(t){this.c_iflag=t.c_iflag,this.c_oflag=t.c_oflag,this.c_cflag=t.c_cflag,this.c_lflag=t.c_lflag,this.c_cc=[...t.c_cc],this.log("Termios set")}setDefaultWasm(){this.c_iflag=b.IUTF8|b.IMAXBEL|b.IXON|b.ICRNL,this.c_oflag=k.OPOST|k.ONLCR,this.c_cflag=191,this.c_lflag=O.IEXTEN|O.ECHOKE|O.ECHOCTL|O.ECHOK|O.ECHOE|O.ECHO|O.ICANON|O.ISIG,this.c_cc=[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.log("Termios setDefaultWasm")}c_iflag=0;c_oflag=0;c_cflag=0;c_lflag=0;c_cc=[]}class v{outputCallback;constructor(t){this.outputCallback=t}allowAdjacentNewline(t){this._allowAdjacentNewline=t}async disable(){this._enabled=!1,this._clear()}async enable(){this._enabled=!0}setTermios(t){this.termios.set(t),this._writeColumn=0}get termios(){return this._termios}utf8ArrayToString(t){return void 0===this._utf8Decoder&&(this._utf8Decoder=new TextDecoder("utf8")),this._utf8Decoder.decode(t)}write(t){let e=[];e="string"==typeof t?this._processWriteChars(t.split("").map((t=>t.charCodeAt(0)))):this._processWriteChars(t),this.outputCallback(String.fromCharCode(...e))}_maybeEchoToOutput(t){const e=(this.termios.c_lflag&O.ECHO)>0,s=(this.termios.c_lflag&O.ECHONL)>0;if(!e&&!s)return;const n=[];for(const s of t)switch(s){case 10:n.push(10);break;case 4:break;default:e&&n.push(s)}n.length>0&&this.write(n)}_processReadChars(t){const e=[];for(const s of t)switch(s){case 13:this.termios.c_iflag&b.IGNCR||((this.termios.c_iflag&b.ICRNL)>0?e.push(10):e.push(13));break;case 10:(this.termios.c_iflag&b.INLCR)>0?e.push(13):e.push(10);break;default:e.push(s)}return e}_processWriteChars(t){let e=!1,s=0;const n=[];for(let i=0;i<t.length;i++){const r=t[i];switch(e||27!==r||(e=!0,s=i),r){case 10:if(0===this._writeColumn&&!this._allowAdjacentNewline)break;this._writeColumn=0,(this.termios.c_oflag&k.ONLCR)>0?n.push(13,10):n.push(10);break;default:!e&&r>=32&&this._writeColumn++,n.push(r)}e&&i>s+2&&(r>=65&&r<=90||r>=97&&r<=122)&&(e=!1)}return n}_readFromBuffer(t){if(null===t){const t=this._readBuffer;return this._readBuffer=[],t}{const e=this._readBuffer.slice(0,t);return this._readBuffer.splice(0,e.length),e}}_allowAdjacentNewline=!1;_enabled=!1;_termios=N.newDefaultWasm();_writeColumn=0;_utf8Decoder;_readBuffer=[]}class x extends v{constructor(t,e){super(e);const s=E.maxChars+3;this._sharedArrayBuffer=t,this._intArray=new Int32Array(this._sharedArrayBuffer,0,s)}poll(t){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.poll when disabled");return this._readBuffer.length>0?5:(t<0&&(t=1/0),4|("not-equal"===Atomics.wait(this._intArray,E.MAIN,this._readCount,t)?1:0))}read(t){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.read when disabled");return null!==t&&t<=0?[]:this._readBuffer.length>0?this._readFromBuffer(t):(Atomics.wait(this._intArray,E.MAIN,this._readCount),this._postRead(t))}async readAsync(t){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.readAsync when disabled");if(null!==t&&t<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(t);const{async:e,value:s}=Atomics.waitAsync(this._intArray,E.MAIN,this._readCount);return e&&await s,this._postRead(t)}_postRead(t){if(Atomics.load(this._intArray,E.MAIN)===this._readCount)return[];const e=this._loadFromSharedArrayBuffer();return this._readCount++,Atomics.store(this._intArray,E.WORKER,this._readCount),Atomics.notify(this._intArray,E.WORKER,1),this._readBuffer=this._processReadChars(e),this._maybeEchoToOutput(this._readBuffer),this._readFromBuffer(t)}_clear(){this._intArray[E.MAIN]=0,this._intArray[E.WORKER]=0,this._readCount=0}_loadFromSharedArrayBuffer(){const t=Atomics.load(this._intArray,E.LENGTH),e=[];for(let s=0;s<t;s++)e.push(Atomics.load(this._intArray,E.START+s));return e}_sharedArrayBuffer;_intArray;_readCount=0}class A extends Map{constructor(){super()}getRecursive(t){let e=this.get(t);for(;void 0!==e;){const s=e.split(" ")[0];if(s===t)break;const n=this.get(s);if(void 0===n)return e;e=n+e.slice(s.length),t=s}return e}match(t){return[...this.keys()].filter((e=>e.startsWith(t)))}}const T="[",R=(t=1)=>t>0?T+t+"C":"",P=(t=1)=>t>0?T+t+"D":"",L="[H",M="[2J",F="[3J",D="[K",W="[1K",B="[1;0m",j="[1;31m",H="[1;32m",$="[0;94m",U="[0;95m",z="[0;32m",V="[0;33m";class Q extends Map{constructor(t){super(),t?(this.set("PS1",H+"js-shell:"+B+" "),this.set("TERM","xterm-256color"),this.set("TERMINFO","/usr/local/share/terminfo")):this.set("PS1","js-shell: ")}copyFromCommand(t){for(const e of t){const t=e.split("="),s=t.shift();s&&!this._ignore.has(s)&&this.set(s,t.join("="))}}copyIntoCommand(t,e){for(const[s,n]of this.entries())(e||"TERM"!==s)&&(t[s]=n)}getNumber(t){const e=this.get(t);if(null===e)return null;const s=Number(e);return isNaN(s)?null:s}getPrompt(){return this.get("PS1")??"$ "}_ignore=new Set(["USER","LOGNAME","HOME","LANG","_"])}class X extends Error{exitCode;constructor(t,e){super(e),this.exitCode=t}}class q extends X{constructor(t){super(127,`'${t}': command not found`)}}class Y extends X{constructor(t){super(127,`'${t}': cannot load command`)}}class K extends X{constructor(t){super(1,t)}}class G extends X{constructor(t){super(126,`'${t}': cannot run command`)}}class J{add(t){this._current=null,!t.trim()||this._ignoreInitialWhitespace&&t.startsWith(" ")||this._ignoreDuplicates&&t===this.at(-1)||(this._history.length>=this._maxSize&&this._history.shift(),this._history.push(t))}at(t){return this._history.at(t)??null}clear(){this._current=null,this._history=[]}scrollCurrent(t){return this._current=t?null===this._current?null:this._current+1:null===this._current?this._history.length-1:this._current-1,null!==this._current&&(this._current<0?this._current=0:this._current>=this._history.length&&(this._current=null)),null===this._current?null:this.at(this._current)}setMaxSize(t){this._maxSize=Math.max(t,0),this._history.length>this._maxSize&&(this._current=null,this._history=this._history.slice(this._maxSize))}write(t){for(let e=0;e<this._history.length;e++){const s=String(e).padStart(5," ");t.write(`${s}  ${this._history[e]}\n`)}}_history=[];_current=null;_ignoreInitialWhitespace=!0;_ignoreDuplicates=!0;_maxSize=1e3}class Z{stdinCallback;stdinAsyncCallback;constructor(t,e){this.stdinCallback=t,this.stdinAsyncCallback=e}isTerminal(){return!0}async readAsync(t){return await this.stdinAsyncCallback(t)}read(t){return this.stdinCallback(t)}}class tt{outputCallback;prefix;suffix;constructor(t,e=null,s=null){this.outputCallback=t,this.prefix=e,this.suffix=s}flush(){}supportsAnsiEscapes(){return!0}write(t){t.length<1||(null!==this.prefix&&(t=this.prefix+t),null!==this.suffix&&(t+=this.suffix),this.outputCallback(t))}}class et{get allContent(){return this.data.join("")}clear(){this.data=[]}supportsAnsiEscapes(){return!1}write(t){this.data.push(t)}data=[]}class st{isTerminal(){return!1}async readAsync(t){return this.read(t)}read(t){if(void 0===this._buffer&&(this._buffer=this.readAll(),this._index=0),this._index<this._buffer.length){const t=this._buffer[this._index++],e=[];for(let s=0;s<t.length;s++)e.push(t.charCodeAt(s));return e}return[]}_buffer;_index=0}class nt extends st{pipe;constructor(t){super(),this.pipe=t}readAll(){const t=this.pipe.allContent;return this.pipe.clear(),t}}class it extends et{flush(){}get input(){return new nt(this)}}class rt extends et{fileSystem;path;append;constructor(t,e,s){super(),this.fileSystem=t,this.path=e,this.append=s}flush(){const{FS:t}=this.fileSystem;let e=this.allContent;if(this.append)try{e=t.readFile(this.path,{encoding:"utf8"})+e}catch(t){}t.writeFile(this.path,e,{mode:436}),this.clear()}}class ot extends st{fileSystem;path;constructor(t,e){super(),this.fileSystem=t,this.path=e}readAll(){const{FS:t}=this.fileSystem;return t.readFile(this.path,{encoding:"utf8"})}}var at;!function(t){t[t.None=0]="None",t[t.Delimiter=1]="Delimiter",t[t.DoubleQuote=2]="DoubleQuote",t[t.SingleQuote=3]="SingleQuote",t[t.Whitespace=4]="Whitespace",t[t.Other=5]="Other"}(at||(at={}));class lt{throwErrors;aliases;constructor(t,e,s){this.throwErrors=e,this.aliases=s,this._source=t,this._tokens=[]}run(){for(;this._index<=this._source.length;)this._next();if(this.throwErrors&&""!==this._endQuote)throw new K("Tokenize error, expected end quote "+this._endQuote)}get tokens(){return this._tokens}_addToken(){const t=this._offset,e=this._value;if(void 0!==this.aliases&&t!==this._aliasOffset&&(0===this._tokens.length||";&|".includes(this._tokens.at(-1).value.at(-1)))){const s=this.aliases.getRecursive(e);if(void 0!==s){const n=e.length;return this._offset=-1,this._index=t-1,this._aliasOffset=t,this._source=this._source.slice(0,t)+s+this._source.slice(t+n),this._prevChar="",this._prevCharType=at.None,this._value="",this._endQuote="",!1}}return this._tokens.push({offset:t,value:e}),this._endQuote="",!0}_getCharType(t){return" ".includes(t)?at.Whitespace:";&|><".includes(t)?at.Delimiter:"'"===t?at.SingleQuote:'"'===t?at.DoubleQuote:at.Other}_endQuoteFromCharType(t){return t===at.DoubleQuote?'"':t===at.SingleQuote?"'":""}_next(){const t=++this._index,e=t<this._source.length?this._source[t]:" ";let s=this._getCharType(e);const n=this._endQuoteFromCharType(s);this._offset>=0?this._endQuote?e!==this._endQuote?this._value+=e:(this._endQuote="",s=at.Other):n?this._endQuote=n:s===at.Whitespace?this._addToken()&&(this._offset=-1):s!==this._prevCharType||s===at.Delimiter&&e!==this._prevChar?this._addToken()&&(this._offset=t,this._value=e):this._value+=e:s!==at.Whitespace&&(this._offset=t,this._endQuote=this._endQuoteFromCharType(s),this._value=""===this._endQuote?e:""),this._prevChar=e,this._prevCharType=s}_source;_tokens;_prevChar="";_prevCharType=at.None;_index=-1;_offset=-1;_aliasOffset=-1;_value="";_endQuote=""}class ht{}class ct extends ht{name;suffix;redirects;constructor(t,e,s){super(),this.name=t,this.suffix=e,this.redirects=s}lastToken(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1].lastToken():this.suffix.length>0?[this.suffix[this.suffix.length-1],!1]:[this.name,!0]}}class ut extends ht{commands;constructor(t){super(),this.commands=t}lastToken(){return this.commands.length>0?this.commands[this.commands.length-1].lastToken():[null,!1]}}class dt extends ht{token;target;constructor(t,e){super(),this.token=t,this.target=e}lastToken(){return[this.target,!1]}}function mt(t,e=!0,s){const n=function(t,e=!0,s){const n=new lt(t,e,s);return n.run(),n.tokens}(t,e,s),i=[],r=[];let o=-1;const a=n.length;function l(){1===r.length?i.push(r[0]):r.length>1&&i.push(new ut([...r])),r.length=0}for(let t=0;t<a;t++){const e=n[t];o>=0?";&".includes(e.value)?(r.push(ft(n.slice(o,t))),l(),o=-1):"|"===e.value&&(r.push(ft(n.slice(o,t))),o=-1):";&".includes(e.value)||(o=t)}return o>=0&&r.push(ft(n.slice(o,a))),l(),i}function ft(t){let e=t.slice(1);const s=e.findIndex((t=>{return(e=t.value).startsWith(">")||e.startsWith("<");var e}));if(s>=0){if(e.length!==s+2)throw new K("Redirect should be followed by file to redirect to");const n=new dt(e[s],e[s+1]);return e=e.slice(0,s),new ct(t[0],e,[n])}return new ct(t[0],e)}function*pt(t,e,s=!1,n=null){const i=t.length,r=t[0].length,o=t.map((t=>t.map((t=>t.length)))),a=Array(r).fill(0);for(let t=0;t<i;t++)for(let e=0;e<r;e++)a[e]=Math.max(a[e],o[t][e]);function l(t){let e="╭├╰"[t];for(let s=0;s<r;s++)e+="─".repeat(a[s]+2),e+=s<r-1?"┬┼┴"[t]:"╮┤╯"[t];return e}s||(yield l(0));for(let o=0;o<i;o++){const h=t[o];let c=s?"":"│ ";for(let t=0;t<r;t++){const e=n?.get(t)||null;c+=e?e+h[t]+B:h[t],c+=" ".repeat(a[t]-h[t].length),c+=s?"  ":" │ "}if(yield c,o===e-1)if(s){let t="";for(let e=0;e<r;e++)t+="─".repeat(a[e])+"  ";yield t}else o!==i-1&&(yield l(1))}s||(yield l(2))}class _t{module;constructor(t){this.module=t}get moduleName(){return this.module.moduleName}names(){return this.module.names}get packageName(){return this.module.packageName}}class gt{input;constructor(t){this.input=t}isTerminal(){return this.input.isTerminal()}async readAsync(t){const e=await this.input.readAsync(t);return String.fromCharCode(...e)}}class wt extends _t{module;constructor(t){super(t),this.module=t}async run(t,e){const s=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0===s)throw new q(t);if(!Object.prototype.hasOwnProperty.call(s,"run"))throw new Y(t);const{args:n,environment:i,fileSystem:r,stdout:o,stderr:a}=e,l={args:n,environment:i,fileSystem:r,stdin:new gt(e.stdin),stdout:o,stderr:a};try{return await s.run(t,l)}catch{throw new G(t)}}}class yt extends _t{module;constructor(t){super(t),this.module=t}async run(t,e){const{args:s,workerIO:n,fileSystem:i,stdin:r,stdout:o,stderr:a}=e,{wasmBaseUrl:l}=this.module.loader,h=Date.now(),c=this.module.loader.getWasmModule(this.packageName,this.moduleName);if(void 0===c)throw new q(t);function u(t){const{termios:e}=n;return e.log("Termios get"),e.clone()}function d(t,e,s){return n.setTermios(s),0}function m(t){return[e.environment.getNumber("LINES")??24,e.environment.getNumber("COLUMNS")??80]}function f(t,e){return n.poll(e)}function p(t,e,s,n,i){if(0===n)return 0;let o=r.read(n);return 1===o.length&&4===o[0]&&(o=[]),e.set(o,s),o.length}function _(e,i,r,l,h){if(0===l)return 0;const c=i.slice(r,r+l),u=n.utf8ArrayToString(c),d="/dev/tty1"===e.path;return d&&"touch"===t&&s.length>1||(d?a:o).write(u),l}let g;function w(t){void 0===g&&(g=t)}const y=await c({thisProgram:t,arguments:s,locateFile:t=>l+this.packageName+"/"+t,onExit:t=>w(t),quit:(t,e)=>w(t),preRun:[t=>{if(Object.prototype.hasOwnProperty.call(t,"FS")){const e=t.FS,{mountpoint:s}=i;e.mkdir(s,511),e.mount(i.PROXYFS,{root:s,fs:i.FS},s),e.chdir(i.FS.cwd())}Object.prototype.hasOwnProperty.call(t,"ENV")&&e.environment.copyIntoCommand(t.ENV,o.supportsAnsiEscapes()),Object.prototype.hasOwnProperty.call(t,"TTY")&&(t.TTY.default_tty_ops.ioctl_tcgets=u,t.TTY.default_tty_ops.ioctl_tcsets=d,t.TTY.default_tty_ops.ioctl_tiocgwinsz=m,t.TTY.stream_ops.poll=f,t.TTY.stream_ops.read=p,t.TTY.stream_ops.write=_)}]});if(void 0===g)g=126;else{if(Object.prototype.hasOwnProperty.call(y,"FS")){const t=y.FS;for(const e of[t.streams[1],t.streams[2]])null===e||t.isClosed(e)||t.close(e)}Object.prototype.hasOwnProperty.call(y,"getEnvStrings")&&e.environment.copyFromCommand(y.getEnvStrings())}const C=Date.now();return console.log(`Cockle ${t} load and run time ${C-h} ms`),g}}class Ct{commandModuleLoader;name;commands;packageName;wasm;constructor(t,e,s,n,i){this.commandModuleLoader=t,this.name=e,this.commands=s,this.packageName=n,this.wasm=i}get loader(){return this.commandModuleLoader}get runner(){return void 0===this._runner&&(this._runner=this.wasm?new yt(this):new wt(this)),this._runner}get moduleName(){return this.name}get names(){return this.commands}_runner}class St{get(t,e){const s=this.key(t,e);return this._cache.get(s)??void 0}has(t,e){const s=this.key(t,e);return this._cache.has(s)}key(t,e){return[t,e].join("/")}set(t,e,s){const n=this.key(t,e);this._cache.set(n,s)}_cache=new Map}class Et{wasmBaseUrl;downloadModuleCallback;constructor(t,e){this.wasmBaseUrl=t,this.downloadModuleCallback=e}getJavaScriptModule(t,e){const s=this._getModule(t,e,!1);return void 0!==s?s:void 0}getWasmModule(t,e){const s=this._getModule(t,e,!0);return void 0!==s?s:void 0}_getModule(t,e,s){let n=this.cache.get(t,e);if(void 0===n){const i=this.cache.key(t,e)+".js",r=this.wasmBaseUrl+i;console.log(`Cockle loading ${s?"WebAssembly":"JavaScript"} module from ${r}`),this.downloadModuleCallback(t,e,!0);try{importScripts(r),n=self.Module}finally{this.downloadModuleCallback(t,e,!1)}void 0!==n&&this.cache.set(t,e,n)}return n}cache=new St}class bt{name;version;build_string;channel;platform;wasm;modules;constructor(t,e,s,n,i,r,o){this.name=t,this.version=e,this.build_string=s,this.channel=n,this.platform=i,this.wasm=r,this.modules=o}}class kt{get moduleName(){return"<builtin>"}get packageName(){return""}names(){return[this.name]}run(t,e){if(t!==this.name)throw new q(t);return this._run(e)}}class Ot{shortName;longName;description;constructor(t,e,s){this.shortName=t,this.longName=e,this.description=s}get isSet(){return this._isSet}get name(){return this.shortName?this.shortName:this.longName}get prefixedName(){return this.shortName?`-${this.shortName}`:`--${this.longName}`}parse(t,e){return this.set(),e}set(){this._isSet=!0}_isSet=!1}class It extends Ot{constructor(t,e,s){super(t,e,s)}}class Nt extends It{constructor(t,e,s){super(t,e,s)}get string(){return this._string}parse(t,e){return this.set(),e.length>0&&!e[0].startsWith("-")&&(this._string=e.shift()),e}_string}class vt extends Ot{minCount;constructor(t=1){if(super("","",""),this.minCount=t,t<0)throw new K("Negative minCount in TrailingStringsOption.constructor")}get length(){return this._strings.length}parse(t,e){this._strings.push(t),this.set();for(const t of e){if(t.startsWith("-"))throw new K("Cannot have named option after parsing a trailing path");this._strings.push(t)}return[]}get strings(){return this._strings}_strings=[]}class xt{parse(t){let e=t.slice();const s=this._getStrings();for(;e.length>0;){const t=e.shift();if(t.startsWith("-")&&t.length>1)if(t.startsWith("--")){const s=t.slice(2);e=this._findByLongName(s).parse(t,e)}else{const s=t.slice(1);e=this._findByShortName(s).parse(t,e)}else{if(null===s)throw new K(`Unrecognised option: '${t}'`);e=s.parse(t,e)}}if(s&&s.length<s.minCount)throw new K("Insufficient trailing strings options specified");return this}writeHelp(t){for(const e of this._help())t.write(`${e}\n`)}_findByLongName(t){let e;for(e of Object.values(this))if(e.longName===t)return e;throw new K(`No such longName option '${t}'`)}_findByShortName(t){let e;for(e of Object.values(this))if(e.shortName===t)return e;throw new K(`No such shortName option '${t}'`)}_getStrings(){return"trailingStrings"in this?this.trailingStrings:null}_help(){return[...Object.values(this)].sort(((t,e)=>t.name>e.name?1:-1)).map((t=>{const e=t.prefixedName,s=Math.max(1,12-e.length);return`    ${e}${" ".repeat(s)}${t.description}`}))}}class At extends xt{trailingStrings=new vt(0)}class Tt extends kt{get name(){return"alias"}async _run(t){const{aliases:e,args:s,stdout:n}=t,i=(new At).parse(s);if(i.trailingStrings.isSet)for(const t of i.trailingStrings.strings){const s=t.indexOf("=");-1===s?n.write(`${t}='${e.get(t)}'\n`):e.set(t.slice(0,s),t.slice(s+1))}else for(const[t,s]of e.entries())n.write(`${t}='${s}'\n`);return 0}}class Rt extends xt{trailingStrings=new vt(0)}class Pt extends kt{get name(){return"cd"}async _run(t){const{args:e}=t,s=(new Rt).parse(e).trailingStrings.strings;if(s.length<1)return 0;if(s.length>1)throw new K("cd: too many arguments");let n=s[0];if("-"===n){const e=t.environment.get("OLDPWD");if(void 0===e)throw new K("cd: OLDPWD not set");n=e,t.stdout.write(`${n}\n`)}const{FS:i}=t.fileSystem,r=i.cwd();return i.chdir(n),t.environment.set("OLDPWD",r),t.environment.set("PWD",i.cwd()),0}}class Lt extends kt{get name(){return"clear"}async _run(t){const{stdout:e}=t;return e.supportsAnsiEscapes()&&e.write(M+F+L),0}}class Mt extends xt{version=new It("v","version","show cockle version");package=new Nt("p","package","show package information");module=new Nt("m","module","show module information");command=new Nt("c","command","show command information");help=new It("h","help","display this help and exit")}class Ft extends kt{get name(){return"cockle-config"}async _run(t){const{args:e,stdout:s}=t,n=(new Mt).parse(e);if(n.help.isSet)n.writeHelp(s);else{const s=0===e.length;(s||n.version.isSet)&&this._writeVersion(t),(s||n.package.isSet)&&this._writePackageConfig(t,n.package.string),(s||n.module.isSet)&&this._writeModuleConfig(t,n.module.string),n.command.isSet&&this._writeCommandConfig(t,n.command.string)}return 0}_writeCommandConfig(t,e){const{commandRegistry:s,stdout:n}=t,i=void 0===e?s.allCommands():[e],r=[["command","module"]];for(const t of i){const e=s.get(t);if(null===e)throw new K(`Unknown command '${t}'`);r.push([t,e.moduleName])}let o=null;n.supportsAnsiEscapes()&&(o=new Map,o.set(1,$));for(const t of pt(r,1,!1,o))n.write(t+"\n")}_writeModuleConfig(t,e){const{commandRegistry:s,stdout:n,commandModuleCache:i}=t;let r=s.allModules();if(void 0!==e&&(r=r.filter((t=>t.name===e)),0===r.length))throw new K(`Unknown module '${e}'`);const o=[["module","package","cached"]];for(const t of r)o.push([t.name,t.packageName,i.has(t.packageName,t.name)?"yes":""]);let a=null;n.supportsAnsiEscapes()&&(a=new Map,a.set(1,$),a.set(2,U));for(const t of pt(o,1,!1,a))n.write(t+"\n")}_writePackageConfig(t,e){const{commandRegistry:s,stdout:n}=t;let i=[...s.commandPackageMap.values()];if(void 0!==e&&(i=i.filter((t=>t.name===e)),0===i.length))throw new K(`Unknown package '${e}'`);const r=[["package","type","version","build string","source"]];for(const t of i)r.push([t.name,t.wasm?"wasm":"js",t.version,t.build_string,t.channel]);let o=null;n.supportsAnsiEscapes()&&(o=new Map,o.set(1,$),o.set(2,U),o.set(3,z),o.set(4,V));for(const t of pt(r,1,!1,o))n.write(t+"\n")}_writeVersion(t){const{stdout:e}=t;e.write("cockle 0.0.19\n")}}class Dt extends kt{get name(){return"exit"}async _run(t){const{stdout:e,terminate:s}=t;return e.write("Terminating shell...\n"),e.flush(),s(),0}}class Wt extends xt{trailingStrings=new vt(0)}class Bt extends kt{get name(){return"export"}async _run(t){const{args:e,environment:s}=t,n=(new Wt).parse(e);if(n.trailingStrings.isSet)for(const t of n.trailingStrings.strings){const e=t.indexOf("=");if(e>0){const n=t.slice(0,e),i=t.slice(e+1);s.set(n,i)}}return 0}}class jt extends xt{clear=new It("c","","clear the history by deleting all of the entries");help=new It("","help","display this help and exit")}class Ht extends kt{get name(){return"history"}async _run(t){const{args:e,history:s,stdout:n}=t,i=(new jt).parse(e);return i.help.isSet?i.writeHelp(n):i.clear.isSet?s.clear():s.write(n),0}}class $t{constructor(){this.registerBuiltinCommands(e)}allCommands(){const t=Array.from(this._map.keys());return t.sort(),t}allModules(){const t=[];for(const e of this.commandPackageMap.values())t.push(...e.modules);return t.sort(((t,e)=>t.name<e.name?-1:1)),t}get(t){return this._map.get(t)??null}match(t){return[...this._map.keys()].filter((e=>e.startsWith(t))).sort()}registerBuiltinCommands(t){for(const[e,s]of Object.entries(t))if(e.endsWith("Command")&&!e.startsWith("Builtin"))try{const t=new s;t instanceof kt&&this._register(t)}catch{}}registerCommandPackage(t){this.commandPackageMap.set(t.name,t);for(const e of t.modules)this._register(e.runner)}_register(t){for(const e of t.names())this._map.set(e,t)}_map=new Map;commandPackageMap=new Map}class Ut{options;constructor(t){this.options=t,this._environment=new Q(t.color),this._commandModuleLoader=new Et(t.wasmBaseUrl,t.downloadModuleCallback),this._commandRegistry=new $t}get aliases(){return this._aliases}get environment(){return this._environment}get history(){return this._history}async initialize(){await this._initWasmPackages(),await this._initFileSystem()}async input(t){if(this._isRunning)switch(t.charCodeAt(0)){case 13:{this.output("\n");const t=this._currentLine;this._currentLine="",this._cursorIndex=0,await this._runCommands(t),this._outputPrompt();break}case 127:if(this._cursorIndex>0){const t=this._currentLine.slice(this._cursorIndex);this._currentLine=this._currentLine.slice(0,this._cursorIndex-1)+t,this._cursorIndex--,this.output(P(1)+t+D+P(t.length))}break;case 9:await this._tabComplete();break;case 27:this._escapedInput(t);break;case 4:break;default:if(this._cursorIndex===this._currentLine.length)this._currentLine+=t,this.output(t);else{const e=this._currentLine.slice(this._cursorIndex);this._currentLine=this._currentLine.slice(0,this._cursorIndex)+t+e,this.output(D+t+e+P(e.length))}this._cursorIndex++}}output(t){this._isRunning&&this.options.workerIO.write(t)}async setSize(t,e){const{environment:s}=this;t>=1?s.set("LINES",t.toString()):s.delete("LINES"),e>=1?s.set("COLUMNS",e.toString()):s.delete("COLUMNS")}async start(){this._isRunning=!0,await this._outputPrompt()}terminate(){console.log("Cockle ShellImpl.terminate"),this._isRunning=!1,this.options.terminateCallback()}async _escapedInput(t){const e=t.slice(1);switch(e){case"[A":case"[1A":case"[B":case"[1B":{const t=this._history.scrollCurrent(e.endsWith("B"));this._currentLine=null!==t?t:"",this._cursorIndex=this._currentLine.length,this.output(W+`\r${this._environment.getPrompt()}${this._currentLine}`);break}case"[D":case"[1D":this._cursorIndex>0&&(this._cursorIndex--,this.output(P()));break;case"[C":case"[1C":this._cursorIndex<this._currentLine.length&&(this._cursorIndex++,this.output(R()));break;case"[3~":if(this._cursorIndex<this._currentLine.length){const t=this._currentLine.slice(this._cursorIndex+1);this._currentLine=this._currentLine.slice(0,this._cursorIndex)+t,this.output(D+t+P(t.length))}break;case"[H":case"[1;2H":this._cursorIndex>0&&(this.output(P(this._cursorIndex)),this._cursorIndex=0);break;case"[F":case"[1;2F":{const{length:t}=this._currentLine;this._cursorIndex<t&&(this.output(R(t-this._cursorIndex)),this._cursorIndex=t);break}case"[1;2D":case"[1;5D":if(this._cursorIndex>0){const t=this._currentLine.slice(0,this._cursorIndex).trimEnd().lastIndexOf(" ")+1;this.output(P(this._cursorIndex-t)),this._cursorIndex=t}break;case"[1;2C":case"[1;5C":{const{length:t}=this._currentLine;if(this._cursorIndex<t-1){const e=this._currentLine.slice(this._cursorIndex),s=e.trimStart(),n=s.indexOf(" "),i=n<0?t:this._cursorIndex+e.length-s.length+n;this.output(R(i-this._cursorIndex)),this._cursorIndex=i}break}}}_filenameExpansion(t){let e=[],s=0;for(const n of t){if(n.startsWith("-")){s++,e.push(n);continue}if(!n.includes("*")&&!n.includes("?")){e.push(n);continue}const{FS:t}=this._fileSystem,i=t.analyzePath(n,!1);if(!i.parentExists){e.push(n);continue}const r=i.parentPath;let o=r;const a=t.cwd();o.startsWith(a)&&(o=o.slice(a.length),o.startsWith("/")&&(o=o.slice(1)));let l=t.readdir(r),h=i.name.replace(/[.+^${}()|[\]\\]/g,"\\$&");h=h.replaceAll("*",".*"),h=h.replaceAll("?",".");const c=new RegExp(`^${h}$`);l=l.filter((t=>t.match(c))),l=l.filter((t=>!t.startsWith("."))),o.length>0&&(l=l.map((t=>o+"/"+t))),e=e.concat(l)}return e.length===s&&(e=t),e}async _initFileSystem(){const{wasmBaseUrl:t}=this.options,e=this._commandModuleLoader.getWasmModule("cockle_fs","fs");if(void 0===e)return void console.error("Unable to load cockle_fs, shell cannot function");const s=await e({locateFile:e=>t+"cockle_fs/"+e}),{FS:n,PATH:i,ERRNO_CODES:r,PROXYFS:o}=s,a=this.options.mountpoint??"/drive";n.mkdirTree(a,511),this._fileSystem={FS:n,PATH:i,ERRNO_CODES:r,PROXYFS:o,mountpoint:a};const{browsingContextId:l,driveFsBaseUrl:h,initialDirectories:c,initialFiles:u}=this.options;this.options.initDriveFSCallback({browsingContextId:l,driveFsBaseUrl:h,fileSystem:this._fileSystem,mountpoint:a}),n.chdir(a),this._environment.set("PWD",n.cwd()),c&&c.forEach((t=>n.mkdir(t,509))),u&&Object.entries(u).forEach((([t,e])=>n.writeFile(t,e,{mode:436})))}async _initWasmPackages(){const t=this.options.wasmBaseUrl+"cockle-config.json",e=await fetch(t);e.ok||console.error(`Failed to fetch ${t}, terminal cannot function without it`);const s=await e.json(),n=Object.keys(s.packages),i="cockle_fs";n.includes(i)||console.error(`cockle-config.json does not include required package '${i}'`);for(const t of n){const e=s.packages[t],n=Object.entries(e.modules).map((([s,n])=>new Ct(this._commandModuleLoader,s,n.commands?n.commands.split(","):[],t,e.wasm))),i=new bt(t,e.version,e.build_string,e.channel,e.platform,e.wasm,n);this._commandRegistry.registerCommandPackage(i)}if(Object.hasOwn(s,"aliases"))for(const[t,e]of Object.entries(s.aliases)){const s=e;s.length>0&&this._aliases.set(t,s)}}_outputPrompt(){this._isRunning&&this.options.workerIO.write(`\n${this.environment.getPrompt()}`)}async _runCommands(t){if(this.options.enableBufferedStdinCallback(!0),this.options.workerIO.allowAdjacentNewline(!0),t.startsWith("!")){const e=parseInt(t.slice(1)),s=this._history.at(e);if(null===s){let t="!"+e+": event not found";return this.options.color&&(t=j+t+B),this.output(`${t}\n`),void this._outputPrompt()}t=s}let e;this._history.add(t);const s=new Z(this.options.stdinCallback,this.options.stdinAsyncCallback),n=new tt(this.output.bind(this)),i=new tt(this.output.bind(this),this.options.color?j:null,this.options.color?B:null);try{const r=mt(t,!0,this._aliases);for(const t of r)if(t instanceof ct)e=await this._runCommand(t,s,n,i);else{if(!(t instanceof ut))throw new K(`Expected CommandNode or PipeNode not ${t}`);{const{commands:e}=t,r=e.length;let o;for(let t=0;t<r;t++){const a=0===t?s:o.input,l=t<r-1?o=new it:n;await this._runCommand(e[t],a,l,i)}}}}catch(t){t instanceof X&&(e=t.exitCode),i.write(t+"\n"),i.flush()}finally{e=e??1,this.environment.set("?",`${e}`),this.options.workerIO.allowAdjacentNewline(!1),this.options.enableBufferedStdinCallback(!1)}}async _runCommand(t,e,s,n){const i=t.name.value,r=this._commandRegistry.get(i);if(null===r)throw new q(i);if(t.redirects){if(t.redirects.length>1)throw new K("Only implemented a single redirect per command");const n=t.redirects[0],i=n.token.value,r=n.target.value;if(">"===i||">>"===i)s=new rt(this._fileSystem,r,">>"===i);else{if("<"!==i)throw new K("Unrecognised redirect "+i);e=new ot(this._fileSystem,r)}}let o=t.suffix.map((t=>t.value));o=this._filenameExpansion(o);const{aliases:a,environment:l,history:h}=this,c={args:o,fileSystem:this._fileSystem,aliases:a,commandRegistry:this._commandRegistry,environment:l,history:h,terminate:this.terminate.bind(this),stdin:e,stdout:s,stderr:n,workerIO:this.options.workerIO,commandModuleCache:this._commandModuleLoader.cache},u=await r.run(i,c);return n.flush(),s.flush(),u}async _tabComplete(){const t=this._currentLine.slice(0,this._cursorIndex);if(t.endsWith(" ")&&t.trim().length>0)return;const e=this._currentLine.slice(this._cursorIndex),s=mt(t,!1),[n,i]=s.length>0?s[s.length-1].lastToken():[null,!0];let r=n?.value??"",o=[];if(i){const t=this._commandRegistry.match(r),e=this._aliases.match(r);o=[...new Set([...t,...e])].sort()}else{const{FS:t}=this._fileSystem,e=t.analyzePath(r,!1);if(!e.parentExists)return;const s=r;r=e.name;const{exists:n}=e;if(n&&!t.isDir(t.stat(e.path,!1).mode))o=[r];else{const i=n?e.path:e.parentPath;o=t.readdir(i),n?"."===s||".."===s||s.endsWith("/.")||s.endsWith("/..")?o=o.filter((t=>t.startsWith("."))):(o=o.filter((t=>!t.startsWith("."))),s.endsWith("/")||(this._currentLine+="/")):o=o.filter((t=>t.startsWith(r))),o=o.map((e=>t.isDir(t.stat(i+"/"+e,!1).mode)?e+"/":e))}}if(1===o.length){let t=o[0].slice(r.length);t.endsWith("/")||(t+=" "),this._currentLine=this._currentLine.slice(0,this._cursorIndex)+t+e,this._cursorIndex+=t.length,this.output(t+e+P(e.length))}else if(o.length>1){const t=function(t,e=0){if(t.length<1)return"";const s=Math.min(...t.map((t=>t.length))),n=t[0];let i=e;for(;i<s&&t.every((t=>t[i]===n[i]));)i++;return n.slice(0,i)}(o,r.length);if(t.length>r.length){const s=t.slice(r.length);this._currentLine=this._currentLine.slice(0,this._cursorIndex)+s+e,this._cursorIndex+=s.length,this.output(s+e+P(e.length))}else{const t=`\n${function(t,e){if(t.length<1)return[];if(e<1)return[t.join("  ")];const s=t.length,n=Math.max(...t.map((t=>t.length))),i=Math.min(Math.floor(e/(n+2)),s),r=Math.ceil(s/i),o=[];for(let e=0;e<r;++e){let a="";for(let o=0;o<i;++o){const i=o*r+e;if(i>=s)continue;const l=t[i];a+=l,i+r<s&&(a+=" ".repeat(n+2-l.length))}o.push(a)}return o}(o,this._environment.getNumber("COLUMNS")??0).join("\n")}\n${this._environment.getPrompt()}${this._currentLine}`;this.output(t+P(e.length))}}}_currentLine="";_cursorIndex=0;_isRunning=!1;_aliases=new A;_commandRegistry;_environment;_history=new J;_commandModuleLoader;_fileSystem}class zt{async initialize(t,e,s,n,i){console.log("Cockle BaseShellWorker.initialize"),this._workerIO=new x(t.sharedArrayBuffer,n),this._downloadModuleCallback=e,this._enableBufferedStdinCallback=s,this._terminateCallback=i;const{color:r,mountpoint:o,wasmBaseUrl:a,driveFsBaseUrl:l,browsingContextId:h,initialDirectories:c,initialFiles:u}=t;this._shellImpl=new Ut({color:r,mountpoint:o,wasmBaseUrl:a,driveFsBaseUrl:l,browsingContextId:h,initialDirectories:c,initialFiles:u,downloadModuleCallback:this._downloadModuleCallback.bind(this),enableBufferedStdinCallback:this.enableBufferedStdin.bind(this),initDriveFSCallback:this.initDriveFS.bind(this),terminateCallback:this._terminateCallback.bind(this),stdinCallback:this._workerIO.read.bind(this._workerIO),stdinAsyncCallback:this._workerIO.readAsync.bind(this._workerIO),workerIO:this._workerIO}),await this._shellImpl.initialize()}async enableBufferedStdin(t){this._workerIO&&(t?await this._workerIO.enable():await this._workerIO.disable()),this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(t)}async input(t){this._shellImpl&&await this._shellImpl.input(t)}async setSize(t,e){this._shellImpl&&await this._shellImpl.setSize(t,e)}async start(){this._shellImpl&&await this._shellImpl.start()}_shellImpl;_workerIO;_downloadModuleCallback;_enableBufferedStdinCallback;_terminateCallback}const Vt=new TextEncoder,Qt=new TextDecoder("utf-8"),Xt={0:!1,1:!0,2:!0,64:!0,65:!0,66:!0,129:!0,193:!0,514:!0,577:!0,578:!0,705:!0,706:!0,1024:!0,1025:!0,1026:!0,1089:!0,1090:!0,1153:!0,1154:!0,1217:!0,1218:!0,4096:!0,4098:!0};class qt{constructor(t){this.fs=t}open(t){const e=this.fs.realPath(t.node);this.fs.FS.isFile(t.node.mode)&&(t.file=this.fs.API.get(e))}close(t){if(!this.fs.FS.isFile(t.node.mode)||!t.file)return;const e=this.fs.realPath(t.node),s=t.flags;let n="string"==typeof s?parseInt(s,10):s;n&=8191;let i=!0;n in Xt&&(i=Xt[n]),i&&this.fs.API.put(e,t.file),t.file=void 0}read(t,e,s,n,i){if(n<=0||void 0===t.file||i>=(t.file.data.length||0))return 0;const r=Math.min(t.file.data.length-i,n);return e.set(t.file.data.subarray(i,i+r),s),r}write(t,e,s,n,i){var r;if(n<=0||void 0===t.file)return 0;if(t.node.timestamp=Date.now(),i+n>((null===(r=t.file)||void 0===r?void 0:r.data.length)||0)){const e=t.file.data?t.file.data:new Uint8Array;t.file.data=new Uint8Array(i+n),t.file.data.set(e)}return t.file.data.set(e.subarray(s,s+n),i),n}llseek(t,e,s){let n=e;if(1===s)n+=t.position;else if(2===s&&this.fs.FS.isFile(t.node.mode)){if(void 0===t.file)throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EPERM);n+=t.file.data.length}if(n<0)throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EINVAL);return n}}class Yt{constructor(t){this.fs=t}node(t){return function(t){return"node"in t}(t)?t.node:t}getattr(t){const e=this.node(t);return{...this.fs.API.getattr(this.fs.realPath(e)),mode:e.mode,ino:e.id}}setattr(t,e){const s=this.node(t);for(const[t,n]of Object.entries(e))switch(t){case"mode":s.mode=n;break;case"timestamp":s.timestamp=n;break;case"size":{const t=n,e=this.fs.realPath(s);if(this.fs.FS.isFile(s.mode)&&t>=0){const s=this.fs.API.get(e),n=s.data?s.data:new Uint8Array;t!==n.length&&(t<n.length?s.data=s.data.slice(0,t):(s.data=new Uint8Array(t),s.data.set(n)),this.fs.API.put(e,s))}else console.warn("setattr size of",t,"on",s,"not yet implemented");break}default:console.warn("setattr",t,"of",n,"on",s,"not yet implemented")}}lookup(t,e){const s=this.node(t),n=this.fs.PATH.join2(this.fs.realPath(s),e),i=this.fs.API.lookup(n);if(!i.ok)throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.ENOENT);return this.fs.createNode(s,e,i.mode,0)}mknod(t,e,s,n){const i=this.node(t),r=this.fs.PATH.join2(this.fs.realPath(i),e);return this.fs.API.mknod(r,s),this.fs.createNode(i,e,s,n)}rename(t,e,s){const n=this.node(t),i=this.node(e);this.fs.API.rename(n.parent?this.fs.PATH.join2(this.fs.realPath(n.parent),n.name):n.name,this.fs.PATH.join2(this.fs.realPath(i),s)),n.name=s,n.parent=i}unlink(t,e){this.fs.API.rmdir(this.fs.PATH.join2(this.fs.realPath(this.node(t)),e))}rmdir(t,e){this.fs.API.rmdir(this.fs.PATH.join2(this.fs.realPath(this.node(t)),e))}readdir(t){return this.fs.API.readdir(this.fs.realPath(this.node(t)))}symlink(t,e,s){throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EPERM)}readlink(t){throw new this.fs.FS.ErrnoError(this.fs.ERRNO_CODES.EPERM)}}class Kt{constructor(t){this._driveName=t.driveName,this._mountpoint=t.mountpoint,this.FS=t.FS,this.ERRNO_CODES=t.ERRNO_CODES}lookup(t){return this.request({method:"lookup",path:this.normalizePath(t)})}getmode(t){return this.request({method:"getmode",path:this.normalizePath(t)})}mknod(t,e){return this.request({method:"mknod",path:this.normalizePath(t),data:{mode:e}})}rename(t,e){return this.request({method:"rename",path:this.normalizePath(t),data:{newPath:this.normalizePath(e)}})}readdir(t){const e=this.request({method:"readdir",path:this.normalizePath(t)});return e.push("."),e.push(".."),e}rmdir(t){return this.request({method:"rmdir",path:this.normalizePath(t)})}get(t){const e=this.request({method:"get",path:this.normalizePath(t)});if(!e)throw new this.FS.ErrnoError(this.ERRNO_CODES.ENOENT);const s=e.content,n=e.format;switch(n){case"json":case"text":return{data:Vt.encode(s),format:n};case"base64":{const t=atob(s),e=t.length,i=new Uint8Array(e);for(let s=0;s<e;s++)i[s]=t.charCodeAt(s);return{data:i,format:n}}default:throw new this.FS.ErrnoError(this.ERRNO_CODES.ENOENT)}}put(t,e){switch(e.format){case"json":case"text":return this.request({method:"put",path:this.normalizePath(t),data:{format:e.format,data:Qt.decode(e.data)}});case"base64":{let s="";for(let t=0;t<e.data.byteLength;t++)s+=String.fromCharCode(e.data[t]);return this.request({method:"put",path:this.normalizePath(t),data:{format:e.format,data:btoa(s)}})}}}getattr(t){const e=this.request({method:"getattr",path:this.normalizePath(t)});return e.atime&&(e.atime=new Date(e.atime)),e.mtime&&(e.mtime=new Date(e.mtime)),e.ctime&&(e.ctime=new Date(e.ctime)),e.size=e.size||0,e}normalizePath(t){return t.startsWith(this._mountpoint)&&(t=t.slice(this._mountpoint.length)),this._driveName&&(t=`${this._driveName}:${t}`),t}}class Gt extends Kt{constructor(t){super(t),this._baseUrl=t.baseUrl,this._browsingContextId=t.browsingContextId||""}request(t){const e=new XMLHttpRequest;e.open("POST",encodeURI(this.endpoint),!1);const s={data:t,browsingContextId:this._browsingContextId};try{e.send(JSON.stringify(s))}catch(t){console.error(t)}if(e.status>=400)throw new this.FS.ErrnoError(this.ERRNO_CODES.EINVAL);return JSON.parse(e.responseText)}get endpoint(){return`${this._baseUrl}api/drive`}}class Jt{constructor(t){this.FS=t.FS,this.PATH=t.PATH,this.ERRNO_CODES=t.ERRNO_CODES,this.API=this.createAPI(t),this.driveName=t.driveName,this.node_ops=new Yt(this),this.stream_ops=new qt(this)}createAPI(t){if(!t.browsingContextId||!t.baseUrl)throw new Error("Cannot create service-worker API without current browsingContextId");return new Gt(t)}mount(t){return this.createNode(null,t.mountpoint,16895,0)}createNode(t,e,s,n){const i=this.FS;if(!i.isDir(s)&&!i.isFile(s))throw new i.ErrnoError(this.ERRNO_CODES.EINVAL);const r=i.createNode(t,e,s,n);return r.node_ops=this.node_ops,r.stream_ops=this.stream_ops,r}getMode(t){return this.API.getmode(t)}realPath(t){const e=[];let s=t;for(e.push(s.name);s.parent!==s;)s=s.parent,e.push(s.name);return e.reverse(),this.PATH.join.apply(null,e)}}c(new class extends zt{initDriveFS(t){const{browsingContextId:e,driveFsBaseUrl:s,fileSystem:n,mountpoint:i}=t;if(console.log("Terminal initDriveFS",s,i,e),""!==i&&void 0!==s&&void 0!==e){const{FS:t,ERRNO_CODES:r,PATH:o}=n,a=new Jt({FS:t,PATH:o,ERRNO_CODES:r,baseUrl:s,driveName:"",mountpoint:i,browsingContextId:e});t.mount(a,{},i),console.log("Terminal connected to shared drive")}else console.warn("Terminal not connected to shared drive")}})})();