"use strict";(self.webpackChunk_jupyterlite_terminal=self.webpackChunk_jupyterlite_terminal||[]).push([[488],{763:(t,e,s)=>{var n;s.d(e,{X:()=>n}),function(t){t.MAIN=0,t.WORKER=1,t.LENGTH=2,t.START=3,t.maxChars=64}(n||(n={}))},952:(t,e,s)=>{s.d(e,{J:()=>r});var n=s(1315);class r extends n.S{pipe;constructor(t){super(),this.pipe=t}readAll(){const t=this.pipe.allContent;return this.pipe.clear(),t}}},1203:(t,e,s)=>{s.d(e,{_:()=>n});class n{input;constructor(t){this.input=t}isTerminal(){return this.input.isTerminal()}async readAsync(t){const e=await this.input.readAsync(t);return String.fromCharCode(...e)}}},1315:(t,e,s)=>{s.d(e,{S:()=>n});class n{isTerminal(){return!1}async readAsync(t){return this.read(t)}read(t){if(void 0===this._buffer&&(this._buffer=this.readAll(),this._index=0),this._index<this._buffer.length){const t=this._buffer[this._index++],e=[];for(let s=0;s<t.length;s++)e.push(t.charCodeAt(s));return e}return[]}_buffer;_index=0}},2958:(t,e,s)=>{s.d(e,{z:()=>r});var n=s(1315);class r extends n.S{fileSystem;path;constructor(t,e){super(),this.fileSystem=t,this.path=e}readAll(){const{FS:t}=this.fileSystem;return t.readFile(this.path,{encoding:"utf8"})}}},3482:(t,e,s)=>{s.d(e,{y:()=>n});const n={SUCCESS:0,GENERAL_ERROR:1,IMPROPER_USE:2,CANNOT_RUN_COMMAND:126,CANNOT_FIND_COMMAND:127}},4207:(t,e,s)=>{s.d(e,{n:()=>i});var n=s(5670),r=s(952);class i extends n.j{flush(){}get input(){return new r.J(this)}}},5670:(t,e,s)=>{s.d(e,{j:()=>n});class n{get allContent(){return this.data.join("")}clear(){this.data=[]}supportsAnsiEscapes(){return!1}write(t){this.data.push(t)}data=[]}},5981:(t,e,s)=>{s.d(e,{M:()=>r});var n=s(5670);class r extends n.j{fileSystem;path;append;constructor(t,e,s){super(),this.fileSystem=t,this.path=e,this.append=s}flush(){const{FS:t}=this.fileSystem;let e=this.allContent;if(this.append)try{e=t.readFile(this.path,{encoding:"utf8"})+e}catch(t){}t.writeFile(this.path,e,{mode:436}),this.clear()}}},7095:(t,e,s)=>{s.d(e,{$g:()=>a,C2:()=>o,Ge:()=>r,T6:()=>l,xZ:()=>i});var n=s(3482);class r extends Error{exitCode;constructor(t,e){super(e),this.exitCode=t}}class i extends r{constructor(t){super(n.y.CANNOT_FIND_COMMAND,`'${t}': command not found`)}}class o extends r{constructor(t){super(n.y.CANNOT_FIND_COMMAND,`'${t}': cannot load command`)}}class a extends r{constructor(t){super(n.y.GENERAL_ERROR,t)}}class l extends r{constructor(t){super(n.y.CANNOT_RUN_COMMAND,`'${t}': cannot run command`)}}},7450:(t,e,s)=>{s.d(e,{D:()=>n});class n extends Map{constructor(){super()}getRecursive(t){let e=this.get(t);for(;void 0!==e;){const s=e.split(" ")[0];if(s===t)break;const n=this.get(s);if(void 0===n)return e;e=n+e.slice(s.length),t=s}return e}match(t){return[...this.keys()].filter((e=>e.startsWith(t)))}}},7497:(t,e,s)=>{s.d(e,{Ru:()=>l,Sv:()=>a,qg:()=>c});var n=s(7095),r=s(9685);const i=";&";class o{}class a extends o{name;suffix;redirects;constructor(t,e,s){super(),this.name=t,this.suffix=e,this.redirects=s}lastToken(){return this.redirects&&this.redirects.length>0?this.redirects[this.redirects.length-1].lastToken():this.suffix.length>0?[this.suffix[this.suffix.length-1],!1]:[this.name,!0]}}class l extends o{commands;constructor(t){super(),this.commands=t}lastToken(){return this.commands.length>0?this.commands[this.commands.length-1].lastToken():[null,!1]}}class h extends o{token;target;constructor(t,e){super(),this.token=t,this.target=e}lastToken(){return[this.target,!1]}}function c(t,e=!0,s){const n=(0,r.q)(t,e,s),o=[],a=[];let h=-1;const c=n.length;function d(){1===a.length?o.push(a[0]):a.length>1&&o.push(new l([...a])),a.length=0}for(let t=0;t<c;t++){const e=n[t];h>=0?i.includes(e.value)?(a.push(u(n.slice(h,t))),d(),h=-1):"|"===e.value&&(a.push(u(n.slice(h,t))),h=-1):i.includes(e.value)||(h=t)}return h>=0&&a.push(u(n.slice(h,c))),d(),o}function u(t){let e=t.slice(1);const s=e.findIndex((t=>{return(e=t.value).startsWith(">")||e.startsWith("<");var e}));if(s>=0){if(e.length!==s+2)throw new n.$g("Redirect should be followed by file to redirect to");const r=new h(e[s],e[s+1]);return e=e.slice(0,s),new a(t[0],e,[r])}return new a(t[0],e)}},7703:(t,e,s)=>{s.d(e,{m:()=>n});class n{outputCallback;prefix;suffix;constructor(t,e=null,s=null){this.outputCallback=t,this.prefix=e,this.suffix=s}flush(){}supportsAnsiEscapes(){return!0}write(t){t.length<1||(null!==this.prefix&&(t=this.prefix+t),null!==this.suffix&&(t+=this.suffix),this.outputCallback(t))}}},8316:(t,e,s)=>{s.d(e,{d:()=>n});class n{stdinCallback;stdinAsyncCallback;constructor(t,e){this.stdinCallback=t,this.stdinAsyncCallback=e}isTerminal(){return!0}async readAsync(t){return await this.stdinAsyncCallback(t)}read(t){return this.stdinCallback(t)}}},9399:(t,e,s)=>{s.d(e,{Q:()=>r});const n="[",r={cursorUp:(t=1)=>t>0?n+t+"A":"",cursorDown:(t=1)=>t>0?n+t+"B":"",cursorRight:(t=1)=>t>0?n+t+"C":"",cursorLeft:(t=1)=>t>0?n+t+"D":"",cursorHome:"[H",eraseScreen:"[2J",eraseSavedLines:"[3J",eraseEndLine:"[K",eraseStartLine:"[1K",styleReset:"[1;0m",styleBoldRed:"[1;31m",styleBoldGreen:"[1;32m",styleBrightRed:"[0;91m",styleBrightGreen:"[0;92m",styleBrightYellow:"[0;93m",styleBrightBlue:"[0;94m",styleBrightPurple:"[0;95m",styleBrightCyan:"[0;96m",styleRed:"[0;31m",styleGreen:"[0;32m",styleYellow:"[0;33m",styleBlue:"[0;34m",stylePurple:"[0;35m",styleCyan:"[0;36m",showCursor:"[?25h",hideCursor:"[?25l"}},9488:(t,e,s)=>{s.d(e,{g:()=>q});var n={};s.r(n),s.d(n,{AliasCommand:()=>$,BuiltinCommand:()=>O,CdCommand:()=>W,ClearCommand:()=>D,CockleConfigCommand:()=>P,ExitCommand:()=>U,ExportCommand:()=>z,HistoryCommand:()=>H});var r=s(763),i=s(4133);class o{outputCallback;constructor(t){this.outputCallback=t}allowAdjacentNewline(t){this._allowAdjacentNewline=t}async disable(){this._enabled=!1,this._clear()}async enable(){this._enabled=!0}setTermios(t){this.termios.set(t),this._writeColumn=0}get termios(){return this._termios}utf8ArrayToString(t){return void 0===this._utf8Decoder&&(this._utf8Decoder=new TextDecoder("utf8")),this._utf8Decoder.decode(t)}write(t){let e=[];e="string"==typeof t?this._processWriteChars(t.split("").map((t=>t.charCodeAt(0)))):this._processWriteChars(t),this.outputCallback(String.fromCharCode(...e))}_maybeEchoToOutput(t){const e=(this.termios.c_lflag&i.Uq.ECHO)>0,s=(this.termios.c_lflag&i.Uq.ECHONL)>0;if(!e&&!s)return;const n=[];for(const s of t)switch(s){case 10:n.push(10);break;case 4:break;default:e&&n.push(s)}n.length>0&&this.write(n)}_processReadChars(t){const e=[];for(const s of t)switch(s){case 13:this.termios.c_iflag&i.tc.IGNCR||((this.termios.c_iflag&i.tc.ICRNL)>0?e.push(10):e.push(13));break;case 10:(this.termios.c_iflag&i.tc.INLCR)>0?e.push(13):e.push(10);break;default:e.push(s)}return e}_processWriteChars(t){let e=!1,s=0;const n=[];for(let r=0;r<t.length;r++){const o=t[r];switch(e||27!==o||(e=!0,s=r),o){case 10:if(0===this._writeColumn&&!this._allowAdjacentNewline)break;this._writeColumn=0,(this.termios.c_oflag&i.OJ.ONLCR)>0?n.push(13,10):n.push(10);break;default:!e&&o>=32&&this._writeColumn++,n.push(o)}e&&r>s+2&&(o>=65&&o<=90||o>=97&&o<=122)&&(e=!1)}return n}_readFromBuffer(t){if(null===t){const t=this._readBuffer;return this._readBuffer=[],t}{const e=this._readBuffer.slice(0,t);return this._readBuffer.splice(0,e.length),e}}_allowAdjacentNewline=!1;_enabled=!1;_termios=i.Gc.newDefaultWasm();_writeColumn=0;_utf8Decoder;_readBuffer=[]}class a extends o{constructor(t,e){super(e);const s=r.X.maxChars+3;this._sharedArrayBuffer=t,this._intArray=new Int32Array(this._sharedArrayBuffer,0,s)}poll(t){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.poll when disabled");return this._readBuffer.length>0?5:(t<0&&(t=1/0),4|("not-equal"===Atomics.wait(this._intArray,r.X.MAIN,this._readCount,t)?1:0))}read(t){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.read when disabled");return null!==t&&t<=0?[]:this._readBuffer.length>0?this._readFromBuffer(t):(Atomics.wait(this._intArray,r.X.MAIN,this._readCount),this._postRead(t))}async readAsync(t){if(!this._enabled)throw new Error("SharedArrayBufferWorkerIO.readAsync when disabled");if(null!==t&&t<=0)return[];if(this._readBuffer.length>0)return this._readFromBuffer(t);const{async:e,value:s}=Atomics.waitAsync(this._intArray,r.X.MAIN,this._readCount);return e&&await s,this._postRead(t)}_postRead(t){if(Atomics.load(this._intArray,r.X.MAIN)===this._readCount)return[];const e=this._loadFromSharedArrayBuffer();return this._readCount++,Atomics.store(this._intArray,r.X.WORKER,this._readCount),Atomics.notify(this._intArray,r.X.WORKER,1),this._readBuffer=this._processReadChars(e),this._maybeEchoToOutput(this._readBuffer),this._readFromBuffer(t)}_clear(){this._intArray[r.X.MAIN]=0,this._intArray[r.X.WORKER]=0,this._readCount=0}_loadFromSharedArrayBuffer(){const t=Atomics.load(this._intArray,r.X.LENGTH),e=[];for(let s=0;s<t;s++)e.push(Atomics.load(this._intArray,r.X.START+s));return e}_sharedArrayBuffer;_intArray;_readCount=0}var l=s(7450),h=s(9399);class c extends Map{constructor(t){super(),t?(this.set("PS1",h.Q.styleBoldGreen+"js-shell:"+h.Q.styleReset+" "),this.set("TERM","xterm-256color"),this.set("TERMINFO","/usr/local/share/terminfo")):this.set("PS1","js-shell: ")}copyFromCommand(t){for(const e of t){const t=e.split("="),s=t.shift();s&&!this._ignore.has(s)&&this.set(s,t.join("="))}}copyIntoCommand(t,e){for(const[s,n]of this.entries())(e||"TERM"!==s)&&(t[s]=n)}getNumber(t){const e=this.get(t);if(null===e)return null;const s=Number(e);return isNaN(s)?null:s}getPrompt(){return this.get("PS1")??"$ "}_ignore=new Set(["USER","LOGNAME","HOME","LANG","_"])}var u=s(7095),d=s(3482);class m{add(t){this._current=null,!t.trim()||this._ignoreInitialWhitespace&&t.startsWith(" ")||this._ignoreDuplicates&&t===this.at(-1)||(this._history.length>=this._maxSize&&this._history.shift(),this._history.push(t))}at(t){return this._history.at(t)??null}clear(){this._current=null,this._history=[]}scrollCurrent(t){return this._current=t?null===this._current?null:this._current+1:null===this._current?this._history.length-1:this._current-1,null!==this._current&&(this._current<0?this._current=0:this._current>=this._history.length&&(this._current=null)),null===this._current?null:this.at(this._current)}setMaxSize(t){this._maxSize=Math.max(t,0),this._history.length>this._maxSize&&(this._current=null,this._history=this._history.slice(this._maxSize))}write(t){for(let e=0;e<this._history.length;e++){const s=String(e).padStart(5," ");t.write(`${s}  ${this._history[e]}\n`)}}_history=[];_current=null;_ignoreInitialWhitespace=!0;_ignoreDuplicates=!0;_maxSize=1e3}var _=s(8316),f=s(7703),p=s(4207),g=s(5981),w=s(2958),y=s(7497);function*C(t,e,s=!1,n=null){const r=t.length,i=t[0].length,o=t.map((t=>t.map((t=>t.length)))),a=Array(i).fill(0);for(let t=0;t<r;t++)for(let e=0;e<i;e++)a[e]=Math.max(a[e],o[t][e]);function l(t){let e="╭├╰"[t];for(let s=0;s<i;s++)e+="─".repeat(a[s]+2),e+=s<i-1?"┬┼┴"[t]:"╮┤╯"[t];return e}s||(yield l(0));for(let o=0;o<r;o++){const c=t[o];let u=s?"":"│ ";for(let t=0;t<i;t++){const e=n?.get(t)||null;u+=e?e+c[t]+h.Q.styleReset:c[t],u+=" ".repeat(a[t]-c[t].length),u+=s?"  ":" │ "}if(yield u,o===e-1)if(s){let t="";for(let e=0;e<i;e++)t+="─".repeat(a[e])+"  ";yield t}else o!==r-1&&(yield l(1))}s||(yield l(2))}class S{module;constructor(t){this.module=t}get moduleName(){return this.module.moduleName}names(){return this.module.names}get packageName(){return this.module.packageName}}var k=s(1203);class x extends S{module;constructor(t){super(t),this.module=t}async run(t,e){const s=this.module.loader.getJavaScriptModule(this.packageName,this.moduleName);if(void 0===s)throw new u.xZ(t);if(!Object.prototype.hasOwnProperty.call(s,"run"))throw new u.C2(t);const{args:n,environment:r,fileSystem:i,stdout:o,stderr:a}=e,l={args:n,environment:r,fileSystem:i,stdin:new k._(e.stdin),stdout:o,stderr:a};try{return await s.run(t,l)}catch{throw new u.T6(t)}}}class b extends S{module;constructor(t){super(t),this.module=t}async run(t,e){const{args:s,workerIO:n,fileSystem:r,stdin:i,stdout:o,stderr:a}=e,{wasmBaseUrl:l}=this.module.loader,h=Date.now(),c=this.module.loader.getWasmModule(this.packageName,this.moduleName);if(void 0===c)throw new u.xZ(t);function m(t){const{termios:e}=n;return e.log("Termios get"),e.clone()}function _(t,e,s){return n.setTermios(s),0}function f(t){return[e.environment.getNumber("LINES")??24,e.environment.getNumber("COLUMNS")??80]}function p(t,e){return n.poll(e)}function g(t,e,s,n,r){if(0===n)return 0;let o=i.read(n);return 1===o.length&&4===o[0]&&(o=[]),e.set(o,s),o.length}function w(e,r,i,l,h){if(0===l)return 0;const c=r.slice(i,i+l),u=n.utf8ArrayToString(c),d="/dev/tty1"===e.path;return d&&"touch"===t&&s.length>1||(d?a:o).write(u),l}let y;function C(t){void 0===y&&(y=t)}const S=await c({thisProgram:t,arguments:s,locateFile:t=>l+this.packageName+"/"+t,onExit:t=>C(t),quit:(t,e)=>C(t),preRun:[t=>{if(Object.prototype.hasOwnProperty.call(t,"FS")){const e=t.FS,{mountpoint:s}=r;e.mkdir(s,511),e.mount(r.PROXYFS,{root:s,fs:r.FS},s),e.chdir(r.FS.cwd())}Object.prototype.hasOwnProperty.call(t,"ENV")&&e.environment.copyIntoCommand(t.ENV,o.supportsAnsiEscapes()),Object.prototype.hasOwnProperty.call(t,"TTY")&&(t.TTY.default_tty_ops.ioctl_tcgets=m,t.TTY.default_tty_ops.ioctl_tcsets=_,t.TTY.default_tty_ops.ioctl_tiocgwinsz=f,t.TTY.stream_ops.poll=p,t.TTY.stream_ops.read=g,t.TTY.stream_ops.write=w)}]});if(void 0===y)y=d.y.CANNOT_RUN_COMMAND;else{if(Object.prototype.hasOwnProperty.call(S,"FS")){const t=S.FS;for(const e of[t.streams[1],t.streams[2]])null===e||t.isClosed(e)||t.close(e)}Object.prototype.hasOwnProperty.call(S,"getEnvStrings")&&e.environment.copyFromCommand(S.getEnvStrings())}const k=Date.now();return console.log(`Cockle ${t} load and run time ${k-h} ms`),y}}class v{commandModuleLoader;name;commands;packageName;wasm;constructor(t,e,s,n,r){this.commandModuleLoader=t,this.name=e,this.commands=s,this.packageName=n,this.wasm=r}get loader(){return this.commandModuleLoader}get runner(){return void 0===this._runner&&(this._runner=this.wasm?new b(this):new x(this)),this._runner}get moduleName(){return this.name}get names(){return this.commands}_runner}class N{get(t,e){const s=this.key(t,e);return this._cache.get(s)??void 0}has(t,e){const s=this.key(t,e);return this._cache.has(s)}key(t,e){return[t,e].join("/")}set(t,e,s){const n=this.key(t,e);this._cache.set(n,s)}_cache=new Map}class I{wasmBaseUrl;downloadModuleCallback;constructor(t,e){this.wasmBaseUrl=t,this.downloadModuleCallback=e}getJavaScriptModule(t,e){const s=this._getModule(t,e,!1);return void 0!==s?s:void 0}getWasmModule(t,e){const s=this._getModule(t,e,!0);return void 0!==s?s:void 0}_getModule(t,e,s){let n=this.cache.get(t,e);if(void 0===n){const r=this.cache.key(t,e)+".js",i=this.wasmBaseUrl+r;console.log(`Cockle loading ${s?"WebAssembly":"JavaScript"} module from ${i}`),this.downloadModuleCallback(t,e,!0);try{importScripts(i),n=self.Module}finally{this.downloadModuleCallback(t,e,!1)}void 0!==n&&this.cache.set(t,e,n)}return n}cache=new N}class A{name;version;build_string;channel;platform;wasm;modules;constructor(t,e,s,n,r,i,o){this.name=t,this.version=e,this.build_string=s,this.channel=n,this.platform=r,this.wasm=i,this.modules=o}}class O{get moduleName(){return"<builtin>"}get packageName(){return""}names(){return[this.name]}run(t,e){if(t!==this.name)throw new u.xZ(t);return this._run(e)}}class R{shortName;longName;description;constructor(t,e,s){this.shortName=t,this.longName=e,this.description=s}get isSet(){return this._isSet}get name(){return this.shortName?this.shortName:this.longName}get prefixedName(){return this.shortName?`-${this.shortName}`:`--${this.longName}`}parse(t,e){return this.set(),e}set(){this._isSet=!0}_isSet=!1}class M extends R{constructor(t,e,s){super(t,e,s)}}class L extends M{constructor(t,e,s){super(t,e,s)}get string(){return this._string}parse(t,e){return this.set(),e.length>0&&!e[0].startsWith("-")&&(this._string=e.shift()),e}_string}class B extends R{minCount;constructor(t=1){if(super("","",""),this.minCount=t,t<0)throw new u.$g("Negative minCount in TrailingStringsOption.constructor")}get length(){return this._strings.length}parse(t,e){this._strings.push(t),this.set();for(const t of e){if(t.startsWith("-"))throw new u.$g("Cannot have named option after parsing a trailing path");this._strings.push(t)}return[]}get strings(){return this._strings}_strings=[]}class E{parse(t){let e=t.slice();const s=this._getStrings();for(;e.length>0;){const t=e.shift();if(t.startsWith("-")&&t.length>1)if(t.startsWith("--")){const s=t.slice(2);e=this._findByLongName(s).parse(t,e)}else{const s=t.slice(1);e=this._findByShortName(s).parse(t,e)}else{if(null===s)throw new u.$g(`Unrecognised option: '${t}'`);e=s.parse(t,e)}}if(s&&s.length<s.minCount)throw new u.$g("Insufficient trailing strings options specified");return this}writeHelp(t){for(const e of this._help())t.write(`${e}\n`)}_findByLongName(t){let e;for(e of Object.values(this))if(e.longName===t)return e;throw new u.$g(`No such longName option '${t}'`)}_findByShortName(t){let e;for(e of Object.values(this))if(e.shortName===t)return e;throw new u.$g(`No such shortName option '${t}'`)}_getStrings(){return"trailingStrings"in this?this.trailingStrings:null}_help(){return[...Object.values(this)].sort(((t,e)=>t.name>e.name?1:-1)).map((t=>{const e=t.prefixedName,s=Math.max(1,12-e.length);return`    ${e}${" ".repeat(s)}${t.description}`}))}}class T extends E{trailingStrings=new B(0)}class $ extends O{get name(){return"alias"}async _run(t){const{aliases:e,args:s,stdout:n}=t,r=(new T).parse(s);if(r.trailingStrings.isSet)for(const t of r.trailingStrings.strings){const s=t.indexOf("=");-1===s?n.write(`${t}='${e.get(t)}'\n`):e.set(t.slice(0,s),t.slice(s+1))}else for(const[t,s]of e.entries())n.write(`${t}='${s}'\n`);return d.y.SUCCESS}}class Q extends E{trailingStrings=new B(0)}class W extends O{get name(){return"cd"}async _run(t){const{args:e}=t,s=(new Q).parse(e).trailingStrings.strings;if(s.length<1)return d.y.SUCCESS;if(s.length>1)throw new u.$g("cd: too many arguments");let n=s[0];if("-"===n){const e=t.environment.get("OLDPWD");if(void 0===e)throw new u.$g("cd: OLDPWD not set");n=e,t.stdout.write(`${n}\n`)}const{FS:r}=t.fileSystem,i=r.cwd();return r.chdir(n),t.environment.set("OLDPWD",i),t.environment.set("PWD",r.cwd()),d.y.SUCCESS}}class D extends O{get name(){return"clear"}async _run(t){const{stdout:e}=t;return e.supportsAnsiEscapes()&&e.write(h.Q.eraseScreen+h.Q.eraseSavedLines+h.Q.cursorHome),d.y.SUCCESS}}class F extends E{version=new M("v","version","show cockle version");package=new L("p","package","show package information");module=new L("m","module","show module information");command=new L("c","command","show command information");help=new M("h","help","display this help and exit")}class P extends O{get name(){return"cockle-config"}async _run(t){const{args:e,stdout:s}=t,n=(new F).parse(e);if(n.help.isSet)n.writeHelp(s);else{const s=0===e.length;(s||n.version.isSet)&&this._writeVersion(t),(s||n.package.isSet)&&this._writePackageConfig(t,n.package.string),(s||n.module.isSet)&&this._writeModuleConfig(t,n.module.string),n.command.isSet&&this._writeCommandConfig(t,n.command.string)}return d.y.SUCCESS}_writeCommandConfig(t,e){const{commandRegistry:s,stdout:n}=t,r=void 0===e?s.allCommands():[e],i=[["command","module"]];for(const t of r){const e=s.get(t);if(null===e)throw new u.$g(`Unknown command '${t}'`);i.push([t,e.moduleName])}let o=null;n.supportsAnsiEscapes()&&(o=new Map,o.set(1,h.Q.styleBrightBlue));for(const t of C(i,1,!1,o))n.write(t+"\n")}_writeModuleConfig(t,e){const{commandRegistry:s,stdout:n,commandModuleCache:r}=t;let i=s.allModules();if(void 0!==e&&(i=i.filter((t=>t.name===e)),0===i.length))throw new u.$g(`Unknown module '${e}'`);const o=[["module","package","cached"]];for(const t of i)o.push([t.name,t.packageName,r.has(t.packageName,t.name)?"yes":""]);let a=null;n.supportsAnsiEscapes()&&(a=new Map,a.set(1,h.Q.styleBrightBlue),a.set(2,h.Q.styleBrightPurple));for(const t of C(o,1,!1,a))n.write(t+"\n")}_writePackageConfig(t,e){const{commandRegistry:s,stdout:n}=t;let r=[...s.commandPackageMap.values()];if(void 0!==e&&(r=r.filter((t=>t.name===e)),0===r.length))throw new u.$g(`Unknown package '${e}'`);const i=[["package","type","version","build string","source"]];for(const t of r)i.push([t.name,t.wasm?"wasm":"js",t.version,t.build_string,t.channel]);let o=null;n.supportsAnsiEscapes()&&(o=new Map,o.set(1,h.Q.styleBrightBlue),o.set(2,h.Q.styleBrightPurple),o.set(3,h.Q.styleGreen),o.set(4,h.Q.styleYellow));for(const t of C(i,1,!1,o))n.write(t+"\n")}_writeVersion(t){const{stdout:e}=t;e.write("cockle 0.0.19\n")}}class U extends O{get name(){return"exit"}async _run(t){const{stdout:e,terminate:s}=t;return e.write("Terminating shell...\n"),e.flush(),s(),d.y.SUCCESS}}class j extends E{trailingStrings=new B(0)}class z extends O{get name(){return"export"}async _run(t){const{args:e,environment:s}=t,n=(new j).parse(e);if(n.trailingStrings.isSet)for(const t of n.trailingStrings.strings){const e=t.indexOf("=");if(e>0){const n=t.slice(0,e),r=t.slice(e+1);s.set(n,r)}}return d.y.SUCCESS}}class G extends E{clear=new M("c","","clear the history by deleting all of the entries");help=new M("","help","display this help and exit")}class H extends O{get name(){return"history"}async _run(t){const{args:e,history:s,stdout:n}=t,r=(new G).parse(e);return r.help.isSet?r.writeHelp(n):r.clear.isSet?s.clear():s.write(n),d.y.SUCCESS}}class X{constructor(){this.registerBuiltinCommands(n)}allCommands(){const t=Array.from(this._map.keys());return t.sort(),t}allModules(){const t=[];for(const e of this.commandPackageMap.values())t.push(...e.modules);return t.sort(((t,e)=>t.name<e.name?-1:1)),t}get(t){return this._map.get(t)??null}match(t){return[...this._map.keys()].filter((e=>e.startsWith(t))).sort()}registerBuiltinCommands(t){for(const[e,s]of Object.entries(t))if(e.endsWith("Command")&&!e.startsWith("Builtin"))try{const t=new s;t instanceof O&&this._register(t)}catch{}}registerCommandPackage(t){this.commandPackageMap.set(t.name,t);for(const e of t.modules)this._register(e.runner)}_register(t){for(const e of t.names())this._map.set(e,t)}_map=new Map;commandPackageMap=new Map}class Y{options;constructor(t){this.options=t,this._environment=new c(t.color),this._commandModuleLoader=new I(t.wasmBaseUrl,t.downloadModuleCallback),this._commandRegistry=new X}get aliases(){return this._aliases}get environment(){return this._environment}get history(){return this._history}async initialize(){await this._initWasmPackages(),await this._initFileSystem()}async input(t){if(this._isRunning)switch(t.charCodeAt(0)){case 13:{this.output("\n");const t=this._currentLine;this._currentLine="",this._cursorIndex=0,await this._runCommands(t),this._outputPrompt();break}case 127:if(this._cursorIndex>0){const t=this._currentLine.slice(this._cursorIndex);this._currentLine=this._currentLine.slice(0,this._cursorIndex-1)+t,this._cursorIndex--,this.output(h.Q.cursorLeft(1)+t+h.Q.eraseEndLine+h.Q.cursorLeft(t.length))}break;case 9:await this._tabComplete();break;case 27:this._escapedInput(t);break;case 4:break;default:if(this._cursorIndex===this._currentLine.length)this._currentLine+=t,this.output(t);else{const e=this._currentLine.slice(this._cursorIndex);this._currentLine=this._currentLine.slice(0,this._cursorIndex)+t+e,this.output(h.Q.eraseEndLine+t+e+h.Q.cursorLeft(e.length))}this._cursorIndex++}}output(t){this._isRunning&&this.options.workerIO.write(t)}async setSize(t,e){const{environment:s}=this;t>=1?s.set("LINES",t.toString()):s.delete("LINES"),e>=1?s.set("COLUMNS",e.toString()):s.delete("COLUMNS")}async start(){this._isRunning=!0,await this._outputPrompt()}terminate(){console.log("Cockle ShellImpl.terminate"),this._isRunning=!1,this.options.terminateCallback()}async _escapedInput(t){const e=t.slice(1);switch(e){case"[A":case"[1A":case"[B":case"[1B":{const t=this._history.scrollCurrent(e.endsWith("B"));this._currentLine=null!==t?t:"",this._cursorIndex=this._currentLine.length,this.output(h.Q.eraseStartLine+`\r${this._environment.getPrompt()}${this._currentLine}`);break}case"[D":case"[1D":this._cursorIndex>0&&(this._cursorIndex--,this.output(h.Q.cursorLeft()));break;case"[C":case"[1C":this._cursorIndex<this._currentLine.length&&(this._cursorIndex++,this.output(h.Q.cursorRight()));break;case"[3~":if(this._cursorIndex<this._currentLine.length){const t=this._currentLine.slice(this._cursorIndex+1);this._currentLine=this._currentLine.slice(0,this._cursorIndex)+t,this.output(h.Q.eraseEndLine+t+h.Q.cursorLeft(t.length))}break;case"[H":case"[1;2H":this._cursorIndex>0&&(this.output(h.Q.cursorLeft(this._cursorIndex)),this._cursorIndex=0);break;case"[F":case"[1;2F":{const{length:t}=this._currentLine;this._cursorIndex<t&&(this.output(h.Q.cursorRight(t-this._cursorIndex)),this._cursorIndex=t);break}case"[1;2D":case"[1;5D":if(this._cursorIndex>0){const t=this._currentLine.slice(0,this._cursorIndex).trimEnd().lastIndexOf(" ")+1;this.output(h.Q.cursorLeft(this._cursorIndex-t)),this._cursorIndex=t}break;case"[1;2C":case"[1;5C":{const{length:t}=this._currentLine;if(this._cursorIndex<t-1){const e=this._currentLine.slice(this._cursorIndex),s=e.trimStart(),n=s.indexOf(" "),r=n<0?t:this._cursorIndex+e.length-s.length+n;this.output(h.Q.cursorRight(r-this._cursorIndex)),this._cursorIndex=r}break}}}_filenameExpansion(t){let e=[],s=0;for(const n of t){if(n.startsWith("-")){s++,e.push(n);continue}if(!n.includes("*")&&!n.includes("?")){e.push(n);continue}const{FS:t}=this._fileSystem,r=t.analyzePath(n,!1);if(!r.parentExists){e.push(n);continue}const i=r.parentPath;let o=i;const a=t.cwd();o.startsWith(a)&&(o=o.slice(a.length),o.startsWith("/")&&(o=o.slice(1)));let l=t.readdir(i),h=r.name.replace(/[.+^${}()|[\]\\]/g,"\\$&");h=h.replaceAll("*",".*"),h=h.replaceAll("?",".");const c=new RegExp(`^${h}$`);l=l.filter((t=>t.match(c))),l=l.filter((t=>!t.startsWith("."))),o.length>0&&(l=l.map((t=>o+"/"+t))),e=e.concat(l)}return e.length===s&&(e=t),e}async _initFileSystem(){const{wasmBaseUrl:t}=this.options,e=this._commandModuleLoader.getWasmModule("cockle_fs","fs");if(void 0===e)return void console.error("Unable to load cockle_fs, shell cannot function");const s=await e({locateFile:e=>t+"cockle_fs/"+e}),{FS:n,PATH:r,ERRNO_CODES:i,PROXYFS:o}=s,a=this.options.mountpoint??"/drive";n.mkdirTree(a,511),this._fileSystem={FS:n,PATH:r,ERRNO_CODES:i,PROXYFS:o,mountpoint:a};const{browsingContextId:l,driveFsBaseUrl:h,initialDirectories:c,initialFiles:u}=this.options;this.options.initDriveFSCallback({browsingContextId:l,driveFsBaseUrl:h,fileSystem:this._fileSystem,mountpoint:a}),n.chdir(a),this._environment.set("PWD",n.cwd()),c&&c.forEach((t=>n.mkdir(t,509))),u&&Object.entries(u).forEach((([t,e])=>n.writeFile(t,e,{mode:436})))}async _initWasmPackages(){const t=this.options.wasmBaseUrl+"cockle-config.json",e=await fetch(t);e.ok||console.error(`Failed to fetch ${t}, terminal cannot function without it`);const s=await e.json(),n=Object.keys(s.packages),r="cockle_fs";n.includes(r)||console.error(`cockle-config.json does not include required package '${r}'`);for(const t of n){const e=s.packages[t],n=Object.entries(e.modules).map((([s,n])=>new v(this._commandModuleLoader,s,n.commands?n.commands.split(","):[],t,e.wasm))),r=new A(t,e.version,e.build_string,e.channel,e.platform,e.wasm,n);this._commandRegistry.registerCommandPackage(r)}if(Object.hasOwn(s,"aliases"))for(const[t,e]of Object.entries(s.aliases)){const s=e;s.length>0&&this._aliases.set(t,s)}}_outputPrompt(){this._isRunning&&this.options.workerIO.write(`\n${this.environment.getPrompt()}`)}async _runCommands(t){if(this.options.enableBufferedStdinCallback(!0),this.options.workerIO.allowAdjacentNewline(!0),t.startsWith("!")){const e=parseInt(t.slice(1)),s=this._history.at(e);if(null===s){let t="!"+e+": event not found";return this.options.color&&(t=h.Q.styleBoldRed+t+h.Q.styleReset),this.output(`${t}\n`),void this._outputPrompt()}t=s}let e;this._history.add(t);const s=new _.d(this.options.stdinCallback,this.options.stdinAsyncCallback),n=new f.m(this.output.bind(this)),r=new f.m(this.output.bind(this),this.options.color?h.Q.styleBoldRed:null,this.options.color?h.Q.styleReset:null);try{const i=(0,y.qg)(t,!0,this._aliases);for(const t of i)if(t instanceof y.Sv)e=await this._runCommand(t,s,n,r);else{if(!(t instanceof y.Ru))throw new u.$g(`Expected CommandNode or PipeNode not ${t}`);{const{commands:e}=t,i=e.length;let o;for(let t=0;t<i;t++){const a=0===t?s:o.input,l=t<i-1?o=new p.n:n;await this._runCommand(e[t],a,l,r)}}}}catch(t){t instanceof u.Ge&&(e=t.exitCode),r.write(t+"\n"),r.flush()}finally{e=e??d.y.GENERAL_ERROR,this.environment.set("?",`${e}`),this.options.workerIO.allowAdjacentNewline(!1),this.options.enableBufferedStdinCallback(!1)}}async _runCommand(t,e,s,n){const r=t.name.value,i=this._commandRegistry.get(r);if(null===i)throw new u.xZ(r);if(t.redirects){if(t.redirects.length>1)throw new u.$g("Only implemented a single redirect per command");const n=t.redirects[0],r=n.token.value,i=n.target.value;if(">"===r||">>"===r)s=new g.M(this._fileSystem,i,">>"===r);else{if("<"!==r)throw new u.$g("Unrecognised redirect "+r);e=new w.z(this._fileSystem,i)}}let o=t.suffix.map((t=>t.value));o=this._filenameExpansion(o);const{aliases:a,environment:l,history:h}=this,c={args:o,fileSystem:this._fileSystem,aliases:a,commandRegistry:this._commandRegistry,environment:l,history:h,terminate:this.terminate.bind(this),stdin:e,stdout:s,stderr:n,workerIO:this.options.workerIO,commandModuleCache:this._commandModuleLoader.cache},d=await i.run(r,c);return n.flush(),s.flush(),d}async _tabComplete(){const t=this._currentLine.slice(0,this._cursorIndex);if(t.endsWith(" ")&&t.trim().length>0)return;const e=this._currentLine.slice(this._cursorIndex),s=(0,y.qg)(t,!1),[n,r]=s.length>0?s[s.length-1].lastToken():[null,!0];let i=n?.value??"",o=[];if(r){const t=this._commandRegistry.match(i),e=this._aliases.match(i);o=[...new Set([...t,...e])].sort()}else{const{FS:t}=this._fileSystem,e=t.analyzePath(i,!1);if(!e.parentExists)return;const s=i;i=e.name;const{exists:n}=e;if(n&&!t.isDir(t.stat(e.path,!1).mode))o=[i];else{const r=n?e.path:e.parentPath;o=t.readdir(r),n?"."===s||".."===s||s.endsWith("/.")||s.endsWith("/..")?o=o.filter((t=>t.startsWith("."))):(o=o.filter((t=>!t.startsWith("."))),s.endsWith("/")||(this._currentLine+="/")):o=o.filter((t=>t.startsWith(i))),o=o.map((e=>t.isDir(t.stat(r+"/"+e,!1).mode)?e+"/":e))}}if(1===o.length){let t=o[0].slice(i.length);t.endsWith("/")||(t+=" "),this._currentLine=this._currentLine.slice(0,this._cursorIndex)+t+e,this._cursorIndex+=t.length,this.output(t+e+h.Q.cursorLeft(e.length))}else if(o.length>1){const t=function(t,e=0){if(t.length<1)return"";const s=Math.min(...t.map((t=>t.length))),n=t[0];let r=e;for(;r<s&&t.every((t=>t[r]===n[r]));)r++;return n.slice(0,r)}(o,i.length);if(t.length>i.length){const s=t.slice(i.length);this._currentLine=this._currentLine.slice(0,this._cursorIndex)+s+e,this._cursorIndex+=s.length,this.output(s+e+h.Q.cursorLeft(e.length))}else{const t=`\n${function(t,e){if(t.length<1)return[];if(e<1)return[t.join("  ")];const s=t.length,n=Math.max(...t.map((t=>t.length))),r=Math.min(Math.floor(e/(n+2)),s),i=Math.ceil(s/r),o=[];for(let e=0;e<i;++e){let a="";for(let o=0;o<r;++o){const r=o*i+e;if(r>=s)continue;const l=t[r];a+=l,r+i<s&&(a+=" ".repeat(n+2-l.length))}o.push(a)}return o}(o,this._environment.getNumber("COLUMNS")??0).join("\n")}\n${this._environment.getPrompt()}${this._currentLine}`;this.output(t+h.Q.cursorLeft(e.length))}}}_currentLine="";_cursorIndex=0;_isRunning=!1;_aliases=new l.D;_commandRegistry;_environment;_history=new m;_commandModuleLoader;_fileSystem}class q{async initialize(t,e,s,n,r){console.log("Cockle BaseShellWorker.initialize"),this._workerIO=new a(t.sharedArrayBuffer,n),this._downloadModuleCallback=e,this._enableBufferedStdinCallback=s,this._terminateCallback=r;const{color:i,mountpoint:o,wasmBaseUrl:l,driveFsBaseUrl:h,browsingContextId:c,initialDirectories:u,initialFiles:d}=t;this._shellImpl=new Y({color:i,mountpoint:o,wasmBaseUrl:l,driveFsBaseUrl:h,browsingContextId:c,initialDirectories:u,initialFiles:d,downloadModuleCallback:this._downloadModuleCallback.bind(this),enableBufferedStdinCallback:this.enableBufferedStdin.bind(this),initDriveFSCallback:this.initDriveFS.bind(this),terminateCallback:this._terminateCallback.bind(this),stdinCallback:this._workerIO.read.bind(this._workerIO),stdinAsyncCallback:this._workerIO.readAsync.bind(this._workerIO),workerIO:this._workerIO}),await this._shellImpl.initialize()}async enableBufferedStdin(t){this._workerIO&&(t?await this._workerIO.enable():await this._workerIO.disable()),this._enableBufferedStdinCallback&&await this._enableBufferedStdinCallback(t)}async input(t){this._shellImpl&&await this._shellImpl.input(t)}async setSize(t,e){this._shellImpl&&await this._shellImpl.setSize(t,e)}async start(){this._shellImpl&&await this._shellImpl.start()}_shellImpl;_workerIO;_downloadModuleCallback;_enableBufferedStdinCallback;_terminateCallback}},9685:(t,e,s)=>{s.d(e,{q:()=>i});var n,r=s(7095);function i(t,e=!0,s){const n=new o(t,e,s);return n.run(),n.tokens}!function(t){t[t.None=0]="None",t[t.Delimiter=1]="Delimiter",t[t.DoubleQuote=2]="DoubleQuote",t[t.SingleQuote=3]="SingleQuote",t[t.Whitespace=4]="Whitespace",t[t.Other=5]="Other"}(n||(n={}));class o{throwErrors;aliases;constructor(t,e,s){this.throwErrors=e,this.aliases=s,this._source=t,this._tokens=[]}run(){for(;this._index<=this._source.length;)this._next();if(this.throwErrors&&""!==this._endQuote)throw new r.$g("Tokenize error, expected end quote "+this._endQuote)}get tokens(){return this._tokens}_addToken(){const t=this._offset,e=this._value;if(void 0!==this.aliases&&t!==this._aliasOffset&&(0===this._tokens.length||";&|".includes(this._tokens.at(-1).value.at(-1)))){const s=this.aliases.getRecursive(e);if(void 0!==s){const r=e.length;return this._offset=-1,this._index=t-1,this._aliasOffset=t,this._source=this._source.slice(0,t)+s+this._source.slice(t+r),this._prevChar="",this._prevCharType=n.None,this._value="",this._endQuote="",!1}}return this._tokens.push({offset:t,value:e}),this._endQuote="",!0}_getCharType(t){return" ".includes(t)?n.Whitespace:";&|><".includes(t)?n.Delimiter:"'"===t?n.SingleQuote:'"'===t?n.DoubleQuote:n.Other}_endQuoteFromCharType(t){return t===n.DoubleQuote?'"':t===n.SingleQuote?"'":""}_next(){const t=++this._index,e=t<this._source.length?this._source[t]:" ";let s=this._getCharType(e);const r=this._endQuoteFromCharType(s);this._offset>=0?this._endQuote?e!==this._endQuote?this._value+=e:(this._endQuote="",s=n.Other):r?this._endQuote=r:s===n.Whitespace?this._addToken()&&(this._offset=-1):s!==this._prevCharType||s===n.Delimiter&&e!==this._prevChar?this._addToken()&&(this._offset=t,this._value=e):this._value+=e:s!==n.Whitespace&&(this._offset=t,this._endQuote=this._endQuoteFromCharType(s),this._value=""===this._endQuote?e:""),this._prevChar=e,this._prevCharType=s}_source;_tokens;_prevChar="";_prevCharType=n.None;_index=-1;_offset=-1;_aliasOffset=-1;_value="";_endQuote=""}}}]);