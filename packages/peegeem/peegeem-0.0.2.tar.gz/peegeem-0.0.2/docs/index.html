<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='read' hidden></marimo-mode>
    <marimo-version data-version='0.13.0' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"dataframes": "rich", "code_editor_font_size": 14, "default_width": "medium", "cell_output": "above", "default_table_page_size": 10, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "reactive_tests": true, "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "uv"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "full", "sql_output": "auto"}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>  init  </title>
    <script type="module" crossorigin src="./assets/index-B2CDK72T.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-CsvvdqXP.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.13.0%22%0Aapp%20%3D%20marimo.App(width%3D%22full%22)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%23%20Welcome%20to%20%60peegeem%60%20%0A%0A%20%20%20%20%20%20%20%20%3E%20The%20name%20should%20remind%20you%20of%20%22pgm%22.%0A%0A%20%20%20%20%20%20%20%20The%20whole%20point%20of%20the%20library%20is%20that%20you%20have%20an%20API%20to%20do%20stuff%20like%20this%3A%20%0A%0A%20%20%20%20%20%20%20%20%60%60%60python%0A%20%20%20%20%20%20%20%20from%20peegeem%20import%20DAG%0A%0A%20%20%20%20%20%20%20%20%23%20Define%20the%20DAG%20for%20the%20PGM%0A%20%20%20%20%20%20%20%20dag%20%3D%20DAG(nodes%2C%20edges%2C%20dataframe)%0A%0A%20%20%20%20%20%20%20%20%23%20Get%20variables%20out%0A%20%20%20%20%20%20%20%20outcome%2C%20smoker%2C%20age%20%3D%20dag.get_variables()%0A%0A%20%20%20%20%20%20%20%20%23%20Use%20variables%20to%20construct%20a%20probablistic%20query%0A%20%20%20%20%20%20%20%20P(outcome%20%7C%20(smoker%20%3D%3D%20%22Yes%22)%20%26%20(age%20%3E%2040))%0A%0A%20%20%20%20%20%20%20%20%23%20Latex%20utility%2C%20why%20not%3F%0A%20%20%20%20%20%20%20%20P.to_latex(outcome%20%7C%20(smoker%20%3D%3D%20%22Yes%22)%20%26%20(age%20%3E%2040))%0A%20%20%20%20%20%20%20%20%60%60%60%0A%0A%20%20%20%20%20%20%20%20The%20goal%20is%20to%20have%20an%20API%20that%20really%20closely%20mimics%20the%20math%20notation%2C%20so%20stuff%20like%20this%3A%0A%0A%20%20%20%20%20%20%20%20%24%24%20P(%5C%5Ctext%7Boutcome%7D%20%5C%5Cmid%20do(%5C%5Ctext%7Bsmoker%7D%3D%5C%5Ctexttt%7BYes%7D)%2C%20%5C%5Ctext%7Bage%7D%3E40)%20%24%24%0A%0A%20%20%20%20%20%20%20%20That%20means%20that%20we%20indeed%20also%20have%20a%20%60do%60%20function!%0A%0A%20%20%20%20%20%20%20%20%60%60%60python%20%0A%20%20%20%20%20%20%20%20%23%20You%20can%20also%20get%20crazy%20fancy%20%0A%20%20%20%20%20%20%20%20P(A%20%26%20B%20%7C%20C%20%26%20do(D))%0A%20%20%20%20%20%20%20%20%60%60%60%0A%0A%20%20%20%20%20%20%20%20But%20why%20stop%20there%3F%20Having%20a%20domain%20specific%20language%20is%20cool%2C%20but%20what%20if%20we'd%20be%20able%20to%20combine%20this%20with%20a%20domian%20specific%20interface%20as%20well%3F%0A%0A%20%20%20%20%20%20%20%20%23%23%20Demotime%0A%0A%20%20%20%20%20%20%20%20We%20use%20the%20%60smoking%60%20dataset%20here%20as%20a%20demonstration%20(%5Blink%5D(https%3A%2F%2Fcalmcode.io%2Fdatasets%2Fsmoking)).%20The%20dataset%20has%20three%20values%3A%20%0A%0A%20%20%20%20%20%20%20%20-%20**smoker**%20indicates%20if%20the%20person%20was%20a%20smoker%0A%20%20%20%20%20%20%20%20-%20**age**%20is%20the%20age%20of%20a%20person%0A%20%20%20%20%20%20%20%20-%20**outcome**%20represents%20if%20the%20person%20was%20still%20alive%2010%20years%20later%0A%0A%20%20%20%20%20%20%20%20These%20variables%20are%20all%20made%20discrete%20and%20you%20could%20draw%20a%20causal%20diagram%20if%20you%20wanted%20to.%20You%20can%20do%20that%20below.%20Draw%20edges%20in%20the%20graph%20view%20and%20see%20how%20the%20table%20and%20chart%20updates.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(P%2C%20age%2C%20alt%2C%20edge_draw%2C%20mo%2C%20outcome%2C%20pd%2C%20smoker)%3A%0A%20%20%20%20age_range%20%3D%20range(10%2C%2070%2C%2010)%0A%0A%20%20%20%20alive_smoke%20%3D%20%5B%0A%20%20%20%20%20%20%20%20P(outcome%20%7C%20(smoker%20%3D%3D%20%22Yes%22)%20%26%20(age%20%3E%20a))%5B0%5D%5B%22probability%22%5D%0A%20%20%20%20%20%20%20%20for%20a%20in%20age_range%0A%20%20%20%20%5D%0A%20%20%20%20alive_no_smoke%20%3D%20%5B%0A%20%20%20%20%20%20%20%20P(outcome%20%7C%20(smoker%20%3D%3D%20%22No%22)%20%26%20(age%20%3E%20a))%5B0%5D%5B%22probability%22%5D%0A%20%20%20%20%20%20%20%20for%20a%20in%20age_range%0A%20%20%20%20%5D%0A%0A%20%20%20%20df_out%20%3D%20pd.DataFrame(%7B%0A%20%20%20%20%20%20%20%20%22age%22%3A%20age_range%2C%20%0A%20%20%20%20%20%20%20%20%22smoke%22%3A%20alive_smoke%2C%20%0A%20%20%20%20%20%20%20%20%22no-smoke%22%3A%20alive_no_smoke%0A%20%20%20%20%7D)%0A%0A%20%20%20%20pltr%20%3D%20df_out.melt(%22age%22)%0A%0A%20%20%20%20chart_out%20%3D%20(%0A%20%20%20%20%20%20%20%20alt.Chart(pltr)%0A%20%20%20%20%20%20%20%20.mark_line()%0A%20%20%20%20%20%20%20%20.encode(x%3D%22age%22%2C%20y%3D%22value%22%2C%20color%3D%22variable%22)%0A%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22Probability%20of%20being%20alive%20after%2010%20years%22%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20width%3D200%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20height%3D200%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%0A%20%20%20%20mo.hstack(%5B%0A%20%20%20%20%20%20%20%20edge_draw%2C%20df_out%2C%20chart_out%0A%20%20%20%20%5D%2C%20align%3D%22stretch%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(df_smoking%2C%20mo)%3A%0A%20%20%20%20from%20wigglystuff%20import%20EdgeDraw%0A%0A%20%20%20%20edge_draw%20%3D%20mo.ui.anywidget(EdgeDraw(list(df_smoking.columns)))%0A%20%20%20%20return%20(edge_draw%2C)%0A%0A%0A%40app.cell%0Adef%20_(P%2C%20age%2C%20do%2C%20mo%2C%20outcome%2C%20smoker)%3A%0A%20%20%20%20mo.md(text%3D%22%24%24%22%20%2B%20P.to_latex(outcome%20%7C%20do(smoker%20%3D%3D%20%22Yes%22)%20%26%20(age%20%3E%2050))%20%2B%20%22%24%24%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(P%2C%20mo)%3A%0A%20%20%20%20import%20polars%20as%20pl%20%0A%0A%20%20%20%20def%20p(expr)%3A%20%0A%20%20%20%20%20%20%20%20return%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.md(f%22%24%24%20%7BP.to_latex(expr)%7D%20%24%3D%24%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.DataFrame(P(expr))%0A%20%20%20%20%20%20%20%20%5D)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20altair%20as%20alt%0A%20%20%20%20return%20(alt%2C)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell%0Adef%20_(DAG%2C%20df_smoking%2C%20edge_draw)%3A%0A%20%20%20%20dag%20%3D%20DAG(%0A%20%20%20%20%20%20%20%20nodes%3Dedge_draw.value%5B%22names%22%5D%2C%20%0A%20%20%20%20%20%20%20%20edges%3D%5B(_%5B'source'%5D%2C%20_%5B'target'%5D)%20for%20_%20in%20edge_draw.value%5B%22links%22%5D%5D%2C%0A%20%20%20%20%20%20%20%20dataframe%3Ddf_smoking%0A%20%20%20%20)%0A%20%20%20%20return%20(dag%2C)%0A%0A%0A%40app.cell%0Adef%20_(dag)%3A%0A%20%20%20%20outcome%2C%20smoker%2C%20age%20%3D%20dag.get_variables()%0A%20%20%20%20return%20age%2C%20outcome%2C%20smoker%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(NotImplementedi)%3A%0A%20%20%20%20%23%23%20Export%0A%0A%20%20%20%20import%20pandas%20as%20pd%0A%20%20%20%20from%20pgmpy.models%20import%20DiscreteBayesianNetwork%0A%20%20%20%20from%20pgmpy.estimators%20import%20MaximumLikelihoodEstimator%0A%20%20%20%20from%20pgmpy.inference%20import%20VariableElimination%2C%20CausalInference%20%23%20Use%20both%0A%20%20%20%20from%20pgmpy.factors.discrete%20import%20DiscreteFactor%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20from%20typing%20import%20Union%2C%20List%2C%20Any%2C%20Dict%2C%20Tuple%2C%20Optional%0A%20%20%20%20import%20itertools%0A%20%20%20%20import%20re%0A%0A%20%20%20%20%23%20Forward%20declaration%20for%20type%20hinting%0A%20%20%20%20class%20DAG%3A%20pass%0A%20%20%20%20class%20Variable%3A%20pass%0A%20%20%20%20class%20VariablCombination%3A%20pass%0A%20%20%20%20class%20Condition%3A%20pass%0A%20%20%20%20class%20QueryExpression%3A%20pass%0A%20%20%20%20class%20TargetStateQuery%3A%20pass%0A%20%20%20%20class%20DoCondition%3A%20pass%0A%20%20%20%20class%20DoRangeCondition%3A%20pass%0A%0A%20%20%20%20class%20Condition%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20standard%20evidence%20condition%20(e.g.%2C%20variable%20%3D%3D%20value).%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20variable_name%3A%20str%2C%20operator%3A%20str%2C%20value%3A%20Any%2C%20dag_instance%3A%20DAG)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.variable_name%20%3D%20variable_name%0A%20%20%20%20%20%20%20%20%20%20%20%20self.operator%20%3D%20operator%0A%20%20%20%20%20%20%20%20%20%20%20%20self.value%20%3D%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20self._dag%20%3D%20dag_instance%0A%0A%20%20%20%20%20%20%20%20def%20__repr__(self)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22Condition(%7Bself.variable_name%7D%20%7Bself.operator%7D%20%7Brepr(self.value)%7D)%22%0A%0A%20%20%20%20%20%20%20%20def%20__and__(self%2C%20other%3A%20Union%5B'Condition'%2C%20'DoCondition'%2C%20'DoRangeCondition'%2C%20List%5BAny%5D%5D)%20-%3E%20List%5BAny%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20valid_types%20%3D%20(Condition%2C%20DoCondition%2C%20DoRangeCondition)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20valid_types)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20self._dag%20is%20not%20other._dag%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Cannot%20combine%20conditions%2Finterventions%20from%20different%20DAG%20instances.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5Bself%2C%20other%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(other%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all((isinstance(c%2C%20valid_types)%20and%20c._dag%20is%20self._dag)%20for%20c%20in%20other)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Invalid%20item%20or%20DAG%20mismatch%20in%20condition%20list.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5Bself%5D%20%2B%20other%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20%20%20%20%20def%20__rand__(self%2C%20other%3A%20Union%5BAny%5D)%20-%3E%20List%5BAny%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20valid_types%20%3D%20(Condition%2C%20DoCondition%2C%20DoRangeCondition)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all((isinstance(c%2C%20valid_types)%20and%20c._dag%20is%20self._dag)%20for%20c%20in%20other)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Invalid%20item%20or%20DAG%20mismatch%20in%20condition%20list.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20other%20%2B%20%5Bself%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20class%20DoCondition%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20causal%20intervention%20condition%20(do(variable%20%3D%20value)).%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20variable_name%3A%20str%2C%20value%3A%20Any%2C%20dag_instance%3A%20DAG)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.variable_name%20%3D%20variable_name%0A%20%20%20%20%20%20%20%20%20%20%20%20self.value%20%3D%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20self._dag%20%3D%20dag_instance%0A%20%20%20%20%20%20%20%20%20%20%20%20self.operator%20%3D%20'do%3D%3D'%0A%0A%20%20%20%20%20%20%20%20def%20__repr__(self)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22Do(%7Bself.variable_name%7D%3D%7Brepr(self.value)%7D)%22%0A%0A%20%20%20%20%20%20%20%20def%20__and__(self%2C%20other%3A%20Union%5BCondition%2C%20'DoCondition'%2C%20'DoRangeCondition'%2C%20List%5BAny%5D%5D)%20-%3E%20List%5BAny%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20valid_types%20%3D%20(Condition%2C%20DoCondition%2C%20DoRangeCondition)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20valid_types)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20self._dag%20is%20not%20other._dag%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Cannot%20combine%20conditions%2Finterventions%20from%20different%20DAG%20instances.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5Bself%2C%20other%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(other%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all((isinstance(c%2C%20valid_types)%20and%20c._dag%20is%20self._dag)%20for%20c%20in%20other)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Invalid%20item%20or%20DAG%20mismatch%20in%20condition%20list.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5Bself%5D%20%2B%20other%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20%20%20%20%20def%20__rand__(self%2C%20other%3A%20Union%5BAny%5D)%20-%3E%20List%5BAny%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20valid_types%20%3D%20(Condition%2C%20DoCondition%2C%20DoRangeCondition)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all((isinstance(c%2C%20valid_types)%20and%20c._dag%20is%20self._dag)%20for%20c%20in%20other)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Invalid%20item%20or%20DAG%20mismatch%20in%20condition%20list.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20other%20%2B%20%5Bself%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20class%20DoRangeCondition%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20causal%20'intervention'%20specified%20by%20a%20range%20(e.g.%2C%20do(age%20%3E%2040)).%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20variable_name%3A%20str%2C%20operator%3A%20str%2C%20value%3A%20Any%2C%20dag_instance%3A%20DAG)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.variable_name%20%3D%20variable_name%20%0A%20%20%20%20%20%20%20%20%20%20%20%20self.operator%20%3D%20operator%20%0A%20%20%20%20%20%20%20%20%20%20%20%20self.value%20%3D%20value%20%0A%20%20%20%20%20%20%20%20%20%20%20%20self._dag%20%3D%20dag_instance%0A%0A%20%20%20%20%20%20%20%20def%20__repr__(self)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22DoRange(%7Bself.variable_name%7D%20%7Bself.operator%7D%20%7Brepr(self.value)%7D)%22%0A%0A%20%20%20%20%20%20%20%20def%20__and__(self%2C%20other%3A%20Union%5BCondition%2C%20DoCondition%2C%20'DoRangeCondition'%2C%20List%5BAny%5D%5D)%20-%3E%20List%5BAny%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20valid_types%20%3D%20(Condition%2C%20DoCondition%2C%20DoRangeCondition)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20valid_types)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20self._dag%20is%20not%20other._dag%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Cannot%20combine%20conditions%2Finterventions%20from%20different%20DAG%20instances.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5Bself%2C%20other%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(other%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all((isinstance(c%2C%20valid_types)%20and%20c._dag%20is%20self._dag)%20for%20c%20in%20other)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Invalid%20item%20or%20DAG%20mismatch%20in%20condition%20list.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5Bself%5D%20%2B%20other%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20%20%20%20%20def%20__rand__(self%2C%20other%3A%20Union%5BAny%5D)%20-%3E%20List%5BAny%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20valid_types%20%3D%20(Condition%2C%20DoCondition%2C%20DoRangeCondition)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20list)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all((isinstance(c%2C%20valid_types)%20and%20c._dag%20is%20self._dag)%20for%20c%20in%20other)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Invalid%20item%20or%20DAG%20mismatch%20in%20condition%20list.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20other%20%2B%20%5Bself%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20def%20do(condition_obj%3A%20Condition)%20-%3E%20Union%5BDoCondition%2C%20DoRangeCondition%5D%3A%0A%20%20%20%20%20%20%20%20%22%22%22Creates%20a%20DoCondition%20or%20DoRangeCondition%20for%20causal%20intervention%2Ffiltering.%22%22%22%0A%20%20%20%20%20%20%20%20if%20not%20isinstance(condition_obj%2C%20Condition)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22Argument%20to%20do()%20must%20be%20a%20condition%20created%20from%20a%20Variable%20(e.g.%2C%20variable%20%3D%3D%20value%2C%20variable%20%3E%2040).%22)%0A%20%20%20%20%20%20%20%20if%20condition_obj.operator%20%3D%3D%20'%3D%3D'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20DoCondition(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20variable_name%3Dcondition_obj.variable_name%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%3Dcondition_obj.value%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dag_instance%3Dcondition_obj._dag%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20elif%20condition_obj.operator%20in%20%5B'!%3D'%2C%20'%3E'%2C%20'%3E%3D'%2C%20'%3C'%2C%20'%3C%3D'%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20return%20DoRangeCondition(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20variable_name%3Dcondition_obj.variable_name%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20operator%3Dcondition_obj.operator%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20value%3Dcondition_obj.value%2C%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20dag_instance%3Dcondition_obj._dag%0A%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20else%3A%20raise%20ValueError(f%22Unsupported%20operator%20'%7Bcondition_obj.operator%7D'%20passed%20to%20do().%22)%0A%0A%0A%20%20%20%20class%20VariableCombination%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20combination%20of%20multiple%20variables%20for%20joint%20probability%20queries.%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20variables%3A%20List%5BVariable%5D)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20variables%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22VariableCombination%20cannot%20be%20empty.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20first_dag%20%3D%20variables%5B0%5D._dag%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all(isinstance(v%2C%20Variable)%20and%20v._dag%20is%20first_dag%20for%20v%20in%20variables)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22All%20items%20must%20be%20Variables%20from%20the%20same%20DAG.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.variables%20%3D%20list(dict.fromkeys(variables))%0A%20%20%20%20%20%20%20%20%20%20%20%20self._dag%20%3D%20first_dag%0A%0A%20%20%20%20%20%20%20%20def%20__repr__(self)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22VariableCombination(%5B%7B'%2C%20'.join(v.name%20for%20v%20in%20self.variables)%7D%5D)%22%0A%0A%20%20%20%20%20%20%20%20def%20__and__(self%2C%20other%3A%20Union%5BVariable%2C%20'VariableCombination'%5D)%20-%3E%20'VariableCombination'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20other._dag%20is%20not%20self._dag%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Cannot%20combine%20variables%20from%20different%20DAGs.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20VariableCombination(self.variables%20%2B%20%5Bother%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(other%2C%20VariableCombination)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20other._dag%20is%20not%20self._dag%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Cannot%20combine%20variables%20from%20different%20DAGs.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20VariableCombination(self.variables%20%2B%20other.variables)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplementedi%0A%0A%20%20%20%20%20%20%20%20def%20__rand__(self%2C%20other%3A%20Variable)%20-%3E%20'VariableCombination'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20other._dag%20is%20not%20self._dag%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Cannot%20combine%20variables%20from%20different%20DAGs.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20VariableCombination(%5Bother%5D%20%2B%20self.variables)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20%20%20%20%20def%20__or__(self%2C%20conditions%3A%20Union%5BCondition%2C%20DoCondition%2C%20DoRangeCondition%2C%20List%5BAny%5D%5D)%20-%3E%20'QueryExpression'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20QueryExpression(target%3Dself%2C%20conditions%3Dconditions)%0A%0A%0A%20%20%20%20class%20TargetStateQuery%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20query%20for%20the%20probability%20of%20a%20specific%20state%20of%20a%20variable.%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20variable%3A%20Variable%2C%20state%3A%20Any)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.variable%20%3D%20variable%0A%20%20%20%20%20%20%20%20%20%20%20%20processed_state%2C%20_%20%3D%20variable._process_value_for_state_check(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.state%20%3D%20processed_state%20%0A%20%20%20%20%20%20%20%20%20%20%20%20self._dag%20%3D%20variable._dag%0A%0A%20%20%20%20%20%20%20%20def%20__repr__(self)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22TargetStateQuery(%7Bself.variable.name%7D%20%3D%3D%20%7Brepr(self.state)%7D)%22%0A%0A%20%20%20%20%20%20%20%20def%20__or__(self%2C%20conditions%3A%20Union%5BCondition%2C%20DoCondition%2C%20DoRangeCondition%2C%20List%5BAny%5D%5D)%20-%3E%20'QueryExpression'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Creates%20query%20P(var%20%3D%3D%20state%20%7C%20conditions%2Finterventions).%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20QueryExpression(target%3Dself%2C%20conditions%3Dconditions)%0A%0A%0A%20%20%20%20class%20Variable%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20variable%20(node)%20in%20the%20DAG%20with%20overloaded%20operators.%20Made%20hashable.%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20name%3A%20str%2C%20dag_instance%3A%20DAG)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20self.name%20%3D%20name%3B%20self._dag%20%3D%20dag_instance%0A%0A%20%20%20%20%20%20%20%20def%20__repr__(self)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22Variable(%7Bself.name%7D)%22%0A%0A%20%20%20%20%20%20%20%20def%20__str__(self)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.name%0A%0A%20%20%20%20%20%20%20%20def%20is_(self%2C%20value%3A%20Any)%20-%3E%20TargetStateQuery%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20TargetStateQuery(self%2C%20value)%0A%0A%20%20%20%20%20%20%20%20def%20__eq__(self%2C%20other%3A%20object)%20-%3E%20Union%5Bbool%2C%20Condition%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20self.name%20%3D%3D%20other.name%20and%20self._dag%20is%20other._dag%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20processed_value%2C%20_%20%3D%20self._process_value_for_state_check(other)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20Condition(self.name%2C%20'%3D%3D'%2C%20processed_value%2C%20self._dag)%0A%0A%20%20%20%20%20%20%20%20def%20__ne__(self%2C%20other%3A%20object)%20-%3E%20Condition%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22'!%3D'%20between%20Variable%20objects%20not%20supported.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20processed_value%2C%20_%20%3D%20self._process_value_for_state_check(other)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20Condition(self.name%2C%20'!%3D'%2C%20processed_value%2C%20self._dag)%0A%0A%20%20%20%20%20%20%20%20def%20__gt__(self%2C%20other%3A%20object)%20-%3E%20Condition%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22'%3E'%20between%20Variable%20objects%20not%20supported.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20processed_value%2C%20is_numeric%20%3D%20self._process_value_for_state_check(other)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20is_numeric%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Applying%20'%3E'%20to%20non-numeric%20value%20'%7Brepr(other)%7D'%20for%20variable%20'%7Bself.name%7D'.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20Condition(self.name%2C%20'%3E'%2C%20processed_value%2C%20self._dag)%0A%0A%20%20%20%20%20%20%20%20def%20__ge__(self%2C%20other%3A%20object)%20-%3E%20Condition%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22'%3E%3D'%20between%20Variable%20objects%20not%20supported.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20processed_value%2C%20is_numeric%20%3D%20self._process_value_for_state_check(other)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20is_numeric%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Applying%20'%3E%3D'%20to%20non-numeric%20value%20'%7Brepr(other)%7D'%20for%20variable%20'%7Bself.name%7D'.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20Condition(self.name%2C%20'%3E%3D'%2C%20processed_value%2C%20self._dag)%0A%0A%20%20%20%20%20%20%20%20def%20__lt__(self%2C%20other%3A%20object)%20-%3E%20Condition%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22'%3C'%20between%20Variable%20objects%20not%20supported.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20processed_value%2C%20is_numeric%20%3D%20self._process_value_for_state_check(other)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20is_numeric%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Applying%20'%3C'%20to%20non-numeric%20value%20'%7Brepr(other)%7D'%20for%20variable%20'%7Bself.name%7D'.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20Condition(self.name%2C%20'%3C'%2C%20processed_value%2C%20self._dag)%0A%0A%20%20%20%20%20%20%20%20def%20__le__(self%2C%20other%3A%20object)%20-%3E%20Condition%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22'%3C%3D'%20between%20Variable%20objects%20not%20supported.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20processed_value%2C%20is_numeric%20%3D%20self._process_value_for_state_check(other)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20is_numeric%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Applying%20'%3C%3D'%20to%20non-numeric%20value%20'%7Brepr(other)%7D'%20for%20variable%20'%7Bself.name%7D'.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20Condition(self.name%2C%20'%3C%3D'%2C%20processed_value%2C%20self._dag)%0A%0A%20%20%20%20%20%20%20%20def%20_process_value_for_state_check(self%2C%20value%3A%20Any)%20-%3E%20Tuple%5BAny%2C%20bool%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20is_numeric%20%3D%20isinstance(value%2C%20(int%2C%20float))%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20hasattr(self._dag%2C%20'model')%20or%20not%20hasattr(self._dag%2C%20'_bool_cols')%3A%20raise%20AttributeError(%22DAG%20model%20not%20fully%20initialized.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20processed_value%20%3D%20str(value)%20if%20self.name%20in%20self._dag._bool_cols%20else%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20processed_value%2C%20is_numeric%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Could%20not%20fully%20process%2Fverify%20value%20'%7Brepr(value)%7D'%20for%20var%20'%7Bself.name%7D'%3A%20%7Be%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20value%2C%20is_numeric%0A%0A%20%20%20%20%20%20%20%20def%20__or__(self%2C%20conditions%3A%20Union%5BCondition%2C%20DoCondition%2C%20DoRangeCondition%2C%20List%5BAny%5D%5D)%20-%3E%20'QueryExpression'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Creates%20a%20query%20expression%20using%20'%7C'%20for%20'given'%3A%20target%20%7C%20conditions%2Finterventions.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20QueryExpression(target%3Dself%2C%20conditions%3Dconditions)%0A%0A%20%20%20%20%20%20%20%20def%20__and__(self%2C%20other%3A%20Union%5BVariable%2C%20VariableCombination%5D)%20-%3E%20VariableCombination%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(other%2C%20Variable)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20other._dag%20is%20not%20self._dag%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Cannot%20combine%20variables%20from%20different%20DAGs.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20VariableCombination(%5Bself%2C%20other%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(other%2C%20VariableCombination)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20other.__rand__(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20NotImplemented%0A%0A%20%20%20%20%20%20%20%20def%20__hash__(self)%20-%3E%20int%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20hash(self.name)%0A%0A%0A%20%20%20%20class%20QueryExpression%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20probability%20query%20expression%20with%20potential%20interventions.%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20target%3A%20Union%5BVariable%2C%20VariableCombination%2C%20TargetStateQuery%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20conditions%3A%20Union%5BCondition%2C%20DoCondition%2C%20DoRangeCondition%2C%20List%5BAny%5D%5D)%3A%20%23%20Accept%20list%20of%20Any%20and%20validate%20below%0A%20%20%20%20%20%20%20%20%20%20%20%20self.target%20%3D%20target%0A%20%20%20%20%20%20%20%20%20%20%20%20self._dag%20%3D%20target._dag%0A%20%20%20%20%20%20%20%20%20%20%20%20valid_cond_types%20%3D%20(Condition%2C%20DoCondition%2C%20DoRangeCondition)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(conditions%2C%20valid_cond_types)%3A%20self.conditions%20%3D%20%5Bconditions%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(conditions%2C%20list)%3A%20self.conditions%20%3D%20conditions%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20raise%20TypeError(f%22Conditions%20must%20be%20Condition%2C%20DoCondition%2C%20DoRangeCondition%20or%20list%20thereof%2C%20got%20%7Btype(conditions)%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all(isinstance(c%2C%20valid_cond_types)%20and%20c._dag%20is%20self._dag%20for%20c%20in%20self.conditions)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22All%20conditions%2Finterventions%20must%20be%20valid%20types%20and%20belong%20to%20the%20same%20DAG%20as%20the%20target.%22)%0A%20%20%20%20%20%20%20%20%40property%0A%20%20%20%20%20%20%20%20def%20target_names(self)%20-%3E%20List%5Bstr%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(self.target%2C%20Variable)%3A%20return%20%5Bself.target.name%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(self.target%2C%20VariableCombination)%3A%20return%20%5Bv.name%20for%20v%20in%20self.target.variables%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(self.target%2C%20TargetStateQuery)%3A%20return%20%5Bself.target.variable.name%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20raise%20TypeError(%22Internal%20Error%3A%20Invalid%20target%20type%20in%20QueryExpression%22)%0A%20%20%20%20%20%20%20%20def%20__repr__(self)%3A%20return%20f%22QueryExpression(Target%3A%20%7Brepr(self.target)%7D%2C%20Conditions%3A%20%7Bself.conditions%7D)%22%0A%0A%0A%20%20%20%20def%20_get_matching_states(variable_name%3A%20str%2C%20operator%3A%20str%2C%20value%3A%20Any%2C%20dag_instance%3A%20DAG)%20-%3E%20List%5BAny%5D%3A%0A%20%20%20%20%20%20%20%20%22%22%22Identifies%20discrete%20states%20of%20a%20variable%20that%20satisfy%20a%20given%20condition.%22%22%22%0A%20%20%20%20%20%20%20%20try%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20cpd%20%3D%20dag_instance.model.get_cpds(variable_name)%0A%20%20%20%20%20%20%20%20%20%20%20%20all_states%20%3D%20cpd.state_names%5Bvariable_name%5D%20if%20cpd%20else%20%5B%5D%0A%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Could%20not%20retrieve%20states%20for%20variable%20'%7Bvariable_name%7D'%3A%20%7Be%7D%22)%20%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%5B%5D%0A%20%20%20%20%20%20%20%20matching_states%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20value_is_numeric%20%3D%20isinstance(value%2C%20(int%2C%20float))%0A%0A%20%20%20%20%20%20%20%20for%20state%20in%20all_states%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20state_matches%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_numeric%20%3D%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20range_match%20%3D%20re.match(r%22(%5B-%2B%5D%3F%5Cd*%5C.%3F%5Cd%2B)%5Cs*-%5Cs*(%5B-%2B%5D%3F%5Cd*%5C.%3F%5Cd%2B)%22%2C%20str(state))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_numeric%20%3D%20float(state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20is_single_number_state%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20except%20ValueError%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20is_single_number_state%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20value_is_numeric%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20range_match%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parsed_lower%20%3D%20float(range_match.group(1))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20is_plus_range%20%3D%20range_match.group(2)%20%3D%3D%20'%2B'%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20parsed_upper%20%3D%20float('inf')%20if%20is_plus_range%20else%20float(range_match.group(2))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20operator%20%3D%3D%20'%3E'%3A%20state_matches%20%3D%20parsed_lower%20%3E%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3E%3D'%3A%20state_matches%20%3D%20parsed_lower%20%3E%3D%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3C'%3A%20state_matches%20%3D%20parsed_upper%20%3C%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3C%3D'%3A%20state_matches%20%3D%20parsed_upper%20%3C%3D%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3D%3D'%3A%20state_matches%20%3D%20parsed_lower%20%3C%3D%20value%20%3C%20parsed_upper%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'!%3D'%3A%20state_matches%20%3D%20not%20(parsed_lower%20%3C%3D%20value%20%3C%20parsed_upper)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20is_single_number_state%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20operator%20%3D%3D%20'%3E'%3A%20state_matches%20%3D%20state_numeric%20%3E%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3E%3D'%3A%20state_matches%20%3D%20state_numeric%20%3E%3D%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3C'%3A%20state_matches%20%3D%20state_numeric%20%3C%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3C%3D'%3A%20state_matches%20%3D%20state_numeric%20%3C%3D%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'%3D%3D'%3A%20state_matches%20%3D%20np.isclose(state_numeric%2C%20value)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'!%3D'%3A%20state_matches%20%3D%20not%20np.isclose(state_numeric%2C%20value)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(value%2C%20str)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20operator%20%3D%3D%20'%3D%3D'%3A%20state_matches%20%3D%20(state%20%3D%3D%20value)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'!%3D'%3A%20state_matches%20%3D%20(state%20!%3D%20value)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20operator%20%3D%3D%20'%3D%3D'%3A%20state_matches%20%3D%20(str(state)%20%3D%3D%20str(value))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20operator%20%3D%3D%20'!%3D'%3A%20state_matches%20%3D%20(str(state)%20!%3D%20str(value))%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20parse_error%3A%20print(f%22Warning%3A%20Could%20not%20parse%20state%20'%7Bstate%7D'%3A%20%7Bparse_error%7D%22)%3B%20state_matches%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20state_matches%3A%20matching_states.append(state)%0A%20%20%20%20%20%20%20%20if%20not%20matching_states%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Condition%20'%7Bvariable_name%7D%20%7Boperator%7D%20%7Brepr(value)%7D'%20did%20not%20match%20any%20discrete%20states.%22)%0A%20%20%20%20%20%20%20%20return%20matching_states%0A%0A%20%20%20%20%23%20---%20Updated%20P_Calculator%20Class%20(Standalone)%20---%0A%20%20%20%20class%20P_Calculator%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Callable%20class%20to%20calculate%20probabilities.%20Handles%20interventions%20via%20do().%0A%20%20%20%20%20%20%20%20Handles%20marginal%2C%20joint%2C%20conditional%2C%20and%20specific%20state%20queries.%0A%20%20%20%20%20%20%20%20Handles%20equality%20and%20range%20conditions%20(observational%20and%20interventional%20via%20filtering).%0A%20%20%20%20%20%20%20%20Returns%20List%5BDict%5D%20for%20distributions%2C%20float%20for%20specific%20state%20queries.%0A%20%20%20%20%20%20%20%20Includes%20method%20to%20generate%20LaTeX%20representation%20of%20queries.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20_latex_escape(self%2C%20text%3A%20str)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Basic%20LaTeX%20escaping%20for%20variable%20names%20and%20string%20values.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20More%20robust%20escaping%20might%20be%20needed%20for%20edge%20cases%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20text.replace('_'%2C%20'%5C%5C_').replace('%25'%2C%20'%5C%5C%25').replace('%26'%2C%20'%5C%5C%26')%5C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.replace('%23'%2C%20'%5C%5C%23').replace('%24'%2C%20'%5C%5C%24')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23.replace('%7B'%2C%20'%5C%5C%7B').replace('%7D'%2C%20'%5C%5C%7D')%20%23%20Avoid%20escaping%20braces%20used%20by%20%5Ctext%0A%0A%20%20%20%20%20%20%20%20def%20_format_latex_condition(self%2C%20cond%3A%20Union%5BCondition%2C%20DoCondition%2C%20DoRangeCondition%5D)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Formats%20a%20single%20condition%20object%20into%20a%20LaTeX%20string.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20%3D%20self._latex_escape(str(cond.variable_name))%0A%20%20%20%20%20%20%20%20%20%20%20%20op%20%3D%20cond.operator%0A%20%20%20%20%20%20%20%20%20%20%20%20val%20%3D%20cond.value%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Wrap%20variable%20name%20in%20%5Ctext%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20latex_var%20%3D%20f%22%5C%5Ctext%7B%7B%7Bvar%7D%7D%7D%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Format%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(val%2C%20str)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20val_repr%20%3D%20f%22%5C%5Ctexttt%7B%7B%7Bself._latex_escape(val)%7D%7D%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(val%2C%20bool)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20val_repr%20%3D%20%22%5C%5Ctexttt%7BTrue%7D%22%20if%20val%20else%20%22%5C%5Ctexttt%7BFalse%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20val_repr%20%3D%20str(val)%20%23%20Keep%20numbers%20as%20is%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Format%20operator%0A%20%20%20%20%20%20%20%20%20%20%20%20latex_op%20%3D%20op.replace('%3E%3D'%2C%20'%5C%5Cge%20').replace('%3C%3D'%2C%20'%5C%5Cle%20').replace('!%3D'%2C%20'%5C%5Cneq%20')%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20latex_op%20%3D%3D%20'%3D%3D'%3A%20latex_op%20%3D%20'%3D'%20%23%20Use%20'%3D'%20in%20LaTeX%20for%20equality%20condition%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(cond%2C%20DoCondition)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22do(%7Blatex_var%7D%3D%7Bval_repr%7D)%22%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(cond%2C%20DoRangeCondition)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22do(%7Blatex_var%7D%7Blatex_op%7D%7Bval_repr%7D)%22%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(cond%2C%20Condition)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22%7Blatex_var%7D%7Blatex_op%7D%7Bval_repr%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%22%22%0A%0A%20%20%20%20%20%20%20%20def%20to_latex(self%2C%20query_input%3A%20Union%5BVariable%2C%20VariableCombination%2C%20TargetStateQuery%2C%20QueryExpression%5D)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Generates%20a%20LaTeX%20string%20representation%20of%20the%20probability%20query.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Args%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20query_input%3A%20Variable%2C%20VariableCombination%2C%20TargetStateQuery%2C%20or%20QueryExpression.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20str%3A%20A%20LaTeX%20string%20representing%20the%20query%20(e.g.%2C%20%22P(%5C%5Ctext%7Boutcome%7D%20%5C%5Cmid%20%5C%5Ctext%7Bsmoking%7D%3D%5C%5Ctexttt%7BTrue%7D)%22).%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20target_obj%3A%20Optional%5BUnion%5BVariable%2C%20VariableCombination%2C%20TargetStateQuery%5D%5D%20%3D%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20all_conditions%3A%20List%5BUnion%5BCondition%2C%20DoCondition%2C%20DoRangeCondition%5D%5D%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Parse%20input%20to%20find%20target%20and%20conditions%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(query_input%2C%20(Variable%2C%20VariableCombination))%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_obj%20%3D%20query_input%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(query_input%2C%20TargetStateQuery)%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_obj%20%3D%20query_input%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(query_input%2C%20QueryExpression)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_obj%20%3D%20query_input.target%3B%20all_conditions%20%3D%20query_input.conditions%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22Input%20must%20be%20a%20Variable%2C%20VariableCombination%2C%20TargetStateQuery%2C%20or%20QueryExpression.%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20target_obj%20is%20None%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Query%20target%20is%20missing.%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Format%20target%20part%0A%20%20%20%20%20%20%20%20%20%20%20%20target_str%20%3D%20%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(target_obj%2C%20Variable)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Wrap%20variable%20name%20in%20%5Ctext%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_str%20%3D%20f%22%5C%5Ctext%7B%7B%7Bself._latex_escape(str(target_obj.name))%7D%7D%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(target_obj%2C%20VariableCombination)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Wrap%20each%20variable%20name%20in%20%5Ctext%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_str%20%3D%20%22%2C%20%22.join(f%22%5C%5Ctext%7B%7B%7Bself._latex_escape(str(v.name))%7D%7D%7D%22%20for%20v%20in%20target_obj.variables)%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(target_obj%2C%20TargetStateQuery)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20Format%20as%20Var%20%3D%20Val%2C%20wrap%20var%20name%20in%20%5Ctext%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var_name%20%3D%20f%22%5C%5Ctext%7B%7B%7Bself._latex_escape(str(target_obj.variable.name))%7D%7D%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_val%20%3D%20target_obj.state%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(state_val%2C%20str)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_repr%20%3D%20f%22%5C%5Ctexttt%7B%7B%7Bself._latex_escape(state_val)%7D%7D%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(state_val%2C%20bool)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_repr%20%3D%20%22%5C%5Ctexttt%7BTrue%7D%22%20if%20state_val%20else%20%22%5C%5Ctexttt%7BFalse%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_repr%20%3D%20str(state_val)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_str%20%3D%20f%22%7Bvar_name%7D%3D%7Bstate_repr%7D%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Format%20condition%20part%0A%20%20%20%20%20%20%20%20%20%20%20%20condition_str%20%3D%20%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20all_conditions%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20formatted_conditions%20%3D%20%5Bself._format_latex_condition(cond)%20for%20cond%20in%20all_conditions%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20condition_str%20%3D%20%22%20%5C%5Cmid%20%22%20%2B%20%22%2C%20%22.join(formatted_conditions)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Combine%20and%20return%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20f%22P(%7Btarget_str%7D%7Bcondition_str%7D)%22%0A%0A%0A%20%20%20%20%20%20%20%20def%20__call__(self%2C%20query_input%3A%20Union%5BVariable%2C%20VariableCombination%2C%20TargetStateQuery%2C%20QueryExpression%5D)%20-%3E%20Union%5BList%5BDict%5Bstr%2C%20Any%5D%5D%2C%20float%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Calculates%20probability%20based%20on%20the%20input%20expression.%0A%20%20%20%20%20%20%20%20%20%20%20%20(Implementation%20remains%20the%20same%20as%20previous%20version%20-%20code%20omitted%20for%20brevity)%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%20This%20method's%20internal%20logic%20is%20unchanged%20from%20the%20previous%20version%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Parses%20input%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Separates%20evidence%2C%20do_equality_dict%2C%20do_range_conditions%2C%20range_conditions%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Determines%20query_vars%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Handles%20deterministic%20case%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Performs%20CausalInference%20or%20VariableElimination%20query%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Applies%20range%20condition%20filtering%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Marginalizes%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Normalizes%20...%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20...%20Extracts%20float%20or%20Formats%20list%20output%20...%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20---%20Re-paste%20full%20__call__%20implementation%20for%20completeness%20---%0A%20%20%20%20%20%20%20%20%20%20%20%20target_obj%3A%20Optional%5BUnion%5BVariable%2C%20VariableCombination%2C%20TargetStateQuery%5D%5D%20%3D%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20all_conditions%3A%20List%5BUnion%5BCondition%2C%20DoCondition%2C%20DoRangeCondition%5D%5D%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20dag_instance%3A%20Optional%5BDAG%5D%20%3D%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20is_specific_state_query%20%3D%20False%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%201.%20Parse%20input%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(query_input%2C%20(Variable%2C%20VariableCombination))%3A%20target_obj%20%3D%20query_input%3B%20dag_instance%20%3D%20query_input._dag%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(query_input%2C%20TargetStateQuery)%3A%20target_obj%20%3D%20query_input%3B%20dag_instance%20%3D%20query_input._dag%3B%20is_specific_state_query%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(query_input%2C%20QueryExpression)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_obj%20%3D%20query_input.target%3B%20dag_instance%20%3D%20query_input._dag%3B%20all_conditions%20%3D%20query_input.conditions%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(target_obj%2C%20TargetStateQuery)%3A%20is_specific_state_query%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20TypeError(%22Input%20to%20P()%20must%20be%20a%20Variable%2C%20VariableCombination%2C%20TargetStateQuery%2C%20or%20QueryExpression.%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Separate%20conditions%0A%20%20%20%20%20%20%20%20%20%20%20%20equality_evidence%20%3D%20%7B%7D%3B%20do_equality_dict%20%3D%20%7B%7D%3B%20do_range_conditions%20%3D%20%5B%5D%3B%20range_conditions%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20has_intervention%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20cond%20in%20all_conditions%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(cond%2C%20DoCondition)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20has_intervention%20%3D%20True%3B%20var%2C%20val%20%3D%20cond.variable_name%2C%20cond.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20var%20in%20do_equality_dict%20and%20do_equality_dict%5Bvar%5D%20!%3D%20val%3A%20raise%20ValueError(f%22Conflicting%20do(%3D%3D)%20interventions%20for%20'%7Bvar%7D'.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20var%20in%20equality_evidence%3A%20raise%20ValueError(f%22Cannot%20have%20'%7Bvar%7D'%20in%20both%20evidence%20and%20do(%3D%3D)%20intervention.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20do_equality_dict%5Bvar%5D%20%3D%20val%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(cond%2C%20DoRangeCondition)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20has_intervention%20%3D%20True%3B%20do_range_conditions.append(cond)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(cond%2C%20Condition)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20cond.operator%20%3D%3D%20'%3D%3D'%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%2C%20val%20%3D%20cond.variable_name%2C%20cond.value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20var%20in%20equality_evidence%20and%20equality_evidence%5Bvar%5D%20!%3D%20val%3A%20raise%20ValueError(f%22Conflicting%20equality%20evidence%20for%20'%7Bvar%7D'.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20var%20in%20do_equality_dict%3A%20raise%20ValueError(f%22Cannot%20have%20'%7Bvar%7D'%20in%20both%20evidence%20and%20do(%3D%3D)%20intervention.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20equality_evidence%5Bvar%5D%20%3D%20val%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20cond.operator%20in%20%5B'!%3D'%2C%20'%3E'%2C%20'%3E%3D'%2C%20'%3C'%2C%20'%3C%3D'%5D%3A%20range_conditions.append(cond)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20raise%20NotImplementedError(f%22Condition%20operator%20'%7Bcond.operator%7D'%20not%20supported.%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%202.%20Determine%20query%20variables%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20target_obj%20is%20None%3A%20raise%20ValueError(%22Query%20target%20is%20missing.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20underlying_target_names%3A%20List%5Bstr%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(target_obj%2C%20Variable)%3A%20underlying_target_names%20%3D%20%5Btarget_obj.name%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(target_obj%2C%20VariableCombination)%3A%20underlying_target_names%20%3D%20%5Bv.name%20for%20v%20in%20target_obj.variables%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(target_obj%2C%20TargetStateQuery)%3A%20underlying_target_names%20%3D%20%5Btarget_obj.variable.name%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20raise%20TypeError(%22Internal%20Error%3A%20Invalid%20target_obj%20type%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20all_range_vars%20%3D%20list(set(%5Brc.variable_name%20for%20rc%20in%20range_conditions%5D%20%2B%20%5Bdrc.variable_name%20for%20drc%20in%20do_range_conditions%5D))%0A%20%20%20%20%20%20%20%20%20%20%20%20query_vars%20%3D%20list(dict.fromkeys(underlying_target_names%20%2B%20all_range_vars))%0A%20%20%20%20%20%20%20%20%20%20%20%20query_vars%20%3D%20%5Bv%20for%20v%20in%20query_vars%20if%20v%20not%20in%20do_equality_dict%5D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Handle%20deterministic%20case%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20query_vars%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22Warning%3A%20Target%20variable(s)%20are%20fixed%20by%20do(%3D%3D)%20intervention.%20Result%20is%20deterministic.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20is_specific_state_query%20and%20isinstance(target_obj%2C%20TargetStateQuery)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_var%2C%20target_state%20%3D%20target_obj.variable.name%2C%20target_obj.state%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%201.0%20if%20target_var%20in%20do_equality_dict%20and%20do_equality_dict%5Btarget_var%5D%20%3D%3D%20target_state%20else%200.0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%5B%5D%20if%20not%20is_specific_state_query%20else%200.0%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%203.%20Perform%20main%20query%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20initial_joint_factor%3A%20DiscreteFactor%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20has_intervention%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20causal_inference%20%3D%20CausalInference(dag_instance.model)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20initial_joint_factor%20%3D%20causal_inference.query(variables%3Dquery_vars%2C%20do%3Ddo_equality_dict%2C%20evidence%3Dequality_evidence%20if%20equality_evidence%20else%20None)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20initial_joint_factor%20%3D%20dag_instance.inference.query(variables%3Dquery_vars%2C%20evidence%3Dequality_evidence%20if%20equality_evidence%20else%20None%2C%20show_progress%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%204.%20Apply%20ALL%20range%20conditions%20via%20filtering%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20all_range_conditions%20%3D%20range_conditions%20%2B%20do_range_conditions%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20all_range_conditions%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20print(f%22%20%20Applying%20range%20conditions%20by%20filtering%20factor%20over%20%7Binitial_joint_factor.variables%7D...%22)%20%23%20Reduce%20noise%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20filtered_factor%20%3D%20initial_joint_factor.copy()%3B%20factor_vars_ordered%20%3D%20filtered_factor.variables%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_name_map%20%3D%20filtered_factor.state_names%3B%20state_combinations%20%3D%20%5Bstate_name_map%5Bvar%5D%20for%20var%20in%20factor_vars_ordered%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20flat_probabilities%20%3D%20filtered_factor.values.flatten()%3B%20new_probabilities%20%3D%20flat_probabilities.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20prob_idx%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20state_tuple%20in%20itertools.product(*state_combinations)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_dict%20%3D%20dict(zip(factor_vars_ordered%2C%20state_tuple))%3B%20include_this_combination%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20rc%20in%20all_range_conditions%3A%20%23%20Check%20against%20ALL%20range%20conditions%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%2C%20op%2C%20val%2C%20current_state%20%3D%20rc.variable_name%2C%20rc.operator%2C%20rc.value%2C%20state_dict%5Brc.variable_name%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_matches_condition%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%3A%20%23%20Simplified%20check%20logic%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_numeric%20%3D%20None%3B%20value_is_numeric%20%3D%20isinstance(val%2C%20(int%2C%20float))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try%3A%20state_numeric%20%3D%20float(current_state)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20except%20ValueError%3A%20pass%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20value_is_numeric%20and%20state_numeric%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20op%20%3D%3D%20'%3E'%3A%20state_matches_condition%20%3D%20state_numeric%20%3E%20val%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20op%20%3D%3D%20'%3E%3D'%3A%20state_matches_condition%20%3D%20state_numeric%20%3E%3D%20val%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20op%20%3D%3D%20'%3C'%3A%20state_matches_condition%20%3D%20state_numeric%20%3C%20val%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20op%20%3D%3D%20'%3C%3D'%3A%20state_matches_condition%20%3D%20state_numeric%20%3C%3D%20val%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20op%20%3D%3D%20'!%3D'%3A%20state_matches_condition%20%3D%20not%20np.isclose(state_numeric%2C%20val)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20op%20%3D%3D%20'%3D%3D'%3A%20state_matches_condition%20%3D%20np.isclose(state_numeric%2C%20val)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20isinstance(val%2C%20str)%20and%20state_numeric%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20op%20%3D%3D%20'!%3D'%3A%20state_matches_condition%20%3D%20(str(current_state)%20!%3D%20str(val))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20op%20%3D%3D%20'%3D%3D'%3A%20state_matches_condition%20%3D%20(str(current_state)%20%3D%3D%20str(val))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%3A%20pass%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20state_matches_condition%3A%20include_this_combination%20%3D%20False%3B%20break%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20include_this_combination%3A%20new_probabilities%5Bprob_idx%5D%20%3D%200.0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20prob_idx%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20filtered_factor.values%20%3D%20new_probabilities.reshape(filtered_factor.cardinality)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%205.%20Marginalize%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20vars_to_marginalize%20%3D%20%5Brv%20for%20rv%20in%20all_range_vars%20if%20rv%20not%20in%20underlying_target_names%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20vars_to_marginalize%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20print(f%22%20%20Marginalizing%20out%20range%20variables%3A%20%7Bvars_to_marginalize%7D%22)%20%23%20Reduce%20noise%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20final_factor%20%3D%20filtered_factor.marginalize(vars_to_marginalize%2C%20inplace%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20final_factor%20%3D%20filtered_factor%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%206.%20Normalize%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20print(%22%20%20Normalizing%20final%20factor...%22)%20%23%20Reduce%20noise%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20np.sum(final_factor.values)%20%3E%201e-10%3A%20final_factor.normalize(inplace%3DTrue)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20print(%22Warning%3A%20Probability%20sum%20is%20zero%20after%20applying%20range%20conditions.%22)%3B%20final_factor.values%5B%3A%5D%20%3D%200.0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20final_factor%20%3D%20initial_joint_factor%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%207.%20Format%20output%20OR%20Extract%20specific%20probability%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20is_specific_state_query%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_state_query%20%3D%20target_obj%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_var_name%20%3D%20target_state_query.variable.name%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20desired_state%20%3D%20target_state_query.state%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20target_var_name%20not%20in%20final_factor.variables%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Target%20variable%20'%7Btarget_var_name%7D'%20not%20found%20in%20final%20factor.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%200.0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20probability%20%3D%200.0%3B%20final_factor_vars%20%3D%20final_factor.variables%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20final_state_combinations%20%3D%20%5Bfinal_factor.state_names%5Bvar%5D%20for%20var%20in%20final_factor_vars%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20final_probabilities%20%3D%20final_factor.values.flatten()%3B%20prob_idx%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20target_var_index%20%3D%20final_factor_vars.index(target_var_name)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20state_tuple%20in%20itertools.product(*final_state_combinations)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20current_state_for_target%20%3D%20state_tuple%5Btarget_var_index%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20actual_desired_state%20%3D%20desired_state%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20target_var_name%20in%20dag_instance._bool_cols%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20isinstance(desired_state%2C%20bool)%3A%20current_state_for_target%20%3D%20(current_state_for_target.lower()%20%3D%3D%20'true')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20current_state_for_target%20%3D%3D%20actual_desired_state%3A%20probability%20%2B%3D%20final_probabilities%5Bprob_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20prob_idx%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20float(probability)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%3A%20%23%20Format%20full%20distribution%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20output_list%20%3D%20%5B%5D%3B%20final_factor_vars%20%3D%20final_factor.variables%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20final_state_combinations%20%3D%20%5Bfinal_factor.state_names%5Bvar%5D%20for%20var%20in%20final_factor_vars%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20final_probabilities%20%3D%20final_factor.values.flatten()%3B%20prob_idx%20%3D%200%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20state_tuple%20in%20itertools.product(*final_state_combinations)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20row_dict%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20i%2C%20var_name%20in%20enumerate(final_factor_vars)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20state_value%20%3D%20state_tuple%5Bi%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20var_name%20in%20dag_instance._bool_cols%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20state_value.lower()%20%3D%3D%20'true'%3A%20state_value%20%3D%20True%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20elif%20state_value.lower()%20%3D%3D%20'false'%3A%20state_value%20%3D%20False%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20row_dict%5Bvar_name%5D%20%3D%20state_value%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20row_dict%5B'probability'%5D%20%3D%20final_probabilities%5Bprob_idx%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20output_list.append(row_dict)%3B%20prob_idx%20%2B%3D%201%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20output_list%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Error%20during%20inference%20(DAG%3A%20%7Bdag_instance%7D)%20for%20query%20%7Brepr(query_input)%7D%3A%20%7Be%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20import%20traceback%3B%20traceback.print_exc()%3B%20raise%0A%0A%0A%20%20%20%20P%20%3D%20P_Calculator()%0A%0A%0A%20%20%20%20class%20DAG%3A%0A%20%20%20%20%20%20%20%20%22%22%22Represents%20a%20Directed%20Acyclic%20Graph%20(DAG)%20learned%20from%20data.%22%22%22%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20nodes%2C%20edges%2C%20dataframe)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20isinstance(dataframe%2C%20pd.DataFrame)%3A%20raise%20ValueError(%22dataframe%20must%20be%20a%20pandas%20DataFrame.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.nodes%20%3D%20list(nodes)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20all(node%20in%20dataframe.columns%20for%20node%20in%20self.nodes)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20missing_nodes%20%3D%20%5Bnode%20for%20node%20in%20self.nodes%20if%20node%20not%20in%20dataframe.columns%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(f%22Nodes%20%7Bmissing_nodes%7D%20not%20found%20in%20DataFrame%20columns.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.edges%20%3D%20edges%0A%20%20%20%20%20%20%20%20%20%20%20%20self.dataframe%20%3D%20dataframe%0A%20%20%20%20%20%20%20%20%20%20%20%20self._variables%20%3D%20%7B%7D%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.model%20%3D%20DiscreteBayesianNetwork(ebunch%3Dedges)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.model.add_nodes_from(self.nodes)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20df_copy%20%3D%20dataframe.copy()%0A%20%20%20%20%20%20%20%20%20%20%20%20self._bool_cols%20%3D%20df_copy.select_dtypes(include%3D%5B'bool'%5D).columns.tolist()%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20col%20in%20self._bool_cols%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df_copy%5Bcol%5D%20%3D%20df_copy%5Bcol%5D.astype(str)%0A%20%20%20%20%20%20%20%20%20%20%20%20self._state_metadata%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20'age'%20in%20nodes%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self._state_metadata%5B'age'%5D%20%3D%20%7B'type'%3A%20'numerical_bin'%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20self.model.fit(df_copy%2C%20estimator%3DMaximumLikelihoodEstimator)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20self.model.check_model()%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(%22Warning%3A%20Model%20check%20reported%20issues.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Warning%3A%20Model%20check%20failed%20with%20an%20error%3A%20%7Be%7D.%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.inference%20%3D%20VariableElimination(self.model)%0A%0A%20%20%20%20%20%20%20%20def%20get_variables(self)%20-%3E%20List%5BVariable%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20len(self._variables)%20!%3D%20len(self.nodes)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20temp_vars%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20name%20in%20self.nodes%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20temp_vars.update(%7Bname%3A%20self._variables.get(name%2C%20Variable(name%2C%20self))%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self._variables%20%3D%20temp_vars%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%5Bself._variables%5Bname%5D%20for%20name%20in%20self.nodes%5D%0A%0A%20%20%20%20%20%20%20%20def%20_prepare_evidence(self%2C%20evidence_dict)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20prepared_evidence%20%3D%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20var%2C%20value%20in%20evidence_dict.items()%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20prepared_evidence%5Bvar%5D%20%3D%20str(value)%20if%20var%20in%20self._bool_cols%20else%20value%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20prepared_evidence%0A%0A%20%20%20%20%20%20%20%20def%20P(self%2C%20target_variable%2C%20evidence%3DNone)%20-%3E%20DiscreteFactor%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20target_name%20%3D%20target_variable.name%20if%20isinstance(target_variable%2C%20Variable)%20else%20target_variable%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20target_name%20not%20in%20self.nodes%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(f%22Unknown%20target%20variable%3A%20%7Btarget_name%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20prepared_evidence%20%3D%20self._prepare_evidence(evidence)%20if%20evidence%20else%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20try%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20self.inference.query(variables%3D%5Btarget_name%5D%2C%20evidence%3Dprepared_evidence%2C%20show_progress%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20except%20Exception%20as%20e%3A%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Error%20during%20inference%20via%20DAG.P%20for%20P(%7Btarget_name%7D%20%7C%20%7Bprepared_evidence%7D)%3A%20%7Be%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%0A%0A%20%20%20%20return%20DAG%2C%20P%2C%20do%2C%20pd%0A%0A%0A%40app.function%0Adef%20test_true()%3A%0A%20%20%20%20assert%20True%0A%0A%0A%40app.cell%0Adef%20_(pd)%3A%0A%20%20%20%20df_smoking%20%3D%20(pd.read_csv(%22https%3A%2F%2Fcalmcode.io%2Fstatic%2Fdata%2Fsmoking.csv%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.assign(age%3Dlambda%20d%3A%20(d%5B%22age%22%5D%20%2F%2010).round()%20*%2010))%0A%20%20%20%20return%20(df_smoking%2C)%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>
