<!DOCTYPE html>
<html lang="zh-cn">
<html>
<head>
<meta charset="utf-8" />
<title>socket日志订阅系统</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="HandheldFriendly" content="true"/>
<meta name="MobileOptimized" content="320"/>
<%include file="/app/common/html/include/static.html"/>

<link rel="stylesheet" href="https://st.lkkjjt.com/static/xterm/default/xterm.min.css"/>
<script src="https://st.lkkjjt.com/static/xterm/default/xterm.min.js"></script>
<body>
<div id="app">
    <div @click="restart" style="position:fixed;right:30px;top:10px;z-index:999;cursor: pointer;">
        <el-tooltip class="item" effect="dark" content="重启服务" placement="left-start">
            <i class="el-icon-caret-right" style="font-size:30px;color:#67C23A"></i>
        </el-tooltip>
    </div>
    <div style="height:10px;background:#000"></div>
    <div id="terminal" class="app-box"></div>
</div>
<script type="text/javascript">
var VUE = new Vue({
	el: '#app',
	data: {
        winheight:document.documentElement.clientHeight,winwidth:document.documentElement.clientWidth,
        ws:null,term:null
	},
	mounted:function(){
		self=this
		window.onresize = function(){
			self.winheight=document.documentElement.clientHeight
            self.winwidth=document.documentElement.clientWidth
        }
        self.inits();
        self.getseradd();
	},
	methods: {
        getseradd:function(){
            self=this
            self.get("/index/index/socket/getseradd").then(function(res){
                self.setcon(res.data)
            })
        },
        setcon:function(WebSockethosts){
            self=this
            setTimeout(function(){
                self.term.writeln('');
                self.term.writeln('');
                self.term.writeln("\u001b[32m    正在连接中...")
                self.ws = new WebSocket(WebSockethosts);
                self.ws.onmessage = function (evt){
                    self.rec(eval('('+evt.data+')'))
                };
                self.ws.onopen = function(event){};
                self.ws.onclose = function(){
                    self.term.writeln("\u001b[31m    连接关闭，准备重新连接")
                    self.getseradd()
                }; 
                self.ws.onerror=function(){
                    self.term.writeln("\u001b[31m    连接错误，请重新打开或刷新")
                    
                }; 
            },200)
        },
        restart:function(){
            self.post("/index/index/socket/restart","重启中...").then(function(res){
                self.$message({type: 'success',message: '重启成功'});
            })
        },
        rec:function(res){
            var self=this;
            
            if(res.code==0){
                if(res.data.types=='Groupname'){
                    for(var i=0;i<res.data.data.length;i++){
                        self.ws.send(JSON.stringify({
                            types:'joinGroup','group':res.data.data[i]
                        }))
                    }
                    
                    self.term.writeln("\u001b[32m    连接成功");
                    self.term.writeln('');
                    self.term.writeln('\u001b[31m    如果您需要在当前页面中看到实时日志，请以当前服务为基础开发，在项目中执行以下代码');
                    self.term.writeln('\u001b[33m    sockcli=getfunction("app.intapp.controller.index.socket").socket_client()');
                    self.term.writeln('\u001b[33m    sockcli.send("要打印的数据")');
                    self.term.writeln('');
                    self.term.writeln('');
                }else if(res.data.types=='joinGroup'){
                    self.term.writeln("\u001b[34m    已进入组:"+res.data.group);
                    self.term.writeln('');
                }else{
                    self.term.writeln('\u001b[36m    '+res.data.content);
                }
                // self.term.writeln(1234);
            }else{
                self.$notify({title: '提示',duration:3000,message: res.msg,type: 'error'});
            }
        },
        inits:function(){
            var self=this;
            // alert(parseInt(self.winheight/17.5))
            self.term = new Terminal({
                cols: 82,
                rows: parseInt(self.winheight/17),
                convertEol: true,
                scrollback:1000,//终端中的回滚量
                disableStdin: true, //是否应禁用输入。
                cursorBlink: true, //光标闪烁
                
                theme: {
                    foreground: '#FFF',//'yellow', //字体
                    background: '#060101', //背景色
                    cursor: 'help',//设置光标
                }
            });
            self.term.open(document.getElementById('terminal'));
            self.term.resize(90,30)
        }
	}
})
</script>
</body>

</html>