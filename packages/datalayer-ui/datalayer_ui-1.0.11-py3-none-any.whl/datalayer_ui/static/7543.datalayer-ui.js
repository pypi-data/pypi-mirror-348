"use strict";(self.webpackChunk_datalayer_ui=self.webpackChunk_datalayer_ui||[]).push([[7543],{51009:(e,t,n)=>{n.d(t,{J:()=>d});var s={};function o(){return"\ndef _list_variables():\n    import json\n    from types import BuiltinFunctionType, BuiltinMethodType, FunctionType, MethodType, MethodWrapperType, ModuleType, TracebackType\n\n    _FORBIDDEN_TYPES = [type, BuiltinFunctionType, BuiltinMethodType, FunctionType, MethodType, MethodWrapperType, ModuleType, TracebackType]\n    try:\n        from IPython.core.autocall import ExitAutocall\n        _FORBIDDEN_TYPES.append(ExitAutocall)\n    except ImportError:\n        pass\n    _exclude = tuple(_FORBIDDEN_TYPES)\n\n    _all = frozenset(globals())\n    _vars = {}\n    for _n in _all:\n        _v = globals()[_n]\n        \n        if not (\n            _n.startswith('_') or\n            isinstance(_v, _exclude) or\n            # Special IPython variables\n            (_n == 'In' and isinstance(_v, list)) or\n            (_n == 'Out' and isinstance(_v, dict))\n        ):\n            _vars[_n] = type(_v).__qualname__\n\n    return json.dumps(_vars)\n\n_list_variables()"}function i(e){return`\ndef _pickle_variables():\n    from base64 import encodebytes\n    import json\n    import pickle\n    _names = {${e.map((e=>`"${e}"`)).join(",")}}\n    _data = {}\n    for _n in _names:\n        try:\n            _v = globals()[_n]\n            dump = pickle.dumps(_v)\n            _data[_n] = encodebytes(dump).decode("ascii")\n        except:\n            ...\n\n    return json.dumps(_data)\n\n_pickle_variables()\n`}function a(e){return`\ndef _load_variables():\n    from base64 import decodebytes\n    import json\n    import pickle\n    _data = json.loads(${e})\n    _loaded = []\n    for _n, _v in _data.items():\n        try:\n            dump = decodebytes(_v.encode("ascii"))\n            globals()[_n] = pickle.loads(dump)\n            _loaded.append(_n)\n        except:\n            ...\n    return json.dumps(_loaded)\n\n_load_variables()\n`}function l(e){return`\ndef _change_current_directory():\n    import os\n    from pathlib import Path\n    _local_content_mount_point = Path(Path.home() / ${e.split("/").map((e=>`"${e}"`)).join(" / ")})\n    _local_content_mount_point.mkdir(parents=True, exist_ok=True)\n    os.chdir(_local_content_mount_point)\n\n    assert Path.cwd() == _local_content_mount_point\n\n_change_current_directory()\n`}function r(e){return Array.from(e.matchAll(/^((?<output>[A-z][\w]*)\s*=[^=]|\((?<walrus>[A-z][\w]*)\s*:=[^=)]+\))/gm)).map((e=>e.groups?.output??e.groups?.walrus??"")).filter((e=>!!e))}function c(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.r(s),n.d(s,{changeCurrentWorkingDirectory:()=>l,getOutputCandidates:()=>r,listVariables:()=>o,loadVariables:()=>a,saveVariables:()=>i});class d{static register(e,t){this.$language.set(e,t)}static supports(e){return this.$language.has(e)}constructor(e){if(c(this,"_language",void 0),!d.$language.has(e))throw new Error(`${e} is not supported.`);this._language=e}get language(){return this._language}changeCurrentWorkingDirectory(e){return d.$language.get(this.language).changeCurrentWorkingDirectory(e)}listVariables(){return d.$language.get(this.language).listVariables()}loadVariables(e){return d.$language.get(this.language).loadVariables(e)}saveVariables(e){return d.$language.get(this.language).saveVariables(e)}getOutputCandidates(e){return d.$language.get(this.language).getOutputCandidates(e)}}c(d,"$language",new Map),d.register("python",s)},73897:(e,t,n)=>{n.d(t,{R:()=>o});const s=["browser","local"];function o(e){return!s.includes(e)}},93426:(e,t,n)=>{n.d(t,{c:()=>s});const s=3},97543:(e,t,n)=>{n.d(t,{kU:()=>b,sn:()=>w});var s=n(2335),o=n(55881),i=n(63711),a=n(51671),l=n(85181),r=n(38921),c=n(98238),d=n(72490),u=n(36848),h=n(94247),p=n(93426),m=n(44536),_=n(51857),g=n(51009),f=n(73897);function v(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const C=new WeakMap;class b{static getRemoteCell(e){return C.get(e)}static run(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=y.getState(e),i=y.runSelected(e,t,n,s);return y.handleRunState(e,o,!1),i}static runCells(e,t,n,s,o){if(!e.model)return Promise.resolve(!1);const i=y.getState(e),a=y.runCells(e,t,n,s,o);return y.handleRunState(e,i,!1),a}static runAll(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=y.getState(e),i=e.widgets.length,a=y.runCells(e,e.widgets,t,n,s);return e.activeCellIndex=i,e.deselectAll(),y.handleRunState(e,o,!0),a}static runAllAbove(e,t,n,s){const{activeCell:o,activeCellIndex:i,model:a}=e;if(!a||!o||i<1)return Promise.resolve(!1);const l=y.getState(e),r=y.runCells(e,e.widgets.slice(0,e.activeCellIndex),t,n,s);return e.deselectAll(),y.handleRunState(e,l,!0),r}static runAllBelow(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=y.getState(e),i=e.widgets.length,a=y.runCells(e,e.widgets.slice(e.activeCellIndex),t,n,s);return e.activeCellIndex=i,e.deselectAll(),y.handleRunState(e,o,!0),a}static async runAndAdvance(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=y.getState(e),a=y.runSelected(e,t,n,s),l=e.model;return e.activeCellIndex===e.widgets.length-1?(l.sharedModel.insertCell(e.widgets.length,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,i.signalToPromise)(e.activeCell.inViewportChanged,200).catch((()=>{})),e.mode="edit"):e.activeCellIndex++,y.handleRunState(e,o,!0),a}static async runAndInsert(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=y.getState(e),a=y.runSelected(e,t,n,s);return e.model.sharedModel.insertCell(e.activeCellIndex+1,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,i.signalToPromise)(e.activeCell.inViewportChanged,200).catch((()=>{})),e.mode="edit",y.handleRunState(e,o,!0),a}}v(b,"serviceManager",null);let y,w=function(e){return e[e.QUEUED=0]="QUEUED",e[e.STARTING_KERNEL=1]="STARTING_KERNEL",e[e.IMPORTING=2]="IMPORTING",e[e.EXECUTING=3]="EXECUTING",e[e.EXPORTING=4]="EXPORTING",e[e.UNKNOWN=5]="UNKNOWN",e[e.DONE=6]="DONE",e[e.ERROR=7]="ERROR",e}({});class k{constructor({cell:e,sessionContext:t,metadata:n}){v(this,"cell",void 0),v(this,"sessionContext",void 0),v(this,"metadata",void 0),this.cell=e,this.sessionContext=t,this.metadata=n}get connection(){return this.sessionContext?.session?.kernel??void 0}failedExecution(e){this.cell.setPrompt("")}cancelExecution(){this.cell.setPrompt("")}scheduleExecution(){this.cell.model.sharedModel.transact((()=>{this.cell.model.clearExecution()}),!1),this.cell.model.sharedModel.getSource().trim()&&this.cell.setPrompt("*")}processCell(){return Promise.resolve(!1)}}class S extends k{constructor(e){super(e),v(this,"_connection",void 0),v(this,"_reason",null),v(this,"_isDisposed",!1),v(this,"_kernelSpec",void 0),v(this,"_processed",null),v(this,"_state",w.QUEUED),v(this,"_stateChanged",new d.Signal(this)),v(this,"_variablesIn",void 0),v(this,"_variableOut",void 0);const t=this.cell.model.getMetadata("datalayer")??{};this._kernelSpec=t.kernel,this._variablesIn=Array.isArray(t.in)?t.in:[],this._variableOut="string"==typeof t.out?t.out:""}get connection(){return this._connection}get isDisposed(){return this._isDisposed}get reason(){return this._reason}get state(){return this._state}setState(e,t){this._state===e&&this._reason===t||(this._reason=t??null,this._state=e,this._stateChanged.emit(this._state))}get stateChanged(){return this._stateChanged}failedExecution(e){super.failedExecution(),this.setState(w.ERROR,e)}cancelExecution(){super.cancelExecution(),this.setState(w.ERROR)}scheduleExecution(){super.scheduleExecution(),this.setState(w.QUEUED)}dispose(){this._isDisposed||(this._isDisposed=!0,this._connection?.dispose(),d.Signal.clearData(this))}async processCell(){let e;await this.setupKernel();try{this._processed=new c.PromiseDelegate,this._processCell().then((e=>{this._processed?.resolve(e)})).catch((e=>{this._processed?.reject(e)})),e=await this._processed.promise}finally{await this.teardownKernel()}return e}async _processCell(){if(!this._connection){const e=`Failed to process a remote cell '${this.cell.model.id}'.`;throw this.setState(w.ERROR,e),new Error(e)}if(this._variablesIn.length){if(!this.sessionContext){const e="Unable to import variables; no document kernel available.";throw this.setState(w.ERROR,e),new Error(e)}this.setState(w.IMPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await x(e.language,this.sessionContext.session.kernel,this._variablesIn,this._connection)){const e=`Failed to transfer ${this._variablesIn.join(", ")} to ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(w.ERROR,e),new Error(e)}}this.setState(w.EXECUTING);const e=await o.Yr.execute(this.cell,{session:{kernel:this._connection}},this.metadata);if(console.debug(`@datalayer/ui:runtimes: Capture cell ${this.cell.model.id} execution`,e),this.metadata.deletedCells&&(this.metadata.deletedCells.length=0),!e)return!1;if("ok"===e.content.status){if(this._variableOut){if(!this.sessionContext){const e="Unable to export variables; no document kernel available.";throw this.setState(w.ERROR,e),new Error(e)}this.setState(w.EXPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await x(e.language,this._connection,[this._variableOut],this.sessionContext.session.kernel)){const e=`Failed to transfer ${this._variableOut} from ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(w.ERROR,e),new Error(e)}}return this.setState(w.DONE),!0}throw this.setState(w.ERROR),new a.id(e.content)}async setupKernel(){if(!b.serviceManager){const e="No service manager available";throw this.setState(w.ERROR,e),new Error(e)}this.setState(w.STARTING_KERNEL),this._connection&&(this._connection.id===this._kernelSpec.id&&this._connection.name===this._kernelSpec.name&&(this._connection.location??"local")===runtimeDescription.location||this._connection.dispose(),this._connection.isDisposed&&(this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0));const e=!1!==this._kernelSpec.params?.notebook;switch(this._connection?.status){case"idle":case"busy":case"autorestarting":case"restarting":case"starting":break;default:{this._connection?.dispose(),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0;const t=(0,f.R)(this._kernelSpec.location)?b.serviceManager.remote?.kernels:b.serviceManager[this._kernelSpec.location]?.kernels;if(e&&this._kernelSpec.id)try{this._connection=t?.connectTo({model:{id:this._kernelSpec.id,name:this._kernelSpec.name},handleComms:!0})}catch(e){if(!e||"Unable to find the kernel."!==e.message)throw e;console.log(`Persistent kernel ${this._kernelSpec.id} does not exist. Starting a new one...`)}if(!this._connection)try{const{credits:n}=m.J7.getState(),{configuration:s,remoteKernels:o}=_.iP.getState(),i=(n?.available??0)/Math.max(s.maxCellKernels-o.filter((e=>"cell"===e.kernel_type)).length,1);if(i<p.c)throw new Error("You do not have enough credits to start a Cell Remote Runtime.");this._connection=await(t?.startNew({name:this._kernelSpec.name,runtimeType:e?"notebook":"cell",creditsLimit:i,capabilities:this._kernelSpec.params?.capabilities},{handleComms:!0}))}catch(t){if(503===t.response?.status)(0,s.f1)("Unable to create a new remote kernel",`No kernel available for environment '${this._kernelSpec.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please try again later.`);else if("MaxRuntimesExceededError"===t.name){if(!e){const e=new c.PromiseDelegate,t=window.setTimeout((()=>{e.reject("Timeout")}),3e5),n=_.iP.subscribe((t=>{t.remoteKernels.filter((e=>"cell"===e.kernel_type)).length<t.configuration.maxCellKernels&&e.resolve()}));try{return this.setState(w.STARTING_KERNEL,"Waiting for a cell kernel to stop…"),await e.promise,clearTimeout(t),this.setupKernel()}catch(e){console.log("Waiting for free kernel slot expired.")}finally{n()}}(0,s.f1)("Unable to create a new remote kernel",`${t.message} Cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}' cannot be executed.`)}else 404===t.response?.status&&(0,s.f1)("Unable to create a new remote kernel",`Unknown environment '${this._kernelSpec.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please select an existing environment.`);throw this.setState(w.ERROR,"string"==typeof t?t:t.message??"Unable to start a kernel"),t}this._connection&&(this._connection?.connectionStatusChanged.connect(this.onConnectionChanged,this),this._connection?.statusChanged.connect(this.onKernelStatusChanged,this),this._connection.location=this._kernelSpec.location,e&&(this._kernelSpec.id=this._connection.id,this.cell.model.setMetadata("datalayer",Object.assign(this.cell.model.getMetadata("datalayer")??{},{kernel:this._kernelSpec}))))}}if(!this._connection){const e=`Unable to start a kernel for cell ${this.cell.model.id} with ${JSON.stringify(this._kernelSpec)}`;throw this.setState(w.ERROR,e),new Error(e)}}async teardownKernel(){!1===this._kernelSpec.params?.notebook&&(this._connection&&!this._connection.isDisposed&&((0,f.R)(this._kernelSpec.location)?b.serviceManager.remote.kernels.shutdown(this._connection.id):this._connection.shutdown(),this._connection.dispose()),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0)}onConnectionChanged(){"disconnected"===this._connection?.connectionStatus&&this._processed?.reject("Kernel has been disconnected")}onKernelStatusChanged(){["dead","terminating"].includes(this._connection?.status??"")&&this._processed?.reject(`Kernel status '${this._connection?.status}' is not appropriate`)}}async function x(e,t,n,s){const o=new g.J(e),i=o.saveVariables(n),a=await new u.D({connection:t}).execute(i),l=a.get(0)?.data["text/plain"]??"";if(!l)return!1;{const e=o.loadVariables(l),t=await new u.D({connection:s}).execute(e),i=t.get(0)?.data["text/plain"]||"[]",a=JSON.parse(i.slice(1,i.length-1));if(!n.every((e=>a.includes(e))))return!1;console.debug(`Successfully transfered ${n.join(", ")}`)}return!0}!function(e){const t=a.Ft.executed,n=a.Ft.executionScheduled,i=a.Ft.selectionExecuted;async function d(e,d,m,_,g){const f=d[-1];e.mode="command";try{const v=await Promise.all(d.map((i=>async function(e,i,d,m,_){const g=await async function({notebook:e,cell:s,sessionContext:o}){if("code"!==s.model.type)return!1;const i={deletedCells:e.model?.deletedCells??[],recordTiming:e.notebookConfig.recordTiming},a=!!(s.model.getMetadata("datalayer")??{}).kernel,l=new(a?S:k)({cell:s,sessionContext:o,metadata:i});if(a){C.set(s.model,l);const e=()=>{C.delete(s.model),l.dispose()};s.disposed.connect(e),o?.disposed.connect(e)}return async function(e,s){const o=new c.PromiseDelegate;u.has(e)||u.set(e,[]);const i=u.get(e),a=0===i.length;return n.emit({notebook:e,cell:s.cell}),s.scheduleExecution(),i.push({cell:s,done:o}),a&&p(i).catch((e=>{console.error("Fail to start processing the cell queue",e)})),o.promise.then((()=>{t.emit({notebook:e,cell:s.cell,success:!0})})).catch((n=>{t.emit({notebook:e,cell:s.cell,success:!1,error:n})})),o.promise}(e,l)}({notebook:e,cell:i,sessionContext:d});if(g)return!0;const f=(_=_||l.wK).load("jupyterlab");switch(i.model.type){case"markdown":i.rendered=!0,i.inputHidden=!1,t.emit({notebook:e,cell:i,success:!0});break;case"code":if(d){if(d.isTerminating){await(0,s.ui)({title:f.__("Kernel Terminating"),body:f.__("The kernel for %1 appears to be terminating. You can not run any cell for now.",d.session?.path),buttons:[s.lG.okButton()]});break}if(d.pendingInput)return await(0,s.ui)({title:f.__("Cell not executed due to pending input"),body:f.__("The cell has not been executed to avoid kernel deadlock as there is another pending input! Submit your pending input and try again."),buttons:[s.lG.okButton()]}),!1;if(d.hasNoKernel&&await d.startKernel()&&m&&await m.selectKernel(d),d.hasNoKernel)return i.model.sharedModel.transact((()=>{i.model.clearExecution()})),!0;const l=e.model?.deletedCells??[];n.emit({notebook:e,cell:i});let c=!1;try{const t={deletedCells:l,recordTiming:e.notebookConfig.recordTiming};console.debug(`@datalayer/ui:runtimes: Processing normally cell ${i.model.id}`);const n=i.model.sharedModel.source;if((0,h.ZP)(i)){const e=i.model.getMetadata("datalayer").datasource,t=e.variant??"",s=e.database??"",o=e.outputBucket??"",a=e.destinationVar??"";i.model.sharedModel.setSource(`%%${t} ${s} ${o} ${a}\n\n${n}`),i.model.sharedModel.setMetadata("editable",!1)}const s=await o.Yr.execute(i,d,t).finally((()=>{(0,h.ZP)(i)&&(i.model.sharedModel.setSource(n),i.model.sharedModel.setMetadata("editable",!0))}))??void 0;l.splice(0,l.length),c=(()=>{if(i.isDisposed)return!1;if(!s)return!0;if("ok"===s.content.status){const t=s.content;return t.payload&&t.payload.length&&function(e,t,n){const s=e.payload?.filter((e=>"set_next_input"===e.source))[0];if(!s)return;const o=s.text;if(s.replace)return void n.model.sharedModel.setSource(o);const i=t.model.sharedModel,a=t.model.cells,l=(0,r.findIndex)(a,(e=>e===n.model));-1===l?i.insertCell(i.cells.length,{cell_type:"code",source:o,metadata:{trusted:!1}}):i.insertCell(l+1,{cell_type:"code",source:o,metadata:{trusted:!1}})}(t,e,i),!0}throw new a.id(s.content)})()}catch(n){if(!i.isDisposed&&!n.message.startsWith("Canceled"))throw t.emit({notebook:e,cell:i,success:!1,error:n}),n;c=!1}return c&&t.emit({notebook:e,cell:i,success:!0}),c}i.model.sharedModel.transact((()=>{i.model.clearExecution()}),!1)}return Promise.resolve(!0)}(e,i,m,_,g))));return!e.isDisposed&&(i.emit({notebook:e,lastCell:f}),e.update(),v.every((e=>e)))}catch(t){if(!t.message||!t.message.startsWith("KernelReplyNotOK"))throw t;return d.map((e=>{"code"===e.model.type&&null===e.model.executionCount&&e.setPrompt("")})),i.emit({notebook:e,lastCell:f}),e.update(),!1}}e.getState=function(e){return{wasFocused:e.node.contains(document.activeElement),activeCellId:e.activeCell?.model.id??null}},e.handleRunState=async function(e,t,n=!1){const{activeCell:s,activeCellIndex:o}=e;n&&s&&await e.scrollToItem(o,"smart",0).catch((e=>{})),(t.wasFocused||"edit"===e.mode)&&e.activate()},e.runCells=d,e.runSelected=function(e,t,n,s){e.mode="command";let o=e.activeCellIndex;const i=e.widgets.filter(((t,n)=>{const s=e.isSelectedOrActive(t);return s&&(o=n),s}));return e.activeCellIndex=o,e.deselectAll(),d(e,i,t,n,s)};const u=new WeakMap;async function p(e){const t=e[0];if(!t)return Promise.resolve();const{done:n,cell:s}=t;try{const t=await s.processCell();n.resolve(t),e.shift(),p(e).catch((e=>{console.error("Error processing cell queue")}))}catch(t){for(s.failedExecution(t.message),n.reject(t),s===e[0]?.cell&&e.shift();e.length;){const{done:t,cell:n}=e.shift()??{};n?.cancelExecution(),t?.reject("Canceled")}}}}(y||(y={}))}}]);