import{B as le}from"./BuilderSidebarPanel-BMJVzhd3.js";import{c as v,d as F,r as P,i as T,a as S,u as j,w as A,I as k,o as m,b as I,x as h,f as l,e as b,z as B,X as y,N as c,t as de,A as ue,ai as z,k as ce,an as me,_ as Q,W as V,y as $,s as pe}from"./index-ChWW_c_j.js";import{a as fe}from"./BuilderApp-0XXiQ2l7.js";import{u as ge}from"./useComponentDescription-FHKxu8gg.js";import"./marked.esm-273vDTCT.js";function W(s,r){function n(o){if(!r.value)return!0;const a=s.getComponentDefinition(o.type);return!!(a!=null&&a.name.toLocaleLowerCase().includes(r.value)||Object.values(o.content).filter(d=>d.toLocaleLowerCase().includes(r.value)).length>0)}return{isComponentMatchingQuery:n}}function ve(s,r,n){const{isComponentMatchingQuery:o}=W(s,r);return{searchResultCount:v(()=>{if(!r.value)return;let i=0;for(const d of s.getComponentsNested(n.value))o(d)&&i++;return i})}}function Ce(s,r,n){const{isComponentMatchingQuery:o}=W(s,r),a=v(()=>!r.value||o(n.value));return{hasMatchingChildren:v(()=>{if(!r.value)return!0;for(const d of s.getComponentsNested(n.value.id))if(o(d))return!0;return!1}),matched:a}}const he={class:"BuilderSidebarComponentTreeBranch__nameRight"},ye={class:"previewText"},be=F({__name:"BuilderSidebarComponentTreeBranch",props:{componentId:{type:String,required:!0},query:{type:String,required:!1,default:""}},emits:["expandBranch"],setup(s,{emit:r}){const n=s,o=P(),a=T(S.core),i=T(S.builderManager),d=P(!1),_=v(()=>i.isComponentIdSelected(n.componentId)),w=j(a),{createAndInsertComponent:D,moveComponent:f,goToComponentParentPage:g,isDraggingAllowed:x}=z(a,i,w),{getComponentInfoFromDrag:M,removeInsertionCandidacy:N,isParentSuitable:K}=me(a),{isComponentVisible:U}=ce(a),X=r,G=v(()=>{var t;return((t=n.query)==null?void 0:t.toLocaleLowerCase())??""}),u=v(()=>a.getComponentById(n.componentId)),L=new Set(["root","blueprints_root"]),H=new Set([...L,"page","blueprints_blueprint"]),{hasMatchingChildren:J,matched:Z}=Ce(a,G,u);A(J,t=>{var e;return(e=o.value)==null?void 0:e.toggleCollapse(!t)},{immediate:!0});const O=v(()=>a.getComponents(n.componentId,{sortedByPosition:!0})),{name:ee,previewText:R}=ge(a,u);async function te(t){g(n.componentId),await k(),i.handleSelectionFromEvent(t,n.componentId,void 0,"tree"),E()}function E(){o.value&&(o.value.expand(),d.value=!1,X("expandBranch"))}function ne(){var q;const t=(q=o.value)==null?void 0:q.$el;if(!t)return;const e=t.closest(".BuilderSidebarComponentTree"),p=e.getBoundingClientRect(),C=o.value.$el.offsetTop-p.height/2,ie=o.value.$el.offsetLeft-p.left-16;e.scrollTo({top:C,left:Math.max(0,ie),behavior:"smooth"})}function oe(t){i.setSelection(null),t.dataTransfer.setData(`application/json;writer=${u.value.type},${u.value.id}`,"{}")}function ae(t){N(t)}function re(t){const e=M(t);if(!e)return;const{draggedType:p,draggedId:C}=e;K(n.componentId,C,p)&&t.preventDefault()}function se(t){const e=M(t);if(!e)return;const{draggedType:p,draggedId:C}=e;C?f(C,u.value.id):D(p,u.value.id),N(t)}return A(i.firstSelectedItem,async t=>{t&&t.componentId===n.componentId&&t.source!="tree"&&(E(),await k(),ne())},{immediate:!0}),(t,e)=>(m(),I(fe,{ref_key:"treeBranch",ref:o,class:"BuilderSidebarComponentTreeBranch","component-id":s.componentId,name:c(ee),query:s.query,"has-children":O.value.length>0,"data-automation-key":u.value.type,draggable:c(x)(s.componentId),matched:c(Z),selected:_.value,variant:c(H).has(u.value.type)?"root":void 0,"no-nested-space":c(L).has(u.value.type),onSelect:te,onDragover:re,onDragstart:oe,onDragend:ae,onDrop:se},{nameRight:h(()=>[l("span",he,[Object.keys(u.value.handlers??{}).length>0?(m(),b(B,{key:0},[e[0]||(e[0]=l("span",{class:"middot"},null,-1)),e[1]||(e[1]=l("i",{class:"material-symbols-outlined"},"bolt",-1))],64)):y("",!0),c(U)(u.value.id)?y("",!0):(m(),b(B,{key:1},[e[2]||(e[2]=l("span",{class:"middot"},null,-1)),e[3]||(e[3]=l("i",{class:"material-symbols-outlined"},"visibility_off",-1))],64)),u.value.isCodeManaged?(m(),b(B,{key:2},[e[4]||(e[4]=l("span",{class:"middot"},null,-1)),e[5]||(e[5]=l("i",{class:"material-symbols-outlined"},"terminal",-1))],64)):y("",!0),c(R)?(m(),b(B,{key:3},[e[6]||(e[6]=l("span",{class:"middot"},null,-1)),l("span",ye,de(c(R)),1)],64)):y("",!0)])]),children:h(()=>[(m(!0),b(B,null,ue(O.value,p=>(m(),I(Y,{key:p.id,"component-id":p.id,query:s.query,onExpandBranch:E},null,8,["component-id","query"]))),128))]),_:1},8,["component-id","name","query","has-children","data-automation-key","draggable","matched","selected","variant","no-nested-space"]))}}),Y=Q(be,[["__scopeId","data-v-cefea884"]]),Be={class:"add"},Ie=F({__name:"BuilderSidebarComponentTree",setup(s){const r=T(S.core),n=T(S.builderManager),o=P(""),a=j(r),{createAndInsertComponent:i}=z(r,n,a),d=n.activeRootId,{searchResultCount:_}=ve(r,o,d);async function w(){const f=i("page","root");r.setActivePageId(f),await k(),n.setSelection(f),a.track("ui_page_added")}async function D(){const f=i("blueprints_blueprint","blueprints_root");r.setActivePageId(f),await k(),n.setSelection(f),a.track("blueprints_new_added")}return(f,g)=>(m(),I(le,{modelValue:o.value,"onUpdate:modelValue":g[0]||(g[0]=x=>o.value=x),class:"BuilderSidebarComponentTree",placeholder:"Component tree","search-count":c(_)},{footer:h(()=>[l("div",Be,[c(d)=="root"?(m(),I(V,{key:0,variant:"special",size:"small","data-automation-action":"add-page",onClick:w},{default:h(()=>g[1]||(g[1]=[l("i",{class:"material-symbols-outlined"}," add ",-1),$(" Add page")])),_:1})):y("",!0),c(d)=="blueprints_root"?(m(),I(V,{key:1,variant:"special",size:"small","data-automation-action":"add-blueprint",onClick:D},{default:h(()=>g[2]||(g[2]=[l("i",{class:"material-symbols-outlined"}," add ",-1),$(" Add blueprint")])),_:1})):y("",!0)])]),default:h(()=>[l("div",null,[pe(Y,{class:"rootBranch","component-id":c(d),query:o.value},null,8,["component-id","query"])])]),_:1},8,["modelValue","search-count"]))}}),De=Q(Ie,[["__scopeId","data-v-4a1fcc37"]]);export{De as default};
